<tw-storydata name="Fuzziolump" startnode="52" creator="Twine" creator-version="2.2.1" ifid="810AC854-AE1B-4BAB-8175-BAF552CB931B" zoom="1" format="SugarCube" format-version="2.21.0" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">/*
.passage {
	transition-property: none;
}
*/

#enemyCombatWindow {
	width: 100%;
	position: center;
	padding: 1em;
	border: solid #000 0.05em; 
	border-radius: 0.1em;
	background-color: #EBE;
	font-size:1.5rem; 
	color:#000;
	text-align:left; 
	box-shadow: #000 0.5em 0.5em 0;
    transition-property: none;
}

#playerCombatWindow {
	width: 100%;
	position: center;
	padding: 1em;
	border: solid #000 0.05em; 
	border-radius: 0.1em;
	background-color: #B0E0E6;
	font-size:1.5rem; 
	color:#000;
	text-align:left; 
	box-shadow: #000 0.5em 0.5em 0;
    transition-property: none;
}

#combatLog {
	width: 100%;
	position: center;
	padding: 2em;
	border: solid #000 0.05em; 
	border-radius: 0.1em;
	margin: auto;
	background-color: #ffffff;
	font-size:1.5rem; 
	color:#000;
	text-align:left; 
	box-shadow: #000 0.5em 0.5em 0;
    transition-property: none;
}







































































































</style><script role="script" id="twine-user-script" type="text/twine-javascript">Config.history.maxStates = 0;   // no history limit
//alert("config ctor: "+Config.constructor);
var known_id_nuvi = false;
var test = 0;

/** attempts to parse a given function's signature to determine expected params

ex.
function myCustomFn(arg1, arg2,arg3) {
  
}
console.log(getParams(myCustomFn)); // returns ["arg1", "arg2", "arg3"]
*/
State.variables.getParams = function(func) {
  // First match everything inside the function argument parens.
  var args = func.toString().match(/function\s.*?\(([^)]*)\)/)[1];
 
  // Split the arguments string into an array comma delimited.
  return args.split(',').map(function(arg) {
    // Ensure no inline comments are parsed and trim the whitespace.
    return arg.replace(/\/\*.*\*\//, '').trim();
  }).filter(function(arg) {
    // Ensure no undefined values are added.
    return arg;
  });
}

State.variables.addUniqueToArray = function(array,element){
	if(!array.includes(element)){
		array.push(element);	
	}
}

State.variables.addUniqueToArray = function(array,element,filterFn){
	if(!array.some(filterFn)){
		array.push(element);	
	}
}

/**
Applies the combat status effect to the given character, adding it to their list of statuses and triggering its effect fn
@param character the recipient of the effect
@param effect the status effect to apply
*/
State.variables.addUniqueStatusEffect = function(character,effect){
	var statuses = character.statusEffects;
	if(!statuses.some(effectUnderTest => effect.id === effectUnderTest.id)){
		statuses.push(effectUnderTest);
		effect.effect(character);
	}
}

/**
Applies the combat status effect to the given target character, adding it to their list of statuses and triggering its effect fn.
The source character is the one who inflicted the status; this function should be used when a status effect's effect depends on the inflicting character.
@param sourceCharacter the one who inflicted the status
@param targetCharacter the recipient of the effect
@param effect the status effect to apply
*/
State.variables.addUniqueStatusEffectWithSource = function(sourceCharacter, targetCharacter,effect){
	var statuses = targetCharacter.statusEffects;
	if(!statuses.some(effectUnderTest => effect.id === effectUnderTest.id)){
		statuses.push(effectUnderTest);
		effect.effect(sourceCharacter,targetCharacter);
	}
}

/**
Checks a given character for a given statyus effect
@param character the Character under test
@param effect the StatusEffect we're looking for
@return true if the status effect is found, false otherwise
*/
State.variables.hasStatusEffect = function(character,effect){
	var statuses = character.statusEffects;
	if(statuses.some(effectUnderTest => effect.id === effectUnderTest.id)){
		return true;
	}else{
		return false;	
	}
}

/**
Checks a given character for a given status effect and returns the discovered status effect instance
@param character the Character under test
@param effectId the ID of the StatusEffect we're looking for
@return the status effect instance if found, otherwise undefined
*/
State.variables.getStatusEffect = function(character,effectId){
	var statuses = character.statusEffects;
	return statuses.find(effectUnderTest => effectId === effectUnderTest.id);
}

// find index of a particular character id in a character array
State.variables.findCharacterIndex = function(characterArray,characterID){
	return characterArray.findIndex(function (character){
		return character.id === characterID;
	});	
}

/**
Removes a Character from an array of Characters using splice()
@parm character the Character to be removed from the array
@param characterArray the array of Characters
*/
State.variables.removeCharacterFromArray = function(character,characterArray){
	// find the index of the target character in the array
	var index = State.variables.findCharacterIndex(characterArray,character.id);
	// splice the character out of the array; this modified the given array
	characterArray.splice(index,1); 
}
/* // not very space friendly
State.variables.removeCharacterFromArray = function(character,characterArray){
	return characterArray.filter(characterUnderTest =>
		characterUnderTest.id != character.id
	);	
}
*/
																	
State.variables.findCurrentPlayerCharacterIndex = function(){
	return State.variables.combatArena.playerParty.findIndex(function (character){
		return character.id === State.variables.combatArena.turnOwner;
	});	
}

// simulate a d20 roll
State.variables.rollD20 = function(){
	return Math.floor(Math.random() * 20) + 1;
}

// simulate a dN roll, where N is given by sides param
State.variables.rollDie = function(sides){
	return Math.floor(Math.random() * sides) + 1;
}

// simulate a d% roll
State.variables.rollPercentage = function(){
	return Math.floor(Math.random() * 100) + 1;
}

// calculate the ability modifier per Pathfinder rules
State.variables.calcMod = function(characterObject,attributeString){
	return Math.floor((characterObject.attributes[attributeString]-10)/2);
}

// perform an ability score check
State.variables.checkAbility = function(characterObject, attributeString){
	return State.variables.rollD20() + State.variables.calcMod(characterObject,attributeString);	
}

State.variables.addToInductiveBias = function(inductiveBiasArray, args){
	for(var biasitem of args){
		if(!inductiveBiasArray.includes(biasitem)){
			inductiveBiasArray.push(biasitem);
		}
	}
}

State.variables.deleteTitle = function(title){
	var playerTitleArray = State.variables.characters["player"].titles;
	var titleIndex = playerTitleArray.indexOf(title);
	if(titleIndex > -1){
			// remove one element from the array, starting at the target index
			playerTitleArray.splice(titleIndex,1);
	}
}

State.variables.addTitle = function(title){
	var playerTitleArray = State.variables.characters["player"].titles;
	if(!playerTitleArray.includes(title)){
			playerTitleArray.push(title);
	}
}

/// begin main quest vars ///
// wipe out the godlings and anybody nearby
State.variables.godling_strat_viral_violence = "viral_violence";
// disrupt the godlings' godlingness in the hopes this might check them or even restore them to their former selves
State.variables.godling_strat_surgical_system = "surgical_system";
// friendship for everyone!  Trying to use Incarnation to get through to each godling
State.variables.godling_strat_diplomancy = "diplomancy";
State.variables.godling_strat_chosen = "";
/// end main quest vars ///

State.variables.removeStatusEffect = function(character,effect){
		var effectIndex = character.statusEffects.findIndex(function(element){
			return element.id === effect.id;
		});
		character.statusEffects.splice(effectIndex,1);
}

State.variables.StatusEffect = function StatusEffect(id,name,duration){
	this.id = id;
	this.name = name;
	/** 
	boon or bane would have made more sense, but I was tired and now I like buffins/bluffins.  Anyway, this property identifies a StatusEffect as positive or negative for the afflicted Character where buffins is good and bluffins is bad.  Fight me codereview SE.
	*/
	this.buffity = "buffins";
	this.duration = duration;
	this.ticks = duration;
	this.tickDown = function(){
		this.ticks--;	
	}
	this.effect = function(afflictedChar){
		console.log("status effect unset");	
	}
	this.reverseEffect = function(afflictedChar){
		console.log("status effect reversal unset");	
	}
}

State.variables.Ability = function Ability(name){
	this.TargetTypesEnum = Object.freeze (
		{ 
			singleEnemy: 1, 
			allEnemies: 2,
			singleAlly: 3,
			allAllies: 4
		});
	
	this.name = name;
	
	// metadata about who the ability targets, namely you, all allies, one enemy, or all enemies.
	this.targetType = this.TargetTypesEnum.singleEnemy; 
	
	/**
	The friendly property describes whether an ability is considered hostile or beneficial to its target
	*/
	this.friendly = false;
	
	// cached value of last calculated dmg
	this.dmg = 0;
	
	// effect can be defined when Ability instance is defined, but usual behavior will generally be target character's HP reduced by calcDmg().  Default behavior will be to simply log a noop like the other default functions
	this.effect = function(sourceChar,targetChar){console.log("no effect from "+this.name)};
	this.calcDC = function(user,modifyingAttr){
		if(user.level && modifyingAttr){
			return user.level/2 + State.variables.calcMod(user,modifyingAttr) + 10;
		}else{
			return 10;	
		}
	}// end calcDC()
	// lambda stub - dmg formula will be defined when Ability instance is defined
	this.calcDmg = function(sourceChar,targetChar){console.log("no dmg from "+this.name)}
	this.generateFlavorText = function(sourceChar,targetChar){console.log("flavor text undefined for "+this.name)}
	
} // end Ability def

State.variables.Incarnation = function Incarnation(name){
	// Incarnation inherits from Ability
	State.variables.Ability.call(this,name);
	
}
function Entity(name){
	this.name = name;
	
	/**
	An array of strings representing domains of thought, emotion, imagination, and creativity associated with this Entity.  e.g. Foxfire entity associated with ["whimsy","illusion","seduction","manipulation","domination"]
	*/
	this.associatedDomains = [];
	
	/**
	A multi-dimensional array of Incarnations learned by wielders of this Entity at a level equivalent to the index of the Incarnation array.
	e.g. [[fire blast, ice blast],[],[rock tomb]] would indicate the wielder leanrs fire blast and ice blast at level 1, and rock tomb at level 3.
	*/
	this.associatedIncarnationsByLevel = [];
}

// Character object definition
State.variables.Character = function Character(id,name){
	this.CombatFlags = Object.freeze (
		{ 
			FLAG_SKIP_TURN: 1,
			FLAG_WONDER_WALLED: 2
		});
	this.id = id;
	this.name = name;
	this.gender = "";
	this.level = 10;
	
	this.getPronoun_gen = function(){
		if(this.gender==="female")
			return "her";
		else if(this.gender==="male")
			return "his";
		else
			return "their";
	}
	this.getPronoun_nom = function(){
		if(this.gender==="female")
			return "she";
		else if(this.gender==="male")
			return "he";
		else
			return "they";	
	}
	
	// simple object map of categorical descriptor arrays,
	// e.g. descriptors.body = ["fur","curvacious"]
	this.descriptors = {
		body : {
		 appendages : []	
		}
	}
	
	// attribute scores reflect the character's capabilities.
	// we'll use Pathfinder style scores, where 10 is sort of neutral
	// and any modifier needed is calculated as (score-10)/2
	this.attributes = {
		"charisma":10,
		"intelligence":10,
		"wisdom":10,
		"strength":10,
		"dexterity":10,
		"constitution":10
	}
	
	// just like Pathfinder saving throws, these represent a character's
	// defenses against various effects
	this.saves = {
		"fortitude" : 5,
		"reflex" : 5,
		"will" : 5
	}
	
	this.ac = {
		"armored" : 10,
		"touch" : 10
	}
	
	// basic stats, representing character vitality as resources.
	// In the absence of clear classes, went with ~ avg d10s for level 10
	// TODO: at least some of these and other consumeable resources should show in a HUD drawer
	this.stats = {
		"hp":50,
		"maxHP":50,
		"mp":50,
		"maxMP":50,
		// standard jRPG stuff; I'm thinking these will be used as modifiers in dmg formulae, and will be modified by inherent attributes plus equipment
		"atk":this.attributes["strength"],
		"def":this.attributes["constitution"],
		"pwr":this.getMagicAttributeScore(),
		"res":this.getMagicAttributeScore()
	}
	
	this.getMagicAttributeScore = function(){
		if(this.attributes["charisma"] >= this.attributes["intelligence"]){
			return this.attributes["charisma"];	
		}else{
			return this.attributes["intelligence"];	
		}
	}
	
	// a character's incarnations is an object-map of 'magic' ability names to Incarnation objects that define their effects/cost etc. The available incarnations are based
	// on inherent Entity, or that have been learned by the human
	this.incarnations = {};
	
	// a character's Entity is their inherent set of talents re: Incarnation.  Only the human can learn Incarnations from any Entity.
	this.entity = new Entity("unset");
	
	this.abilities = {
		"attack" : new State.variables.Ability("Attack"),
		"defend" : new State.variables.Ability("Defend"),
		"run" : new State.variables.Ability("Run") 
	}
	this.abilities["attack"].calcDmg = function(sourceCharacter,targetCharacter){
		// favor the STR since the attacker is the leading participant
		// todo: yeesh, balance.  I've mixed inspiration from D&D and jRPGs in the stat blocks, and it's starting to shoooow.  Well anyway, CON is a fair stand-in for a DQ style DEF stat.
		// todo: atk is essentially useless against Puck b/c he has 500 HP and will be taking 5 damage from someone with average STR simply because his CON is average.  Recall that our STR etc. atrributes are based on D&D numbers, and D&D does NOT use same for determining base damage (only modifier).  Base damage D&D-style is a whole other thing I don't wanna get into for this demo.  For demo porpoises, I'd say fudge factors of 2 for STR and 0.25 for CON should be okay.  That way we're looking at 17-ish damage to Puck and 13-ish from him. 
		/*
		return sourceCharacter.attributes["strength"]*2 - targetCharacter.attributes["constitution"]/4;
		*/
		return sourceCharacter.stats["atk"]*2 - targetCharacter.stats["def"]/4;
	};
	this.abilities["attack"].effect = function(sourceCharacter,targetCharacter){
		this.dmg = this.calcDmg(sourceCharacter,targetCharacter);
		// todo: AC? Any other miss chance?
		targetCharacter.hp -= this.dmg; // what's multithreading, anyway? lol
	};
	this.abilities["attack"].generateFlavorText = function(sourceCharacter,targetCharacter){
		// todo: clearing cached dmg after it is read to flavor text? 
			return sourceCharacter+" strikes "+targetCharacter+" a mighty blow, dealing "+this.dmg+" damages!";
	};
	this.abilities["defend"].effect = function(sourceCharacter,targetCharacter){
		/*
		TODO: obviously this is borken af, but since Defend is traditionally useless and this is a demo, I like the irony of making it an OP move.  A better impl would be a status buff like Defended or similar that can only be added once instead of stacking endlessly.
		*/
		targetCharacter.stats["def"] += sourceCharacter.stats["def"];
	};
	this.abilities["run"].targetType = this.abilities["run"].TargetTypesEnum.allAllies;
	this.abilities["run"].generateFlavorText = function(playerParty){
		console.log("run::generateFlavorText -- The player party consists of "+playerParty);
		var flavorText = "";
		for(let i=0;i<playerParty.length;i++){
			if(i<playerParty.length-1){
				flavorText += playerParty[i].name+", ";
			}else{
				flavorText += "and "+playerParty[i].name;
			}
		}
		return flavorText+" bravely attempt to turn tail and flee, but they cannot escape!";
	};
	
	// affinities will be a simple String character name key -> integer affinity value mapping
	// that reflects how a given character feels about this character.
	// 0 is defined as totally neutral, negative values are bad and
	// positive values are good.  
	this.affinities = new Map();
	
	// a character's inventory reflects the items in the world that it is
	// currently carrying and can access.
	this.inventory = [];
	
	// a character's equipment represents weapons, armor, etc. that they are actively wearing
	this.equipment = [];
	
	// combat status effects; these are temporary and only relevant to combat
	this.statusEffects = [];
	
	/**
	Boolean flag indicating whether or not the character is alive for the purposes of combat
	*/
	this.living = true;
	
	// arbitrary PoT bitfield used to raise/lower various combat-related flags for this Character
	this.combatFlags = 0;
	
	// a simple array of keyword/phrases that indicate behavior mod in certain contexts, e.g. targetCharacter.name+"_is_digger_good"
	// to indicate that targetCharacter is as good as mole, wombats, and
	// other simple lovely creatures that happily burrow and build all their
	// lives, peaceful, passionate, and productive.
	this.inductive_bias = [];
	
	this.updateAffinity = function(characterObject,modifier){
		if(this.affinities.has(characterObject)){
this.affinities.set(characterObject,this.affinities.get(characterObject)+modifier);	
		}
		else{
			this.affinities.set(characterObject,modifier);
		}
	}
	
	/**
	Makes the character act autonomously according to its role
	@param combat: the current combat context
	@param role: could be as simple as player or enemy, but could be configurable to something like player:assist if a guided auto-battle system gets implemented someday
	*/
	this.runAI = function(combat,role){
			console.log("AI behavior unset");
	}
}

// Player object definition
function Player(){
	// inherit from Character
	State.variables.Character.call(this,"player","The Human");
	
	// the player can remain in full cold for 25 room moves
	// before becoming hypothermic
	this.cold_max_count = 25;
	
	// the count of turns a player has been out in the cold
	this.cold_count = 0;
	
	// human dies of hypothermia
	this.afflication_hypothermia = "hypothermia";
	
	// an array of string status ailments the player might have
	this.afflictions = [];
	
	// an array of string titles the player may obtain for outstanding deeds
	this.titles = [];
	
	
}


/**
Combat object takes two arrays of Character objects, the player's
party and the enemy's party.
@param playerParty: an array of Characters representing the player's party
@param enemyParty: an array of Characters representing the enemy's party
@param destPassageName: the name of the passage to which the player should be sent if they survive
*/
State.variables.Combat = function Combat(playerParty,enemyParty,destPassageName){
	this.PlayerTurnState = Object.freeze (
		{ 
			selectTarget: 1, 
			selectAbility: 2,
			displayResults: 3
		});
	this.EnemyTurnState = Object.freeze (
		{ 
			runAI: 1, 
			displayResults: 2
		});
	this.CombatResultEnum = Object.freeze (
		{ 
			pending: 0,
			playerVictory: 1, 
			enemyVictory: 2
		});
	
	// metadata about what state the player's turn is in.  This is necessary to help route the UI around the various actions a human player will need to input
	this.playerTurnState = this.PlayerTurnState.selectAbility;
	this.enemyTurnState = this.EnemyTurnState.runAI;
	this.playerParty = playerParty;
	this.enemyParty = enemyParty;
	this.destPassageName = destPassageName;
	this.combatResult = this.CombatResultEnum.pending;
	
	// tracks the currently selected player ability
	this.currentSelectedAbility = new State.variables.Ability("unset");
	
	// tracks the turn as either player or enemy group
	this.turnGroup = "player";
	
	// tracks the actual character id whose turn it is
	this.turnOwner = "player";
	
	// tracks the currently selected ability for the current turn owner
	this.abilityName = "";
	
	// tracks the target of the current ability
	this.currentTargetCharacter = new State.variables.Character("unset");
	
	// the text feedback to the user re: the state of combat
	this.combatLogContent = "Kombat Time!";
	
	this.randoCombatantExcept = function(exceptCharacter){
		var combatants = this.enemyParty.concat(this.playerParty);
		var eligibleCombatants = this.combatants.filter(combatant => combatant.id != exceptCharacter.id);
		var unluckyIndex = Math.floor(Math.random() * eligibleCombatants.length);
		return eligibleCombatants[unluckyIndex];
		
	}
	
	/**
	Handle upkeep related to a new round beginning (i.e. top of the round to ye!)
	*/
	this.processRoundTop = function(){
	// tick down status effects
	for(let enemyChar of this.enemyParty){
			for(let effect of enemyChar.statusEffects){
				// process top of stateffects with variable or triggered effects per round
				if(effect.id === "terror"){
					// terror's effect will roll percentage, with 35% to skip this turn
					if(effect.effect()){
						enemyChar.combatFlags |= enemyChar.CombatFlags.FLAG_SKIP_TURN;	
					}
				}
				else if(effect.id === "poison"){
					enemyChar.stats["hp"] -= enemyChar.stats["maxHP"]*0.1; 	
				}
				else if(effect.id === "regen"){
					State.variables.statusEffectsDict["regen"].effect(enemyChar);	
				}
				
				
				effect.tickDown();
				if(effect.ticks <= 0){
					// reverse the effect now that it is over
					effect.reverseEffect(enemyChar);	
					// reset the ticks count to duration in case we
					// want to re-use this statuseffect instance
					effect.ticks = effect.duration;
					// remove the status effect from the character
					State.variables.removeStatusEffect(enemyChar,effect);
				}
			}
	}
	for(let playerChar of this.playerParty){
			for(let effect of playerChar.statusEffects){
				// process top of stateffects with variable effects per round
				if(effect.id === "terror"){
					// terror's effect will roll percentage, with 35% to skip this turn
					if(effect.effect()){
						playerChar.combatFlags |= playerChar.CombatFlags.FLAG_SKIP_TURN;	
					}
				}
				else if(effect.id === "regen"){
					State.variables.statusEffectsDict["regen"].effect(playerChar);	
				}
				
				effect.tickDown();
				if(effect.ticks <= 0){
					// reverse the effect now that it is over
					effect.reverseEffect(playerChar);	
					// reset the ticks count to duration in case we
					// want to re-use this statuseffect instance
					effect.ticks = effect.duration;
					// remove the status effect from the character
					State.variables.removeStatusEffect(playerChar,effect);
				}
			}
	}
 }// end processRoundTop fn
	
	/**
	Process the bottom of a combat round.  
	*/
	this.processRoundBottom = function(){
		var dedEnemies = 0;
		var dedPlayers = 0;
		for(let enemyChar of this.enemyParty){
			for(let effect of enemyChar.statusEffects){
				// process bottom of stateffects with variable effects per round
				if(effect.id === "terror"){
					// clear the FLAG_SKIP_TURN flag
		enemyChar.combatFlags &= ~enemyChar.CombatFlags.FLAG_SKIP_TURN;
				}
			}
			
			// check for death
			if(enemyChar.stats.hp <= 0){
				dedEnemies++;	
			}
		}
		for(let playerChar of this.playerParty){
			for(let effect of playerChar.statusEffects){
				// process bottom of stateffects with variable effects per round
				if(effect.id === "terror"){
					// clear the FLAG_SKIP_TURN flag
		playerChar.combatFlags &= ~playerChar.CombatFlags.FLAG_SKIP_TURN;
				}
			}
			
			// check for death
			if(playerChar.stats.hp <= 0){
				dedPlayers++;	
			}
		}
		
		// check victory conditions -- if one is met, we do not need another turn so return false.  Else, combat continues so we return true.
		// todo: need a way to clear conditions and/or reset stats as desired at end of combat
		if(dedEnemies >= this.enemyParty.length){
			this.combatResult = this.CombatResultEnum.playerVictory;
			return false;	
		}else if(dedPlayers >= this.playerParty.length){
			this.combatResult = this.CombatResultEnum.enemyVictory;
			return false;	
		}else{
			return true;	
		}
		
	}// end processRoundBottom()
}// end Combat

State.variables.combatArena = new State.variables.Combat([],[]);

function Room(){
	
	// array of field mods that have occurred in this room
	this.field_mods = [];
	
}

/*//moved into Character object, of which Player is an instance
function Affinities(){
	this.nuvi_affinity = 0;
}

var playerAffinities = new Affinities();
*/

/**
An Item is an object that the player can use and/or equip
*/
State.variables.Item = function Item(id,name){
	this.id = id;
	this.name = name;
	this.useEffect = function(){console.log("Using the "+this.name+" accomplishes little, but you do look silly.");}
	// todo: instead of having a simple one-way equip effect, we need something more structured that can be queried later, e.g. in stat recompute fn (where we want to recompute atk as STR + weapon modifier).  Something that has properties tracking the modifications to attrs or stats.
	this.equipEffect = function(){console.log("You equip the "+this.name+" and now boast an eccentric stylish look.");}
	this.description = this.name+" is uncannily nondescript -- you've already forgotten its details and you're still looking at it!";
	// todo: some sort of on-hit effect for weapons?
}

/// begin global story state dicts ///

// Global Object mapping of prefab Characters
State.variables.characters = {
	"player" : new Player(),
	"nuvi" : new State.variables.Character("nuvi","Nuvi"),
	"shimmerin" : new State.variables.Character("shimmerin","Shimmerin"),
	"sheila" : new State.variables.Character("sheila","Sheila"),
	"council" : new State.variables.Character("council","Council Of Animals"),
	"marrah" : new State.variables.Character("marrah","Marrah"),
	"drbeakmen" : new State.variables.Character("drbeakman","Dr. Beakman"),
	"mooty" : new State.variables.Character("mooty","Mooty Wort"),
	"puck" : new State.variables.Character("puck","Puck")
}

// Global Object mapping of prefab StatusEffects
State.variables.statusEffectsDict = {
	/**
	Bloodlust raises STR at the expense of all mental attributes
	*/
	"bloodlust" : new State.variables.StatusEffect("bloodlust","Bloodlust",3),
	/**
	Doubt halves all confidence based attributes (STR and CHA)
	*/
	"doubt" : new State.variables.StatusEffect("doubt","Doubt",3),
	/**
	Terror gives a 35% chance to do nothing but shiver in fear
	*/
	"terror" : new State.variables.StatusEffect("terror","Terror",5),
	/**
	Poison inflicts 5% health dmg each turn, and helaves atk/def
	*/
	"poison" : new State.variables.StatusEffect("poison","Poison",3),
	/**
	Shadow makes the affected character immune to physical dmg
	*/
	"shadow" : new State.variables.StatusEffect("shadow","Shadow",3),
	/**
	Regen heals each turn
	*/
	"regen" : new State.variables.StatusEffect("regen","Regen",3),
	/**
	Confuse causes the AI to 50% redirct its chosen abl at itself
	*/
	"confuse" : new State.variables.StatusEffect("confuse","Confusion",3),
	/**
	Charm causes the afflicted character to be unable to target the character who charmed them with harmful abilities
	*/
	"charm" : new State.variables.StatusEffect("charm","Charm",3)
}

/* // room objects might be overkill since they'll be pretty different, and it really starts to fight with Twine rather than leveraging it
State.variables.rooms = {
	"Shimmerin_Chase_Ghostly_Greeting_Chamber" : new Room(...) 	// defined here?  With all details or boilerplate that's modified later?
}
*/

/* // is this delegate inheritance?  MDN suggests that delegation proto inheritance can allow state to creep between instances somehow with common fields being changed for all instances, but I don't understand what they mean.  This works as expected.
var characters = State.variables.characters;
alert("player is "+characters["player"].name+", nuvi is "+characters["nuvi"].name+", and shimmerin is "+characters["shimmerin"].name);
*/

/**
Global dictionary object of public incarnations.  Since The Human can learn any Incarnation, all the Incarnations should be indexed here
TODO: move the inline definitions of Incarnations from within Character configs to here, and then reference this dict in said configs.
*/
State.variables.incarnationsDict = {
	// from Splinter of Serpentarius
	"debilitate" : new State.variables.Incarnation("debilitate","Debilitate"),
	"pierce" : new State.variables.Incarnation("pierce","Pierce"),
	"toxin" : new State.variables.Incarnation("toxin","Toxin"),
	// from Splinter of Violet
	"shadowform" : new State.variables.Incarnation("shadowform","Shadowform"),
	"perfect_stillness" : new State.variables.Incarnation("perfect_stillness","Perfect Stillness"),
	"savage_sympathy" : new State.variables.Incarnation("savage_sympathy","Savage Sympathy"),
	// from Splinter of Snugg-lor
	"warmest_hug" : new State.variables.Incarnation("warmest_hug","Warmest Hug"),
	"woolly_shield" : new State.variables.Incarnation("woolly_shield","Woolly Shield"),
	"maenad_frenzy" : new State.variables.Incarnation("maenad_frenzy","Maenad Frenzy"),
}

State.variables.itemsDict = {
	"wicked_axe" : new State.variables.Item("wicked_axe","Wickedly Curved Axe"),
	"cold_mace" : new State.variables.Item("cold_mace","Inexplicably Cold Mace"),
	"sawtooth_star_dagger" : new State.variables.Item("sawtooth_star_dagger","Starlight Sawtooth Dagger")
}

/// end global story state dicts ///
	
// establish Player party
State.variables.party = [State.variables.characters["player"]];

/*// moved to Character object, from which Player inherits 
// establish Player inventory
State.variables.inventory = [];
*/

// inductive biases characters may have toward the Player

// fuzzy biases
State.variables.inductive_bias_digger_good = "digger_good";
State.variables.inductive_bias_clever = "clever";
State.variables.inductive_bias_animal_handler = "animal_handler";
State.variables.inductive_bias_crush = "crush";

// unfortunate biases
State.variables.inductive_bias_liar = "liar";
State.variables.inductive_bias_manipulative = "manipulative";
State.variables.inductive_bias_lacks_confidence = "lacks_confidence";
State.variables.inductive_bias_humble = "humble";
State.variables.inductive_bias_knows_limitations = "knows_limitations";

// titles the player can have
State.variables.title_wombuddy = "wombuddy";

/// begin Shimmerin acq///
State.variables.field_mod_anicemole_burrowed = "anicemole_burrowed";

function AnIceMole(){
	this.path_index = 0;
	// the path an ice mole can take
	this.ice_mole_path = ["Shimmerin_Chase_Frozen_Stair","Shimmerin_Chase_Diamond_Throneroom","Shimmerin_Chase_Treasure_Of_Stillness","Shimmerin_Chase_Crystal_Gardens"];
	// the ice mole's current position
	this.ice_mole_room = this.ice_mole_path[this.path_index];
	
	/**
	Advances anicemole along his path
	*/
	this.advance = function(){
			// advance the path index, accounting for wraparound
		  this.path_index++;
			if(this.path_index == this.ice_mole_path.length){
				this.path_index = 0;
			}
			
			// set the current room to the room along the path
			// at the new index
			this.ice_mole_room = this.ice_mole_path[this.path_index];
		  alert("path index is "+this.path_index+", which resolves to "+this.ice_mole_path[this.path_index]);
	} // end advance function
	/**
	Retreats anicemole along his path
	*/
	this.retreat = function(){
			// retreat the path index, accounting for wraparound
		  this.path_index--;
			if(this.path_index == -1){
				this.path_index = this.ice_mole_path.length-1;
			}
			
			// set the current room to the room along the path
			// at the new index
			this.ice_mole_room = this.ice_mole_path[this.path_index];
		  alert("path index is "+this.path_index+", which resolves to "+this.ice_mole_path[this.path_index]);
	} // end retreat function
	
	/**
	Anicemole burrows hastily away!  This will modify the current room and also advance the mole.
	*/
	this.burrow = function(){
		// add the current passage to list of rooms the mole has burrowed through.  This isn't quite ideal since not all passages are a discrete room, but in the case of the shimmerin maze where the mole will be, they are.  Better might be to check the passage tags for 'room' before making this mod?  Of course, the mole shouldn't be burrowing outside a room passage anyway, so...
		//State.variables.mole_burrowed_array.push(passage());
		
		// add anicmole burrowed to the mods array for the current room
		var currentModsArray = State.variables.field_mods_map.get(passage());
		
		// need to check for null return of field mods at given passage and init currentModsArray to an empty new array in that case
		if (typeof currentModsArray == 'undefined'){
			currentModsArray = [State.variables.field_mod_anicemole_burrowed];
			State.variables.field_mods_map.set(passage(),currentModsArray);	
		}else if(!currentModsArray.includes(State.variables.field_mod_anicemole_burrowed)){

						 // field mods exist for this passage, but they do not yet include anicemole's burrowing.  Add burrowing to it.
						 currentModsArray.push(State.variables.field_mod_anicemole_burrowed);
		
	 }
		
		
		this.advance();
	}
	
	// flag indicating that the ice mole is present in the room when the player enters and there needs to be text detailing how he burrows away
	//this.ice_mole_burrow_flag = false;
}

// grant access to anicemole instance in the story
State.variables.anicemole = new AnIceMole();

/// end Shimmerin acq ///

/// begin wombat test quest ///

// number of times the player has attempted the wombats' wombuddy test 
State.variables.wombuddy_trials = 0;
State.variables.wombuddy_score = 0;

/// end wombat test quest ///

/**
A map of room names to arrays of modification descriptor strings that can be used to look up rooms that have runtime modification, e.g. anicemole burrowed and changed something in rooms x, y, and z so if room z checks this map's return value array for 'anicemole_burrowed' it will return true and know that burrowing mods need to be handled.  Interested rooms can check at the top of their passage with field_mods_map.get(passage())
*/
State.variables.field_mods_map = new Map();

// todo: at the top of every room in the shimmerin maze, the mole will move his position to the room at the next index in his path.  If the mole position matches the current passage title, the mole description will be part of the passage and the mole will burrow to escape the player.  The burrow flag will be raised, indicating that at the top of the next passage we do not need to auto-move the mole again.  Once the burrow flag is read as true, it will be lowered.  If the mole burrows away in the Treasure of Stillness room, the Tiny Tiara will be freed for acq.

/// end Shimmerin ///

/*
Config.constructor.prototype.combat = function Combat(){
	this.name = "";
	this.actors = {};
	this.getName = function(){
		return this.name;	
	}
}
*/

/**
Main program init function.  Configures and fleshes out global objects
*/
function init(){
	
	// todo: Incarnations need to have an MP cost!
	
	//items
	
	var wickedlyCurvedAxe = State.variables.itemsDict["wicked_axe"];
	wickedlyCurvedAxe.equipEffect = function(targetChar){
		targetChar.stats["atk"] += 20;
	}	
	wickedlyCurvedAxe.description = "This axe is a solid piece of metal as black as the darkest corner of the abyss, so sharp that light itself appears to silently die upon its edge.  The Lumpkins have a prohecy that 'a shard of shadow will split the fundaments of the world and bring all that they love crashing down upon them'... it's probably nothing.";
	// todo: bleed status effect on-hit?
	var coldMace = State.variables.itemsDict["cold_mace"];
	coldMace.equipEffect = function(targetChar){
		targetChar.stats["atk"] += 5;
		targetChar.attributes["charisma"] -= 10;
		targetChar.attributes["intelligence"] += 10;
		// todo: recompute the pwr/res based on new mental stats
		targetChar.stats.mp += 10;
	}
	coldMace.description = "The very chill that grips the heart of a snowstorm flashes through you as you gingerly touch the haft of this hefty mace.  You feel your concern for other living things dull notably, as an insidiously gentle numbness flows through your soul; in a moment, everything is a simple equation as clear and coldly beautiful as the corpse of a flower entombed within ice.  Your breath mists despite the temperate weather.";
	var sawtoothDagger = State.variables.itemsDict["sawtooth_star_dagger"];
	sawtoothDagger.equipEffect = function(targetChar){
		targetChar.stats["atk"] = 0;
		targetChar.attributes["charisma"] += 10;
		targetChar.attributes["intelligence"] += 10;
		targetChar.attributes["wisdom"] += 10;
		// todo: recompute the pwr/res based on new mental stats
		targetChar.stats.mp += 20;
	}
	sawtoothDagger.description = "Starlight glitters from within this jagged dagger, as if it is a little fragment of a fallen star.  Darkness practically flees from its surface, and in the instant before light fills the void you think you catch a glimpse of something staring back at you from the other side of an unfathomable gulf... and winking.";
	
	// status effects
	/**
	Defenseless halves a character's defensive attributes 
	*/
	// todo: I keep wanting to do mag def and phys def etc. stat changes -- add jRPG standard stats which are informed by D&D attributes, maybe?
	var defenselessStatusEffect = State.variables.statusEffectsDict["defenseless"];
	defenselessStatusEffect.effect = function(targetChar){
		targetChar.stats["def"] *= 0.5;
		targetChar.stats["res"] *= 0.5;
	}
	defenselessStatusEffect.reverseEffect = function(targetChar){
		// todo: this should get a recompute call that sources attrs and equipment rather than doing a direct reversal like this; otherwise defenseless + any defense buff + ~defenseless -> gt intended buff increase to defenses
		targetChar.stats["def"] *= 2;
		targetChar.stats["res"] *= 2;
	}
	
	/**
	Temper provides a simple ATK*2 for 3 turns
	*/
	var temperStatusEffect = State.variables.statusEffectsDict["temper"];
	temperStatusEffect.effect = function(targetChar){
		targetChar.stats["atk"] *= 2;
	}
	temperStatusEffect.reverseEffect = function(targetChar){
		targetChar.stats["atk"] *= 0.5;
	}
	
	/**
	Focus provides a simple PWR*2 for 3 turns
	*/
	var focusStatusEffect = State.variables.statusEffectsDict["focus"];
	focusStatusEffect.effect = function(targetChar){
		targetChar.stats["pwr"] *= 2;
	}
	focusStatusEffect.reverseEffect = function(targetChar){
		targetChar.stats["pwr"] *= 0.5;
	}
	
	/**
	Third Eye provides a PWR*4 at cost of ATK/2 and DEF/2 for 3 turns
	*/
	var thirdEyeStatusEffect = State.variables.statusEffectsDict["third_eye"];
	thirdEyeStatusEffect.effect = function(targetChar){
		targetChar.stats["pwr"] *= 4;
		targetChar.stats["atk"] *= 0.5;
		targetChar.stats["def"] *= 0.5;
	}
	thirdEyeStatusEffect.reverseEffect = function(targetChar){
		targetChar.stats["pwr"] *= 0.25;
		targetChar.stats["atk"] *= 2;
		targetChar.stats["def"] *= 2;
	}
	
	/**
	Regen heals a character by their RES each turn
	*/
	var regenStatusEffect = State.variables.statusEffectsDict["regen"];
	regenStatusEffect.effect = function(targetChar){
		targetChar.stats["hp"] += targetChar.stats["res"];
	}
	regenStatusEffect.reverseEffect = function(targetChar){}
	
	/**
	Doubt halves a character's attributes that are driven by presence and self-confidence: STR and CHA.
	*/
	var doubtStatusEffect = State.variables.statusEffectsDict["doubt"];
	doubtStatusEffect.effect = function(targetChar){
		/*
		targetChar.attributes["strength"] *= 0.5;
		targetChar.attributes["charisma"] *= 0.5;
		*/
		targetChar.stats["atk"] *= 0.5;
		targetChar.stats["pwr"] *= 0.5;
	}
	doubtStatusEffect.reverseEffect = function(targetChar){
		/*
		targetChar.attributes["strength"] *= 2;
		targetChar.attributes["charisma"] *= 2;
		*/
		targetChar.stats["atk"] *= 2;
		targetChar.stats["pwr"] *= 2;
	}
	
	/**
	Bloodlust quadruples STR in exchange for halving all mental attributes
	*/
	var bloodlustStatusEffect = State.variables.statusEffectsDict["bloodlust"];
	bloodlustStatusEffect.effect = function(targetChar){
		/*
		targetChar.attributes["strength"] *= 4;
		targetChar.attributes["charisma"] *= 0.5;
		targetChar.attributes["intelligence"] *= 0.5;
		targetChar.attributes["wisdom"] *= 0.5;
		*/
		targetChar.stats["atk"] *= 4;
		targetChar.stats["pwr"] *= 0.5;
		targetChar.stats["res"] *= 0.5;
	}
	bloodlustStatusEffect.reverseEffect = function(targetChar){
		/*
		targetChar.attributes["strength"] *= 0.25;
		targetChar.attributes["charisma"] *= 2;
		targetChar.attributes["intelligence"] *= 2;
		targetChar.attributes["wisdom"] *= 2;
		*/
		targetChar.stats["atk"] *= 0.25;
		targetChar.stats["pwr"] *= 2;
		targetChar.stats["res"] *= 2;
		
		
	}
	
	var terrorStatusEffect = State.variables.statusEffectsDict["terror"];
	terrorStatusEffect.effect = function(targetChar){
		// I can think of two ways for the terror rando turn skip thing to work:
		// 1. We remove the afflicted character from the relevant party array of the combat instance when terror strikes and then add them back in a round post proc
		// 2. We add a bitfield to Character that can receive abitrary PoT flags like {FLAG_SKIP_TURN = 1} and when the character's turn comes up (or elsewhere, as needed) we check this bitfield for relevant raised flags.  In the case of FLAG_SKIP_TURN, we'd need to process the randomness and decide whether or not to raise the flag in round pre proc and then lower the flag in each round post proc since the character is not necessarily terrorized each round.
		
		// raise flag
		//targetChar.combatFlags |= targetChar.CombatFlags.FLAG_SKIP_TURN; // flag needs to be raised in round pre proc.  The pre proc block should check for this status effect and then call its effect(), which will return true if some status-effect-specific percentage range is hit.
		
		// 35% chance
		return State.variables.rollPercentage() <= 35;
	}
	terrorStatusEffect.reverseEffect = function(targetChar){}
	
	/**
	Poison deals dmg each turn and halves atk/def stats
	*/
	var poisonStatusEffect = State.variables.statusEffectsDict["poison"];
	poisonStatusEffect.effect = function(targetChar){
		targetChar.stats["atk"] *= 0.5;
		targetChar.stats["def"] *= 0.5;
	}
	poisonStatusEffect.reverseEffect = function(targetChar){
		targetChar.stats["atk"] *= 2;
		targetChar.stats["def"] *= 2;
	}
	
	var shadowStatusEffect = State.variables.statusEffectsDict["shadow"];
	shadowStatusEffect.effect = function(targetChar){
		this.cachedDef = targetChar.stats["def"];
		targetChar.stats["def"] = Infinity;
	}
	shadowStatusEffect.reverseEffect = function(targetChar){
		targetChar.stats["def"] = this.cachedDef;
	}
	
	var confuseStatusEffect = State.variables.statusEffectsDict["confuse"];
	confuseStatusEffect.effect = function(targetChar){
		return State.variables.rollPercentage() > 50;
	}
	confuseStatusEffect.reverseEffect = function(targetChar){}
	
	var charmStatusEffect = State.variables.statusEffectsDict["charm"];
	charmStatusEffect.effect = function(sourceChar,targetChar){
		// set the id of the forbidden target for this effect instance
		this.sourceCharacterId = sourceChar.id;
	}
	charmStatusEffect.reverseEffect = function(targetChar){
		this.sourceCharacterId = undefined;
	}
	
	// public incarnations
	
	// from Splinter of Serpentarius
	/**
	Debilitate lowers all defensive attributes of the target, and inflicts currHp*0.1 dmg
	*/
	var debilitate = State.variables.incarnationsDict["debilitate"];
	debilitate.targetType = debilitate.TargetTypesEnum.singleEnemy;
	debilitate.calcDmg = function(sourceChar,targetChar){
		return targetChar.stats.hp*0.1;	
	}
	debilitate.effect = function(sourceChar,targetChar){
		State.variables.addUniqueStatusEffect(targetChar,defenselessStatusEffect);	
		
		// MP cost
		sourceChar.stats["mp"] -= 25;
	}
	debilitate.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" narrows "+sourceChar.getPronoun_gen()+" eyes, shining with cruel malice, at "+targetChar.name+".  Space distorts mildly, constricting around and through "+targetChar.name+", and "+targetChar.getPronoun_gen()+" presence seems to diminish substantially!";	
	}
	/**
	Pierce is a physical strike for which atk bypasses def
	*/
	var pierceIncarnation = State.variables.incarnationsDict["pierce"];
	pierceIncarnation.targetType = pierceIncarnation.TargetTypesEnum.singleEnemy;
	pierceIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["atk"];		
	}
	pierceIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["hp"] -= this.dmg;
		
		// MP cost
		sourceChar.stats["mp"] -= 10;
	}
	pierceIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" smoothly reaches directly into "+targetChar.name+"'s soul, and just kinda... fiddles around a little.  "+targetChar.name+" does not appreciate this, emphatically, to the tune of "+this.dmg+" delicious damages!";	
	}
	
	var toxinIncarnation = State.variables.incarnationsDict["toxin"];
	toxinIncarnation.targetType = toxinIncarnation.TargetTypesEnum.singleEnemy;
	toxinIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["pwr"]-targetChar.stats["res"];		
	}
	toxinIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["hp"] -= this.dmg;
		State.variables.addUniqueStatusEffect(targetChar,poisonStatusEffect);
		
		// MP cost
		sourceChar.stats["mp"] -= 15;
	}
	toxinIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return "An aura of gleaming electric purple light, striated with the cheerily deadly greenish glow of radioactivity, surrounds "+sourceChar.name+" as "+sourceChar.getPronoun_gen()+" fevered will infects "+targetChar.name+".";	
	}
	
	// from Splinter of Violet
	/**
	Shadowform makes the character immune to physical damage.  
	TODO: add a physical/magic damage typing system.  For now, we'll just make def infinite.
	*/
	var shadowFormIncarnation = State.variables.incarnationsDict["shadowform"];
	shadowFormIncarnation.targetType = shadowFormIncarnation.TargetTypesEnum.allAllies; // actually self-only, but this will have the same effect in the UI
	shadowFormIncarnation.effect = function(sourceChar,targetChar){
		State.variables.addUniqueStatusEffect(sourceChar,shadowStatusEffect);
		
		// MP cost
		sourceChar.stats["mp"] -= 30;
	}
	shadowFormIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return "Shadows dance free of their source lights, and embrace "+sourceChar.name+" warmly.  Velvet darkness spreads over "+sourceChar.getPronoun_gen()+" body, and "+sourceChar.getPronoun_nom()+" relaxes into oneness with the infinite possibilities of undefinition; "+sourceChar.getPronoun_nom()+" seems almost ethereal now.";	
	}
	
	/**
	Perfect Stillness deals mild cold damage to the wielder and massive cold damage to the target
	*/
	var perfectStillnessIncarnation = State.variables.incarnationsDict["perfectStillness"];
	perfectStillnessIncarnation.targetType = perfectStillnessIncarnation.TargetTypesEnum.singleEnemy;
	perfectStillnessIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["pwr"] - targetChar.stats["res"]/2;		
	}
	perfectStillnessIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		this.selfDmg = this.calcDmg(sourceChar,sourceChar);
		targetChar.stats["hp"] -= this.dmg;
		sourceChar.stats["hp"] -= this.selfDmg;
		
		// MP cost
		sourceChar.stats["mp"] -= 15;
	}
	perfectStillnessIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" extends "+sourceChar.getPronoun_gen()+" arms slowly towards "+targetChar.name+", almost as if inviting a hug.  Suddenly, a rolling torrent of absolute serenity and silence, so profoundly vaccuous that it forces all in attendance to take a step back as from an overwhelming physical force, explodes forth from "+sourceChar.getPronoun_obj()+".  Both folks are rocked by the violence of the peace, and "+targetChar.name+" is driven to "+targetChar.getPronoun_nom()+" knees";	
	}
	
	/**
	Savage Sympathy deals more damage the greater the difference between the wielder and the target's ATK, and heals the wielder
	*/
	var savageSympathyIncarnation = State.variables.incarnationsDict["savage_sympathy"];
	savageSympathyIncarnation.targetType = savageSympathyIncarnation.TargetTypesEnum.singleEnemy;
	savageSympathyIncarnation.calcDmg = function(sourceChar,targetChar){
		return Math.abs(targetChar.stats["atk"] - sourceChar.stats["atk"])*2;		
	}
	savageSympathyIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["hp"] -= this.dmg;
		sourceChar.stats["hp"] += this.dmg/2;
		
		// MP cost
		sourceChar.stats["mp"] -= 20;
	}
	savageSympathyIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" is no fan of natural privilege.  In fact, "+sourceChar.getPronoun_nom()+" takes ecstatic pleasure in balancing the old scales, with blood if necessary.  To wit, blood from "+targetChar.name+"'s orificeses begins slowly spiraling through the air and into "+sourceChar.name+"'s snarling mouth.";	
	} 
	
	// from Splinter of Snugg-lor
	/**
	Warmest hug heals self and other with ATK
	*/
	var warmestHugIncarnation = State.variables.incarnationsDict["warmest_hug"];
	warmestHugIncarnation.targetType = warmestHugIncarnation.TargetTypesEnum.singleAlly;
	warmestHugIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["atk"];		
	}
	warmestHugIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["hp"] += this.dmg;
		sourceChar.stats["hp"] += this.dmg;
		
		// MP cost
		sourceChar.stats["mp"] -= 20;
	}
	warmestHugIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" embraces "+sourceChar.getPronoun_gen()+" friend "+targetChar.name+" fondly, a soft golden glow surrounding them both.";	
	} 
	
	/**
	Woolly Shield raises target's DEF by wielder's RES+DEF
	*/
	var woollyShieldIncarnation = State.variables.incarnationsDict["woolly_shield"];
	woollyShieldIncarnation.targetType = woollyShieldIncarnation.TargetTypesEnum.singleAlly;
	woollyShieldIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["def"] + sourceChar.stats["res"];		
	}
	woollyShieldIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["def"] += this.dmg;
		
		// MP cost
		sourceChar.stats["mp"] -= 30;
	}
	woollyShieldIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return sourceChar.name+" puffs out "+sourceChar.getPronoun_gen()+" hair, approximating thick wool as best "+targetChar.getPronoun_nom()+" can, and jumps in front of "+targetChar.name+", intent on protecting "+targetChar.getPronoun_gen()+" with "+sourceChar.getPronoun_gen()+" woolly life!";	
	} 
	
	/**
	Maenad Frenzy deals ATK+CHA to self and (ATK+CHA)*2 to target
	*/
	var maenadFrenzyIncarnation = State.variables.incarnationsDict["maenad_frenzy"];
	maenadFrenzyIncarnation.targetType = maenadFrenzyIncarnation.TargetTypesEnum.singleEnemy;
	maenadFrenzyIncarnation.calcDmg = function(sourceChar,targetChar){
		return sourceChar.stats["atk"]+sourceChar.attributes["charisma"];		
	}
	maenadFrenzyIncarnation.effect = function(sourceChar,targetChar){
		this.dmg = this.calcDmg(sourceChar,targetChar);
		targetChar.stats["hp"] -= this.dmg;
		sourceChar.stats["hp"] -= this.dmg/2;
		
		// MP cost
		sourceChar.stats["mp"] -= 10;
	}
	maenadFrenzyIncarnation.generateFlavorText = function(sourceChar,targetChar){
		return "A manic gleam shines in "sourceChar.name+"'s eyes as they reflect the brilliant light of the lunatic moon suddenly huge in the sky above.  "+sourceChar.getPronoun_nom()+" embraces "+targetChar.name+" with a violent longing, pleasure driven through to pain before the fires of wild need.  "+targetChar.getPronoun_nom()+" wriggles and tries to escape as "+sourceChar.name+" squeezes "+targetChar.getPronoun_obj()+", but there is no way out.  The embrace tightens and the whipcrack of snapping bone makes the night itself cower.";	
	} 
	
	var puckChar = State.variables.characters["puck"];
	puckChar.gender = "male";
	puckChar.attributes["strength"] = 8;
	puckChar.attributes["dexterity"] = 20;
	puckChar.attributes["constitution"] = 10;
	puckChar.attributes["intelligence"] = 22;
	puckChar.attributes["wisdom"] = 6;
	puckChar.attributes["charisma"] = 20;
	puckChar.stats["hp"] = 500;
	puckChar.stats["mp"] = Infinity;
	puckChar.stats["maxHP"] = 500;
	puckChar.stats["maxMP"] = Infinity;
	// todo: these assignments could be replaced with a recompute fn
	puckChar.stats["atk"] = puckChar.attributes["strength"];
	puckChar.stats["def"] = puckChar.attributes["constitution"];
	puckChar.stats["pwr"] = puckChar.getMagicAttributeScore();
	puckChar.stats["res"] = puckChar.getMagicAttributeScore();
	// todo: equip Puck?
	puckChar.entity = new Entity("Vicious Mockery");
	var rapierWit = new State.variables.Incarnation("Rapier Wit");
	rapierWit.generateFlavorText = function(sourceChar,targetChar){
		if(targetChar){
			// randomly selected insults based on descriptor tags
			if(targetChar.descriptors.body.includes("fur")){
				var percentage = State.variables.rollPercentage();
				if(targetChar.gender === "female"){
					if(percentage <= 20){
						return sourceChar.name+" accuses "+targetChar.name+" of having fur extensions!  She blushes and bristles with unnatural incapacitating rage, the engineered emotion practically coruscating with Incarnation.";
					}// end 1-20%
					else if(percentage > 20 && percentage <= 70){
						return "Looking down "+(sourceChar.gender==="female"?"her":"his")+" nose at "+targetChar.name+", "+sourceChar.name+" sniffs and conjectures that the once-sinuous curves of her body have become somewhat oblong... and lumpy!  She reels in bizarre anguish as the taunt burrows into her psyche.";
					}//end 21-70%
					else if(percentage > 70 && percentage <= 100){
						return sourceChar.name+" sniffs the air and then wrinkles "+(sourceChar.gender==="female"?"her":"his")+" nose in disgust, accusing "+targetChar.name+" of stinking like a bog.  Incarnate self-consciousness floods her neurons and she can't be sure of herself!" 
					}//end 71-100%
				}else if(targetChar.gender === "male"){
					if(percentage <= 50){
						return sourceChar.name+" sizes up "+targetChar.name+" and smirks, informing "+targetChar.name+" that his musculature is reminiscent of a doddering and decrepit elder.  His eyes burn cherry-red as Incarnate rage strangles his mind.";
					}else{
						return sourceChar.name+" takes a long hard look below "+targetChar.name+"'s belt and then scoffs, clearly underwhelmed.  Venemous doubt Incarnate seeps into the cracks of his self-image and harden there, shattering it!";	
					}
				}
			}
		}// end if a targetChar is given
		else{
			return sourceChar.name+" points and laughs in a literally cutting fashion!"
		}
	}
	rapierWit.targetType = rapierWit.TargetTypesEnum.singleEnemy;
	rapierWit.calcDmg = function(sourceChar,targetChar){
		// highly variable damage sourced from source CHA and resisted slightly by target CHA
		return State.variables.rollDie(6) *State.variables.calcMod(sourceChar.attributes["charisma"]) - State.variables.calcMod(targetChar.attributes["charisma"]);	
	}
	rapierWit.effect = function(sourceChar,targetChar){
		targetChar.stats.hp -= rapierWit.calcDmg(sourceChar,targetChar);
		State.variables.addUniqueStatusEffect(targetChar,doubtStatusEffect);
	}
	puckChar.incarnations["rapier_wit"] = rapierWit;
	
	var rainOfRadiance = new State.variables.Incarnation("Rain of Radiance");
	rainOfRadiance.generateFlavorText = function(sourceChar,targetChar){
			return sourceChar.name+" thrusts a hand towards the heavens, muscles quivering with equal parts strain and anticipation.  The first few glittering droplets of liquid blue-white starlight are beautiful, but their virtue is quickly eclipsed by a tide of agony that grips the entire party as their flesh/fur is scorched/singed by celestial fire!";	
	}
	rainOfRadiance.targetType = rainOfRadiance.TargetTypesEnum.allEnemies;
	rainOfRadiance.calcDmg = function(sourceChar,targetChar){
		// 'starlight dmg' cuts through defenses and thus cannot be reduced by targetChar attrs... sure.
		return 5*State.variables.calcMod(sourceChar.stats["pwr"])
	}
	/**
	Rain of Radiance expects an array of target chars since it hits all enemies
	*/
	rainOfRadiance.effect = function(sourceChar,targetChars){
		for(let target of targetChars){
			target.stats.hp -= rainOfRadiance.calcDmg(sourceChar,target);	
		}
	}
	puckChar.incarnations["rain_of_radiance"] = rainOfRadiance;
	
	var swordsDance = new State.variables.Incarnation("Swords Dance");
	swordsDance.generateFlavorText = function(sourceChar,targetChar){
		var flavorString = "Cruel cold light gleams in "+targetChar+"'s eyes as warrior spirits torn directly from the savagery of the Wild Hunt meld with "+(targetChar.gender === "female"?"her":"his")+" spirit!";
		if(targetChar.descriptors.body.includes("fun_sized")){
			flavorString += "  You didn't think such a petite individual could strike terror in your heart with mere physical presence, but it seems you were wrong."	
		}else if(targetChar.descriptors.body.includes("party_sized")){
			flavorString += "  You didn't think "+(targetChar.gender === "female"?"her":"his")+" physical presence could loom any larger, but it seems you were wrong."
		}
		
		return flavorString;
	}
	swordsDance.targetType = swordsDance.TargetTypesEnum.singleAlly;
	swordsDance.effect = function(sourceChar,targetChar){
		State.variables.addUniqueStatusEffect(targetChar,bloodlustStatusEffect);	
	}
	puckChar.incarnations["swords_dance"] = swordsDance;
	
	puckChar.runAI = function(combat,role){
		if(role){
			if(role === "enemy"){
				var chosenAbility = "";
				var chosenTarget = "";
				/* todo: Puck enemy AI behavior	
					 x1. Primary behavior should be randomly chosen abl, with weights towards the Incarnations (though he won't use Swords Dance if he's already got Bloodlust on).
					 TODO: need to add checks for hp <= 0 so Puck doesn't wind up obsessively flogging corpses while the player shrugs and stabs him to death.
					 x2. If Puck's HP is less than 50% and he does not have any mental debuffs (including those imposed by Bloodlust), spam Rain of Radiance.
					 x2. [Dimplomancy Scenario] If anyone has just been healed, use Rain of Radiance. UPDATE: actually, this might be OP.  Also, so far I've avoided building stateful infrastructure with combat history intel, and I'd prefer to continue avoiding that for the demo!
					 x3. [Viral Violence] If a physically frail character is under 50% hp and Puck is Bloodlusted, he Attacks that character.
					 x4. [Surgical Systems] If any player character has an offensive buff (e.g. from Dr. Beakman), focus fire that character with Rapier Wit if they don't already have Doubt.  If all offensively buffed characters already have Doubt, nuke w/ Rain of Radiance.
				*/
				// todo: Since I don't particularly want to toss more abilities onto him to handle the various godling strat paths, it might be best to just modify the AI to be differently aggressive based on the player's chosen path.  That makes more sense with the Entity thing anyhow.
				var playerParty = combat.playerParty;
				var enemyParty = combat.enemyParty;
				
				// outliers and statistical points of interest
				var playerLeastDefense = State.variables.characters["player"];
				var playerLeastHP = State.variables.characters["player"];
				var playerWithTargetBuff = "undefined";
				var anyPlayerOffenseBuffed = false;
				var maxHealth = true; // assume true and let contradiction flip it
				
				/// begin gathering data and potentially exiting to Rapier Wit on any buffed player character ///
				for(let player of playerParty){
					
					// overwrite player with least defense if applicable
					if(player.stats["def"] < playerLeastDefense.stats["def"]){
						playerLeastDefense = player;	
					}
					
					// overwrite player with least HP if applicable
					if(player.stats.hp < playerLeastHP.stats.hp){
						playerLeastHP = player;	
					}
					
					if(player.statusEffects.length > 0){
						var statuses = player.statusEffects;
						for(let status of statuses){
							if(status.buffity === "buffins"){
								// buff discovered on this player!  Get 'im!
								// todo: consider removing or deprioritizing this exit cond since it trumps the story scenario checks currently and those can't be moved above basic data gathering
								/*
								puckChar.incarnations["rapier_wit"].effect(puckChar,player);
								return;
								*/
								
								if(status.descriptors.includes("offensive")){
									 anyPlayerOffenseBuffed = true;
									 if( !State.variables.hasStatusEffect(player,State.variables.statusEffectsDict["doubt"])){
									playerWithTargetBuff = player;	
								}
							 }
							}
						}// end for each status on current player char
					}// end if current player has statuses
					
					// check for max health scenario flip
					if(player.stats.hp < player.stats.maxHP){
						maxHealth = false;	
					}
					
				}// end for each player
				/// end gathering data + maybe buff balancing ///
				
				/// begin story scenario modifier processing ///
				if(State.variables.godling_strat === State.variables.godling_strat_viral_violence){
					if(playerLeastDefense.stats.hp < playerLeastDefense.stats.maxHP/2){
						// if the player char with least def is bloodied...
						if(State.variables.hasStatusEffect(puckChar,State.variables.statusEffectsDict["bloodlust"])){
							// if Puck already has bloodlust, go ahead and clobber the poor sucker with lowest defense and HP < 50%
							/*
							puckChar.abilities["attack"].effect(puckChar,playerLeastDefense);
							combat.combatLogContent = puckChar.abilities["attack"].generateFlavorText();
							return;
							*/
							chosenAbility = puckChar.abilities["attack"];
							chosenTarget = playerLeastDefense;
						}else{
							// Puck doesn't have bloodlust yet, so get it!
								/*
								puckChar.incarnations["swords_dance"].effect(puckChar,puckChar);
							combat.combatLogContent = puckChar.incarnations["swords_dance"].generateFlavorText();
							
							return;
							*/
							chosenAbility = puckChar.incarnations["swords_dance"];
							chosenTarget = puckChar;
						}
					}
				}else if(State.variables.godling_strat === State.variables.godling_strat_surgical_systems){
					// hit the latest player with a buff with debuff to balance the ol' scales
					if(playerWithTargetBuff){
							if(!State.variables.hasStatusEffect(playerWithTargetBuff,State.variables.statusEffectsDict["doubt"])){
							
/*								puckChar.incarnations["rapier_wit"].effect(puckChar,playerWithTargetBuff);
								combat.combatLogContent = puckChar.incarnations["rapier_wit"].generateFlavorText();
								return;
								*/
								chosenAbility = puckChar.incarnations["rapier_wit"];
								chosenTarget = playerWithTargetBuff;
						}// end if player with target buff does not already have doubt
						else if(anyPlayerOffenseBuffed){
							// presumably in this case every character with an offensive buff already has doubt.  With our scale balancing work done, just fry 'em with Rain of Radiance!
							
/*							puckChar.incarnations["rain_of_radiance"].effect(puckChar,combat.playerParty);
							combat.combatLogContent = puckChar.incarnations["rain_of_radiance"].generateFlavorText();
							return;
							*/
							chosenAbility = puckChar.incarnations["rain_of_radiance"];
							chosenTarget = combat.playerParty;
						}
					}
				}else if(State.variables.godling_strat === State.variables.godling_strat_diplomancy){
					// if everyone is at max HP, use Rain of Radiance to fix that little problem
					if(maxHealth){
							
/*						puckChar.incarnations["rain_of_radiance"].effect(puckChar,combat.playerParty);	
						combat.combatLogContent = puckChar.incarnations["rain_of_radiance"].generateFlavorText();
						return;
						*/
						chosenAbility = puckChar.incarnations["rain_of_radiance"];
						chosenTarget = combat.playerParty;
					}
				}
				
				/// end story scenario mod proc ///
				
				/// begin defaults block -- at this point in the script, if Puck has not already picked an abl he will either do one mostly at random OR spam Rain of Radiance if his health is below 50% ///
			if(chosenAbility === "" && chosenTarget === ""){
				if(puckChar.stats.hp > puckChar.stats.maxHP/2){
					// rando time!
				var percentageRandoAbl = State.variables.rollPercentage();
				
				// establish a random percentage which will be used to select a player party member
				var randoAtkTargetRange = State.variables.rollPercentage();
				// the mapping between percentage and player party indices, e.g. 4 player chars -> 100/4 = 25 -> every 25% we figure the index needs to increment
				var playerPartyRangeChunk = 100/combat.playerParty.length;
				var playerRandoTarget = combat.playerParty[randoAtkTargetRange/playerPartyRangeChunk];
				
				if(percentageRandoAbl <= 35){
					// todo: maybe consider targeting player with least HP if the least HPness is relatively greater than the least defenseness (relative standing)?
			
/*					puckChar.abilities["attack"].effect(puckChar,playerLeastDefense);
					combat.combatLogContent = puckChar.abilities["attack"].generateFlavorText();
					return;
					*/
					chosenAbility = puckChar.abilities["attack"];
					chosenTarget = playerLeastDefense;
				}else if(percentageRandoAbl > 35 && percentageRandoAbl <= 65){
					
/*					puckChar.incarnations["rapier_wit"].effect(puckChar,playerRandoTarget);
					combat.combatLogContent = puckChar.incarnations["rapier_wit"].generateFlavorText();
					return;
					*/
					chosenAbility = puckChar.incarnations["rapier_wit"];
					chosenTarget = playerRandoTarget;
				}else if(percentageRandoAbl > 65 && percentageRandoAbl <= 85){
					
					if(!State.variables.hasStatusEffect(puckChar,State.variables.statusEffectsDict["bloodlust"])){					
/*						puckChar.incarnations["swords_dance"].effect(puckChar,puckChar);	
																																																				combat.combatLogContent = puckChar.incarnations["swords_dance"].generateFlavorText();
																																																				return;
																																																				*/
						chosenAbility = puckChar.incarnations["swords_dance"];
						chosenTarget = puckChar;
																																								}else{

						// Puck already has Bloodlust, so do the atk strat
																																									
																																			/*						puckChar.abilities["attack"].effect(puckChar,playerLeastDefense);	
																																									combat.combatLogContent = puckChar.abilities["attack"].generateFlavorText();
																																								return;
																																									*/
																																									chosenAbility = puckChar.abilities["attack"];
																																									chosenTarget = playerLeastDefense;
																																								}
				}else{
					
/*					puckChar.incarnations["rain_of_radiance"].effect(puckChar,combat.playerParty);	
					combat.combatLogContent = puckChar.incarnations["rain_of_radiance"].generateFlavorText();
					return;
					*/
					chosenAbility = puckChar.incarnations["rain_of_radiance"];
					chosenTarget = combat.playerParty;
				}// end rando time
			 }// end Puck HP > 50%
			 else{
			 	// being severely injured, Puck now starts to spam Rain of Radiance if no earlier behaviors were proced
				 
/*				 puckChar.incarnations["rain_of_radiance"].effect(puckChar,combat.playerParty);
				 combat.combatLogContent = puckChar.incarnations["rain_of_radiance"].generateFlavorText();
				 return;
				 */
				 chosenAbility = puckChar.incarnations["rain_of_radiance"];
				 chosenTarget = combat.playerParty;
			 }
			} // end if abl and target are not yet chosen, landing us in defaults
			/// end defaults block ///
				
				// todo: consider finding a way to wrap specific AI in common AI handling, such that confusion/charm etc. handling like this can be common to all characters' AI scripts.
		
// todo: if confused, reassign chosenTarget with 50% self-target and 50% original target(s)
				// todo: this reassignment would ideally take ability target types into account
				if(State.variables.hasStatusEffect(puckChar,State.variables.statusEffectsDict["confuse"])){
					
// confuse's effect is to roll percentage and return true if value is > 50
					if(State.variables.getStatusEffect(puckChar,"confuse").effect()){
						chosenTarget = puckChar;	
					}
			}
			else if(State.variables.hasStatusEffect(puckChar,State.variables.statusEffectsDict["charm"])){
				var charmStatusInstance = State.variables.getStatusEffect(puckChar,"charm");
				var charmingCharacterId = charmStatusInstance.sourceCharacterId;
					if(chosenTarget.id === charmingCharacterId){
						 // rando reassign to someone other than charming character
						chosenTarget = combat.randoCombatantExcept(charmingCharacterId);
					}
			}
				
				 // todo: how should individual potential target combat flags work together with abilities whose effect API expects an entire party of targets?  One target with wonder wall should not stop the abl from hitting others on the one hand, and on the other the walled character needs to not have the abl effect applied to them and should proc the wall of wonder reprisal.
				// UPDATE: create a set of chosen targets, even if only one.  Then step through and check for wall of wonder protection.  If found, remove the walled character from the set of targets and apply wall reprisal.  After iteration is complete, send the remaining target set into the chosen ability.
				// since chosen target could be one or more, create an array if there is only one and then we can still just iterate over it
			var targets = undefined;	
			if(chosenAbility.targetType === chosenAbility.TargetTypesEnum.allEnemies || chosenAbility.targetType === chosenAbility.TargetTypesEnum.allAllies){
				targets = chosenTarget;
			}else{
				// in this case there is only one target, but by wrapping it in an array we can proceed with equivalent loop code below
				targets = [chosenTarget];	
			}
				
				// process combat flags on the chosen target(s)
				for(let target of targets){
					if(target.combatFlags & target.CombatFlags.FLAG_WONDER_WALLED === target.CombatFlags.FLAG_WONDER_WALLED){
				// lower the wonder wall flag
				target.combatFlags &= ~target.CombatFlags.FLAG_WONDER_WALLED;
				
				// the combat log content should reflect the bounce off the wall and any and all reprisals concatenated
				combat.combatLogContent = "BZZzzzrrr--SHING!\n";
						
				// remove the walled character from the chosenTarget array
						State.variables.removeCharacterFromArray(target,targets);
				
				// todo: generate a random effect, dmg or status, to direct back at Puck
				
				// todo: apply the effect to Puck
				
				
				}// end wall of wonder flag processing
			}// end combat flag processing loop for target(s)
				
				// todo: easiest way to have cost still applied to the ability even if there are now 0 targets is to fire off the effect over an empty array.  Trouble is that most abl effect functions were not written expecting an array of targets, and even those that do don't check for an empty array explicitly which might matter depending on how we use the array in effect().  May want to re-write those APIs to make it a standard array of target chars, but for the moment simply sourcing the target type of the chosen ability should suffice.  However, that still procs undefined ref errors since effect() doesn't check for undefined target(s).  Way around that is to apply the cost of the ability separately and then skip the effect() call and the usual flavor text if the targets array is empty.
				if(targets.length > 0){
					// there are still targets, so go forward with them as per usual
					chosenAbility.effect(puckChar,targets);
					combat.combatLogContent = chosenAbility.generateFlavorText(puckChar,targets);
				}else{
					// abl cost is an object map with keys that match the mutable resource stats... completely on purpose and by design, that was.
					for(costElement in chosenAbility.cost){
						puckChar.stats[costElement] -= chosenAbility.cost[costElement];	
					}
				}
			
				
				/* // todo: maybe set a flag that says someone reflected the attack and therefore special processing is needed?
				if(wonderWalled){
				
				}
				else{
				// wall of wonder did not block the abl so it goes off as normal
				chosenAbility.effect(puckChar,chosenTarget);
				combat.combatLogContent = chosenAbility.generateFlavorText(puckChar,chosenTarget);
			}// end wall of wonder processing
				*/
				
			}// if role is enemy
		}// if role is defined
	}//end Puck AI def
	
	
	var marrahChar = State.variables.characters["marrah"];
	marrahChar.gender = "female";
	marrahChar.stats["hp"] = 40;
	marrahChar.stats["mp"] = 70;
	marrahChar.stats["maxHP"] = 40;
	marrahChar.stats["maxMP"] = 70;
	marrahChar.attributes["strength"] = 12;
	marrahChar.attributes["dexterity"] = 18;
	marrahChar.attributes["constitution"] = 10;
	marrahChar.attributes["intelligence"] = 14;
	marrahChar.attributes["wisdom"] = 8;
	marrahChar.attributes["charisma"] = 20;
	marrahChar.entity = new Entity("Kitsune");
	
	
	// Haunted Fey can Terrify opponent, causing them to randomly skip turns
	var hauntedFey = new State.variables.Incarnation("haunted_fey","Haunted Fey");
	marrahChar.incarnations["haunted_fey"] = hauntedFey;
	hauntedFey.targetType = hauntedFey.TargetTypesEnum.singleEnemy;
	hauntedFey.effect = function(sourceChar,targetChar){
		var savingThrow = targetChar.saves["will"] + State.variables.rollD20();
		// effect will be called on the Incarnation instance, so this should be bound to same
		if(savingThrow <= this.calcDC(marrahChar,"charisma")){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["terror"]);	
		}
	}// end defining effect of haunted_fey
	hauntedFey.generateFlavorText = function(sourceChar,targetChar){
		// todo: this is a perfect opportunity for "generative text"; nothing too fancy, basically randomized madlibs sort of thing is what I was thinking, but maybe with some slight inductive bias/target and source character descriptor consideration weighing the randomness used in populating the blanks.
		return sourceChar.name"'s visage shimmers as reality warps around "+sourceChar.getPronoun_gen()+" body.  In the next instant, "+sourceChar.getPronoun_nom()+" has been replaced by something born of the very fabric of nightmare -- the creature's flesh is withered and weathered, and blood oozes from innumerable splits in what appear to be surgical seams all along its abominable body.  Horns and claws extend from odd places, and fangs sprout from everywhere.  Wherever you look, there's another drooling mouth with a lashing, searching tongue covered in wicked barbs.  The eyes concern you the most, however: there is an alienness to them that you can't clearly define, but which speaks to you of unfathomable depths in the emptiness between the stars... and all that lurks there.  A moment later the horror is gone and "+sourceChar.name+" stands there as if nothing had happened, a smile all of teeth on "+sourceChar.getPronoun_gen()+" face as "+sourceChar.getPronoun_nom()+" surveys the anarchy "+sourceChar.getPronoun_nom()+" has inspired in the foebeasts' ranks!";
	}
	
	var foxFire = new State.variables.Incarnation("fox_fire","Fox Fire");
	marrahChar.incarnations["fox_fire"] = foxFire;
	foxFire.targetType = foxFire.TargetTypesEnum.singleEnemy;
	foxFire.calcDmg = function(sourceChar,targetChar){
		// dmg based on source's cur:max MP ratio
		var magicRat = sourceChar.stats.mp/sourceChar.stats.maxMP;
		
		// the max damage possible is based on _ and will be reduced by any magicRat less than 1
		return magicRat*(sourceChar.stats.maxMP/2); //so Marrah will start at max 35 damage, which is a little over double the normal attack damage.
		
	}
	foxFire.effect = function(sourceChar,targetChar){
		
		// apply status effect, doubt
		var savingThrow = targetChar.saves["will"] + State.variables.rollD20();
		// effect will be called on the Incarnation instance, so this should be bound to same
		if(savingThrow <= this.calcDC(marrahChar,"charisma")){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["doubt"]);
			
			// set dmg
			this.dmg = this.calcDmg(sourceChar,targetChar);
			
			// deal dmg
			targetChar.stats.hp -= this.dmg;
	}
		
	var ghostWhip = new State.variables.Incarnation("ghost_whip","Ghost Whip");
	marrahChar.incarnations["ghost_whip"] = ghostWhip;
	ghostWhip.targetType = ghostWhip.TargetTypesEnum.singleEnemy;
	ghostWhip.calcDmg = function(sourceChar,targetChar,aspect){
		if(aspect === "meat"){
			// CHA vs. CON to damage HP and give half to source
			return 10+sourceChar.attributes["charisma"]-targetChar.attributes["constitution"];
			
		}else if(aspect === "mind"){
			// CHA vs. CHA to damage MP and give half to source
			return 10+sourceChar.attributes["charisma"]-targetChar.attributes["charisma"];
		
		}
	}
	ghostWhip.effect = function(sourceChar,targetChar){
		this.hpDmg = this.calcDmg(sourceChar,targetChar,"meat");
		this.mpDmg = this.calcDmg(sourceChar,targetChar,"mind");
		targetChar.stats.hp -= this.hpDmg;
		targetChar.stats.mp -= this.mpDmg;
		sourceChar.stats.hp += this.hpDmg/2;
		sourceChar.stats.mp += this.mpDmg/2;
	}
	ghostWhip.generateFlavorText = function(sourceChar,targetChar){
		// todo: reference hpDmg and mpDmg instead of dmg!
		return "A whip of pale iridescent light appears in "+sourceChar.name+"'s paw, and "+sourceChar.getPronoun_nom()+" cracks it with a liquid flourish, shattering stillness.  "+targetChar.name+" recoils in horror as the whip passes through "+targetChar.getPronoun_gen()+" body and appears to wrap directly around "+targetChar.getPronoun_gen()+" heart.  A goofy grin crawls across "+sourceChar.name+"'s face as the light of will and life pulses back along the whip to "+sourceChar.getPronoun_obj()+" like blood through a glutted leech.  That'll be "+this.hpDmg+" damage to "+targetChar.getPronoun_gen()+" body and "+this.mpDmg+" to "+targetChar.getPronoun_gen()+" mind!";
	}
	
	/**
	Fire Claw combines Incarnation power with physical attack power to inflict heavy damage
	*/
	var fireClawIncarnation = new State.variables.Incarnation("fire_claw","Fire Claw");
		marrahChar.incarnations["fire_claw"] = fireClawIncarnation;
		fireClawIncarnation.targetType = fireClawIncarnation.TargetTypesEnum.singleEnemy;
		fireClawIncarnation.calcDmg = function(sourceChar,targetChar){
				return sourceChar.stats["pwr"]+sourceChar.stats["atk"];
		}
		fireClawIncarnation.effect = function(sourceChar,targetChar){
				this.dmg = this.calcDmg(sourceChar,targetChar);
				targetChar.stats["hp"] -= this.dmg;
		}
		fireClawIncarnation.generateFlavorText = function(sourceChar,targetChar){
			// todo: add randomness to abl text, modified by wielder and maybe target descriptor tags
			// todo: add non-Marrah text
			
			// Marrah specific text
			return "Marrah spins in a blur of scarlet and as the sheer frenzy of her motion whips up wind around her, a bonfire of pure passion erupts from nowhere and wraps her in a gorgeously deadly veil.  In the midst of a blinding nova through which only the sleek curves of her silhouette can be seen, she halts with a flourish and extends a slender arm flirtatiously towards "+targetChar.name+", crooking a finger in all-too-warm invitation.  The wild nova gathers itself into tongues that lick their languid way over her body to coalesce around her arm.  Before "+targetChar.getPronoun_nom()+" can flee, she darts forward and slashes "+targetChar.getPronoun_obj()+" with flaming claws that dig out grisly-deep tracks of sizzling flesh!";
		}
		
	var mootyChar = State.variables.characters["mooty"];
	mootyChar.gender = "male";
	mootyChar.stats["hp"] = 65;
	mootyChar.stats["mp"] = 50;
	mootyChar.stats["maxHP"] = 65;
	mootyChar.stats["maxMP"] = 50;
	mootyChar.attributes["strength"] = 18;
	mootyChar.attributes["dexterity"] = 8;
	mootyChar.attributes["constitution"] = 14;
	mootyChar.attributes["intelligence"] = 12;
	mootyChar.attributes["wisdom"] = 20;
	mootyChar.attributes["charisma"] = 13;
	mootyChar.entity = new Entity("Burrower");
	
	// todo: all these private Incarnations should be moved to the public Incarnations dict, unless there is some reason The Human should not be able to learn them
		
		/**
		Regenerator adds regen to the target
		*/
	var regeneratorIncarnation = new State.variables.Incarnation("regenerator","Regenerator");
		mootyChar.incarnations["regenerator"] = regeneratorIncarnation;
		regeneratorIncarnation.targetType = regeneratorIncarnation.TargetTypesEnum.singleAlly;
		regeneratorIncarnation.effect = function(sourceChar,targetChar){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["regen"]);	
		}
		regeneratorIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return sourceChar.name+" pours "+sourceChar.getPronoun_gen()+" empathy and will to protect into a tangible force, and it forms a gossamer veil that sparkles as if cut from sapphire around "+targetChar.name;
		}
		/**
		Spring Rain heals the entire party
		*/
	var springRainIncarnation = new State.variables.Incarnation("spring_rain","Spring Rain");
		mootyChar.incarnations["spring_rain"] = springRainIncarnation;
		springRainIncarnation.targetType = springRainIncarnation.TargetTypesEnum.allAllies;
		springRainIncarnation.calcDmg = function(sourceChar,targetChar){
			// healed based on the wielder's pwr and how much the wielder likes the target
			return sourceChar.stats["pwr"]+targetChar.affinities[sourceChar.id];
		}
		springRainIncarnation.effect = function(sourceChar,targetChars){
			for(let targetChar of targetChars){
				targetChar.stats["hp"] += this.calcDmg(sourceChar,targetChar);
			}
		}
		springRainIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return "A friendly little cloud whose only stormy spots seem to form a smiling expression gathers over the party as "+sourceChar.name+" extols "+sourceChar.getPronoun_gen()+" love for them.  Warm revitalizing rain washes over the party, closing wounds and raising spirits all around!";
		}
		
		/**
		Grief Howl returns a deceased ally to life  
		*/
	var griefHowlIncarnation = new State.variables.Incarnation("grief_howl","Grief Howl");
		mootyChar.incarnations["grief_howl"] = griefHowlIncarnation;
		griefHowlIncarnation.targetType = griefHowlIncarnation.TargetTypesEnum.singleAlly;
		griefHowlIncarnation.calcDmg = function(sourceChar,targetChar){
			// healed for maxHP/2 plus how much the wielder likes the target
			return targetChar.stats["maxHP"]/2+targetChar.affinities[sourceChar.id];
		}
		griefHowlIncarnation.effect = function(sourceChar,targetChar){
			// remove dead status and heal for calcDmg()
			targetChar.living = true;
			
			// first return HP to 0 baseline
			targetChar.stats["hp"] = 0;
			
			// then heal based on calcDmg()
			targetChar.stats["hp"] += this.calcDmg(sourceChar,targetChar);
			
			// todo: check living status during combat and when heals/dmg/targeting occurs (specifically for the demo with only a single enemy relative to the player: allAllies abilities should not hit nonliving party members, singleAlly abilities should not be able to target them, runAI()::singleEnemy should not choose them as target, and runAI()::allEnemies should not hit nonliving targets).
		}
		griefHowlIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return sourceChar.name+" tosses back "+sourceChar.getPronoun_gen()+" head and howls at the sky, mourning the loss of "+targetChar.name+".  The weight of "+sourceChar.getPronoun_gen()+" grief is so overwhelming that reality staggers beneath it, and buckles just enough that "+targetChar.name+"'s spirit can escape the jaws of Death!";
		}
		
	var drbeakmanChar = State.variables.characters["drbeakman"];
	drbeakmanChar.gender = "male";
	drbeakmanChar.stats["hp"] = 45;
	drbeakmanChar.stats["mp"] = 65;
	drbeakmanChar.stats["maxHP"] = 45;
	drbeakmanChar.stats["maxMP"] = 65;
	drbeakmanChar.attributes["strength"] = 8;
	drbeakmanChar.attributes["dexterity"] = 10;
	drbeakmanChar.attributes["constitution"] = 10;
	drbeakmanChar.attributes["intelligence"] = 24;
	drbeakmanChar.attributes["wisdom"] = 10;
	drbeakmanChar.attributes["charisma"] = 10;
	drbeakmanChar.entity = new Entity("Tactitian");
	
	/**
		Vibroblade adds a chainsaw-like kinetic force to the target's weapon! (gives temper status effect)
		*/
	var vibrobladeIncarnation = new State.variables.Incarnation("vibroblade","Vibroblade");
		drbeakmanChar.incarnations["vibroblade"] = vibrobladeIncarnation;
		vibrobladeIncarnation.targetType = vibrobladeIncarnation.TargetTypesEnum.singleAlly;
		vibrobladeIncarnation.effect = function(sourceChar,targetChar){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["temper"]);	
		}
		vibrobladeIncarnation.generateFlavorText = function(sourceChar, targetChar){
			// todo: need a 'get appendages' method that checks the descriptor array for tags that might hint at appendages.  Could even go into more detail with descriptors that are categorized to different details like the character's morphology, and have a subsection for appendages
			return sourceChar.name+" grins wickedly and performs a complicated flourish with "+sourceChar.getPronoun_gen()+" "+(sourceChar.descriptors.includes("bird")?"wings":"paws")+" and "+targetChar.name+"'s weapon begins to vibrate subtley as a razor-swift current of air blows cyclically around its edge.  A soft and supremely satisfying growly purring sound emenates from it; everyone who can backs away slightly.";
		} 
		
	/**
		Laser Sight adds Focus status effect
		*/
	var laserSightIncarnation = new State.variables.Incarnation("laser_sight","Laser Sight");
		drbeakmanChar.incarnations["laser_sight"] = laserSightIncarnation;
		laserSightIncarnation.targetType = laserSightIncarnation.TargetTypesEnum.singleAlly;
		laserSightIncarnation.effect = function(sourceChar,targetChar){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["focus"]);	
		}
		laserSightIncarnation.generateFlavorText = function(sourceChar, targetChar){
			// todo: focus on ether in the surrounding env
			return "Time slows down for "+targetChar.name" as "+sourceChar.name+" shows "+targetChar.getPronoun_obj()+" how to pull back the veil of our reality and see what lies behind.  The secrets of the universe fell somewhat closer!";
		}
		
	/**
		Fey Touch adds Third Eye status effect
		*/
	var feyTouchIncarnation = new State.variables.Incarnation("fey_touch","Fey Touch");
		drbeakmanChar.incarnations["fey_touch"] = feyTouchIncarnation;
		feyTouchIncarnation.targetType = feyTouchIncarnation.TargetTypesEnum.singleAlly;
		feyTouchIncarnation.effect = function(sourceChar,targetChar){
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["third_eye"]);	
		}
		feyTouchIncarnation.generateFlavorText = function(sourceChar, targetChar){
			// todo: fey granting understanding of multiverse
			return "As "+sourceChar.name+"'s eyes gleam in the direction of "+targetChar.name+", a portal to some place primordial, intense, and above all WILD rends reality in front of "+targetChar.getPronoun_obj()+".  A storm of beings emerge, each shimmering and distorted as a sort of veil of impossibility makes it difficult to focus on them.  The wind of whimsy weaves its way around "+targetChar.name+" for a few moments, then abruptly vanishes along with the portal it (they?) came through.  "+targetChar.name+" looks mostly unaffected, though a feral hunger lurks behind "+targetChar.getPronoun_nom()+" eyes.";
		}
		
	var shimmerinChar = State.variables.characters["shimmerin"];
	shimmerinChar.gender = "female";
	shimmerinChar.stats["hp"] = 30;
	shimmerinChar.stats["mp"] = 80;
	shimmerinChar.stats["maxHP"] = 30;
	shimmerinChar.stats["maxMP"] = 80;
	shimmerinChar.attributes["strength"] = 6;
	shimmerinChar.attributes["dexterity"] = 20;
	shimmerinChar.attributes["constitution"] = 6;
	shimmerinChar.attributes["intelligence"] = 18;
	shimmerinChar.attributes["wisdom"] = 10;
	shimmerinChar.attributes["charisma"] = 24;
	shimmerinChar.entity = new Entity("Whimsy of Wind");
	
	/**
		Wall of Wonder: protects each ally from a single attack by the enemy, and inflicts a random negative status or damage on the enemy in retaliation (using the character who cast the Wall Incarnation as the sourceChar). 
		*/
	var wallOfWonderIncarnation = new State.variables.Incarnation("wall_of_wonder","Wall of Wonder");
		shimmerinChar.incarnations["wall_of_wonder"] = wallOfWonderIncarnation;
		wallOfWonderIncarnation.cost = {"mp":35}
		wallOfWonderIncarnation.targetType = wallOfWonderIncarnation.TargetTypesEnum.allAllies;
		wallOfWonderIncarnation.effect = function(sourceChar,targetChars){
			// raise the wall of wonder flag for each allied party member
			for(let target of targetChars){
				target.combatFlags |= target.CombatFlags.FLAG_WONDER_WALLED;	
			}
			
			this.processCost(sourceChar);
		}
		wallOfWonderIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return sourceChar.name+" grins broadly and begins dancing about in the air in impossibly complex patterns.  A faint trail of light lingers where "+sourceChar.getPronoun_nom()+" passes, giving the impression that "+sourceChar.name+" is painting a glorious tableau with extreme haste.  Soon, the tableau becomes a tableau vivant: lights pull together into vague and curious forms, and then beging to move of their own volition.  By the time "+sourceChar.getPronoun_nom()+"'s finished, there is a small world of magnificent and terrible things zooming about in front of the party.  Their attention, one and all, is locked upon "+sourceChar.name+"'s foes!";
		} 
		
	/**
	Phantasmagoria: whimsical breath full of wonder and horror inextricably merged washes over the foebeasts, damaging and confusing them! (Confused status effect causes 50% chance that whatever abl the confused character chooses to use will be targeted at themselves instead of the original target)	
	*/
		var phantasmagoriaIncarnation = new State.variables.Incarnation("phantasmagoria","Phantasmagoria");
		shimmerinChar.incarnations["phantasmagoria"] = phantasmagoriaIncarnation;
		phantasmagoriaIncarnation.cost = {"mp":20}
		phantasmagoriaIncarnation.targetType = phantasmagoriaIncarnation.TargetTypesEnum.singleEnemy;
		phantasmagoriaIncarnation.calcDmg = function(sourceChar,targetChar){
			return sourceChar.stats["pwr"] - targetChar.stats["res"];
		}
		phantasmagoriaIncarnation.effect = function(sourceChar,targetChar){
			// apply dmg + Confuse to target
			this.dmg = this.calcDmg(sourceChar,targetChar);
			targetChar.stats["hp"] -= this.dmg;
			State.variables.addUniqueStatusEffect(targetChar,State.variables.statusEffectsDict["confuse"]);
			
			// handle cost to user
			this.processCost(sourceChar);
		}
		phantasmagoriaIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return "";
		}
		
	/**
	Caress of the Zephyr: teases, titillates, and slashes a target.  Deals dmg equal to pwr*2 - def/2 and charms the target (charm makes it so that the target cannot harm the charming character)
	*/
		var caressOfZephyrIncarnation = new State.variables.Incarnation("caress_of_zephyr","Caress of the Zephyr");
		shimmerinChar.incarnations["caress_of_zephyr"] = caressOfZephyrIncarnation;
		caressOfZephyrIncarnation.cost = {"mp":25}
		caressOfZephyrIncarnation.targetType = caressOfZephyrIncarnation.TargetTypesEnum.singleEnemy;
		caressOfZephyrIncarnation.calcDmg = function(sourceChar,targetChar){
			return sourceChar.stats["pwr"]*2 - targetChar.stats["def"]/2;	
		}
		caressOfZephyrIncarnation.effect = function(sourceChar,targetChar){
			// todo: dmg + Charm
			this.dmg = this.calcDmg(sourceChar,targetChar);
			targetChar.stats["hp"] -= this.dmg;
			State.variables.addUniqueStatusEffectWithSource(sourceChar,targetChar,State.variables.statusEffectsDict["charm"]);
			
			// handle cost to user
			this.processCost(sourceChar);
		}
		caressOfZephyrIncarnation.generateFlavorText = function(sourceChar, targetChar){
			return "";
		}
	
	/* // todo: consider adding Nuvi as a combat character post-demo
	var nuviChar = State.variables.characters["nuvi"];
	
	*/
	
	
	
}// end defining init()

/// begin init ///
init();
/// end init ///














</script><tw-passagedata pid="1" name="Chamber of Soiled Vestments" tags="" position="230,37" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;set $inv to []&gt;&gt;
&lt;&lt;set $known_id_nuvi to false&gt;&gt;

&lt;!--
&lt;&lt;print &quot;passage is &quot;+passage()&gt;&gt;
&lt;&lt;print &quot;hasVisited(&quot;+passage()+&quot;) is &quot;+hasVisited(passage())&gt;&gt;
&lt;&lt;print &quot;visited(&quot;+passage()+&quot;) is &quot;+visited(passage())&gt;&gt;
--&gt;
&lt;&lt;/nobr&gt;&gt;\
&lt;&lt;if !(visited(passage()) &gt; 1)&gt;&gt;\
The musty warmth of the laundry room has always appealed to you; it suggests a friendly invitation to the unknown, and there always seems to be another unexplored dark corner.  You smile contentedly at this thought, imagining that few people bother to appreciate the subtle treasures in a blanket of soft shadow.  A shared laundry like the one in your building is exponentially better, since every traveler through it leaves a little bit of themselves behind, enlivening the story.  If you were the type to rifle throw other people&#39;s skivvies it might be livelier-still, but that&#39;s intrusive. Also gross.

The dryer rumbles to a halt, then buzzes obnoxiously.  The world sure seems to love its noise.
&lt;&lt;else&gt;&gt;
You stand in the laundry room.  A speck of lint drifts by, placidly.
&lt;&lt;/if&gt;&gt;

Gather your clothes from [[the dryer-&gt;Dryer]]
Check drawers in [[the ancient table-&gt;Ancient Table]]</tw-passagedata><tw-passagedata pid="2" name="Footer Menu" tags="footer" position="13,152" size="100,100">Check [[inventory-&gt;Inventory]]</tw-passagedata><tw-passagedata pid="3" name="Dryer_alt" tags="alt_passage" position="126,184" size="100,100">Ducking down peer to inside, you&#39;re greeted by a pleasant surprise -- your clothes are fully dry for once!  As you pull clothes from the dryer and pile them in your hamper, you note that only a single sock of your favorite pair is present and accounted for. They&#39;re the super-fuzzy wooly kind, and are patterned with kittens playing with balls of yarn on one and puppies chasing sticks on the other.  Looking down at the lonely puppy sock, your heart aches a little.  Poor guy.  Practically climbing halfway into the dryer, you reach and flail about for the errant kitten sock to no avail.  
Re-adjusting yourself, you poke your head in to take a closer look, expecting ruefully to see only empty dryer walls. Instead, you see the head, shoulders, and bountiful cleavage of a miniature, winged woman staring at you with anxious eyes.  Before you can react, a hirsute arm snakes out and grabs you, pulling you into the dryer with monstrous strength.  You close your eyes and brace for the collision with the merciless metal wall, but it doesn&#39;t come... after a moment, a warm breeze and the unmistakeable smell of pine needles coaxes you to open your eyes. </tw-passagedata><tw-passagedata pid="4" name="Ancient Table" tags="" position="898,40" size="100,100">Inside the drawer rest one [[9-Volt battery-&gt;9-Volt]], a [[short length of copper wire-&gt;copper_wire]], a pair of [[rubber gloves-&gt;rubber_gloves]], a [[singed penny-&gt;penny]], and a battered [[pocket-knife-&gt;pocket_knife]].  Someone was attempting amateur electrical repairs.  Suddenly you find yourself thankful -well, less resentful anyway- for the over-sensitive smoke alarm that puts the building&#39;s occupants out in the cold at least once a quarter, and always in the middle of the night.
[[close the drawer -&gt;Chamber of Soiled Vestments]] </tw-passagedata><tw-passagedata pid="5" name="Inventory" tags="" position="42,337" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="6" name="9-Volt" tags="" position="543,193" size="100,100">Time and tide (by the look of it, it has actually been swimming) have not been kind to this old fellow, but he might still have some juice left.
take it
[[leave it -&gt;Ancient Table]] </tw-passagedata><tw-passagedata pid="7" name="copper_wire" tags="" position="678,198" size="100,100">The copper wire is about 1 meter long and 7 millimeters in diameter.
[[take it-&gt;copper_wire_taken]]
[[leave it -&gt;Ancient Table]] </tw-passagedata><tw-passagedata pid="8" name="rubber_gloves" tags="" position="801,193" size="100,100">These neon-yellow rubber gloves have seen a lot of abuse, and little washing.  You wrinkle your nose at the smell emanating from them (print: $inv).
take it
[[leave it -&gt;Ancient Table]] 
</tw-passagedata><tw-passagedata pid="9" name="penny" tags="" position="951,241" size="100,100">This is an especially bad sign; completing a fuse with a penny is a classic strategy for starting electrical fires in the handbook of the incompetent handyman.  At least this one is not currently serving as a vector to fiery oblivion for the building&#39;s occupants, but another one may have replaced it... you shudder and try to put it out of your mind.
take it
[[leave it -&gt;Ancient Table]] </tw-passagedata><tw-passagedata pid="10" name="pocket_knife" tags="" position="1101,241" size="100,100">A simple folding pocket knife, its blade pitted by age, the elements, and lack of maintenance.  Still, the edge is sharp and the knife is compact when folded.
take it
[[leave it -&gt;Ancient Table]] </tw-passagedata><tw-passagedata pid="11" name="copper_wire_taken" tags="" position="682,341" size="100,100">(set: $inv to $inv + (a: &quot;copper_wire&quot;))</tw-passagedata><tw-passagedata pid="12" name="Dryer" tags="" position="230,187" size="100,100">Ducking down peer to inside, you&#39;re greeted by a pleasant surprise -- your clothes are fully dry for once!  As you pull clothes from the dryer and pile them in your hamper, you note that only a single sock of your favorite pair is present and accounted for. They&#39;re the super-fuzzy wooly kind, and are patterned with kittens playing with balls of yarn on one and puppies chasing sticks on the other.  Looking down at the lonely puppy sock, your heart aches a little.  Poor guy.  Practically climbing halfway into the dryer, you reach and flail about for the errant kitten sock to no avail.  

Re-adjusting yourself, you poke your head in to take a closer look, expecting ruefully to see only empty dryer walls. Instead, you see the head, forelegs, and fuzzy whiskers of an otter staring at you with anxiety quaking in its fathomless black eyes.  He&#39;s wearing a darling little tophat, bowtie, and a gold-rimmed monocle adorns one eye.  Before you can react, he boops your nose with a soft paw, his expression apprehensive. After a bizarre moment staring at each other in this manner, reality begins to spin and you fear someone has turned the dryer on with you halfway inside!  You close your eyes, bracing for the inevitable pain as you evaluate the strength of the dryer&#39;s tumble cycle first-hand.  There&#39;s no pain, however, and after only a few dizzying seconds [[the world-&gt;Atrium Glade]] stills.</tw-passagedata><tw-passagedata pid="13" name="Atrium Glade" tags="fluffy_forest fuzziolump socket" position="228,347" size="100,100">&lt;&lt;if visited() == 1&gt;&gt;
Only, it&#39;s a different world than the one you left.  A cool breeze and the unmistakeable smell of pine needles coaxes you to open your eyes.

You find yourself in a wintry forest glade. [[Evergreen foliage-&gt;Atrium_Glade_Foliage]], bearing a light sprinkling of snow such that it resembles sugar-dusted sweets, surrounds you.  The otter, which sports a pair of fluffy brown wings the same shade as its sleek tawny fur, flits about your head, appraisingly.  His little tophat tilts gently back and forth in a hypnotizing pattern, in time with the rhythm of his lazy wing beats.  

&lt;&lt;else&gt;&gt;
A refreshing cool breeze carresses your cheek and ruffles the wintergreen foliage.  Only the gentle fwump fwump of the otter&#39;s wings breaks the tranquil silence, a comforting constant.
&lt;&lt;/if&gt;&gt;
&lt;&lt;set $current_room to passage()&gt;&gt;
Current passage is: $current_room
You feel the need to speak:
[[&quot;Where am I?&quot;-&gt;Atrium_Glade_Where_Player]]
[[&quot;Who are you?&quot;-&gt;Atrium_Glade_Who_Nuvi]]
[[&quot;What are you?&quot;-&gt;Atrium_Glade_What_Nuvi]]
[[&quot;I really like your wings!&quot;-&gt;Atrium_Glade_Wings_Compliment_Nuvi][$playerAffinities.nuvi_affinity += 1]]

// looks like Sugarcube will not create a variable for you on the fly as part of an operation like this; $nuvi_affinity needs to have already been set somewhere
//[&quot;Test&quot;][$nuvi_affinity += 1]
test is: &lt;&lt;print $test&gt;&gt;
Affinity is: &lt;&lt;print $playerAffinities.nuvi_affinity&gt;&gt;

</tw-passagedata><tw-passagedata pid="14" name="Alpha_Thanks_Player_Of_Romantic_Interest" tags="alpha user-targeted" position="812,329" size="100,100">/*something to the tune of &#39;hope you&#39;ve enjoyed exploring the land of Fuzziolump!  Speaking of exploring, would you like to explore a relationship with me?&#39; [cripes that sounds lame.  Think of better phrasing if we go with this one] and/or something referencing celebratory redwall-esque feasts in game and say &#39;speaking of feasting, would you like to get dinner sometime?*/</tw-passagedata><tw-passagedata pid="15" name="Atrium_Glade_Where_Player" tags="query conversation" position="24,482" size="100,100">&quot;You&#39;ve landed in the glorious world of [[Fuzziolump-&gt;Fuzziolump_Desc]], a reality born from your own species&#39; collective psyche! /*something about advent of electricity and telecomm tech leading to quantum tunneling/entanglement signal propagation and accidental influence of the development of life in this alternate universe.  Also something more directly SciFey, such that the particular thoughts/feelings conveyed by those signals matter and were shaping Fuzziolump even before telecomm simply from being experienced by humans.  Explains the personification of memes in the lumpkins, but not so much why they&#39;re mystified by human tech that comes through dryers.*/ To use more modern terminology, we were born of the internet... but in a good way!

&quot;Specifically, you&#39;re standing in the Atrium Glade.  This is one of many portals to and from Earth that we call sockets.  Each socket has its own quirks, but generally conform to two main rules: they can operate two ways (Fuzziolump-&gt;Earth, Earth-&gt;Fuzziolump), and they can only be opened from Fuzziolump.  I like the Atrium Glade because everything looks like it should be in a bakery window!&quot;  The otter licks his fuzzy chops wistfully.

[[&quot;Why did you bring me here?&quot;-&gt;Fuzziolump_Main_Quest_Desc]]</tw-passagedata><tw-passagedata pid="16" name="Atrium_Glade_Who_Nuvi" tags="query conversation" position="339,653" size="100,100">&lt;&lt;set $known_id_nuvi to true&gt;&gt;
My name is Nuvi, and I&#39;m here to be your adorably helpful guide.  No, I am not optional.  No, you cannot set me to silent mode.

[[Exit Conversation-&gt;Atrium Glade]]</tw-passagedata><tw-passagedata pid="17" name="Atrium_Glade_What_Nuvi" tags="query conversation" position="374,530" size="100,100">Crossing his little paws, &lt;&lt;if $known_id_nuvi&gt;&gt;Nuvi&lt;&lt;else&gt;&gt;the winged otter&lt;&lt;/if&gt;&gt; huffs, &quot;That&#39;s a rather rude question.  But I understand; you&#39;re used to a world with only a single sapient species -- how lonely you must be!  I&#39;d wager that where you&#39;re from, socialization is terribly dull for those who fit in, and all but impossible for those who don&#39;t.  &lt;&lt;if $known_id_world&gt;&gt;Fuzziolump&lt;&lt;else&gt;&gt;This world&lt;&lt;/if&gt;&gt; doesn&#39;t have that problem.&quot;

[[Exit Conversation-&gt;Atrium Glade]]</tw-passagedata><tw-passagedata pid="18" name="Fuzziolump_Desc" tags="desc conversation" position="194,513" size="100,100">&quot;Oh, it&#39;s a wondrous place full of multifarious sapient species.  You&#39;ll recognize many of our denizens&#39; general forms, but they&#39;re quite different from the simple animals in your world.&quot;

[[Exit Conversation-&gt;Atrium Glade]]</tw-passagedata><tw-passagedata pid="19" name="brainstorming" tags="design brainstorm dev" position="1,0" size="100,100">-Magic System: nanites?  It could go with the whole crap from Earth lost in dryers theme, though it wouldn&#39;t explain immediately how Fuzziolump came to be in the first place.  Anyway, I was thinking nanites that are sensitive to specific electromagnetic fields generated by thought patterns of organisms, and take predictable actions based on the field modulations.  This would effectively allow for psychic/emotional magic by proxy, and could even explain how the creatures of FUzziolump came to be as they are (genetic manipulation to create sapience and foment nanite propogation and maximum evolution efficiency).

--I&#39;m actually preferring something more fantasy-esque, such as subatomic organisms that react to thought/emotion EMFs in predictable ways.  That or maybe some particle or link between particles in Fuzziolump that reacts to psychic EMFs without any particular organism with motivations involved, such that the situation is effectively more direct rather than by proxy (really don&#39;t wanna proc memories of fucking midiclorians).  

--Creatures encountered should be silly intelligent animals but also perhaps some more exotic things that could be symbolic of creativity and emotion, such as Madoka style abstract art lifeforms.  May also consider some dangerous and unfuzzy creatures to reflect the dark side of creativity and emotion.

--the human&#39;s mana stat should be emotion levels, which will be modified by various actions.  Some will increase with related magic usage, but there will be negative consequences if they get too high (e.g. anger)!


-Setting: SciFey meets Redwall Abbey.  Basically a world similar to the Pathfinder primordial Fey world, but with slightly less magic and more pseudo-science behind its inception via imagination/emotion.  Also, Redwall level cute creatures all over the place.  Specifically, I was thinking something along the lines of somehow &lt;insert pseudoscience here&gt; the world of Fuzziolump came into being as a parallel universe derived from the thoughts and feelings of earth lifeforms.  This process was glacial at first, but sped up greatly as sapience emerged.  Once sapient thought was being communicated by proxy via radio waves in various and sundry forms, the development process increased exponentially.  Basically Fuzziolump was fairly unevolved until humanity came around, and then was fairly primitive and amorphous until humans invented radio communications; the direct point to point electronic comm of telegraphy helped, but was less effective than blasting out thoughts to the ether for reception at some planned point, but then also anywhere else that happened to be receiving.
-Story: a group of Fuzziolumpkins have gone rogue and are trying to use human tech to destroy others?  Doesn&#39;t really jive with the nanite thing, or any magic system really.  I was thinking this when the world was supposed to be just animals with incidental human tech who eventually grew smarts because smarts were needed to survive in a world of randomly appearing and potentially deadly high technology.  I&#39;m thinking I want to go more Sanderson fantasy though; less pressure to explain everything in terms of real-ish science.

Okay, much more interesting story idea based on new SciFey setting -- the Fuzziolumpkins have been developing much more quickly since the onset of radio based tech in the 20th century, and now with broadband internet they&#39;re beginning to see a rather worrying trend: creatures something like gods are being born.  This apotheosis is frightening and occasionally disastrous, so they brought in a human creative to help them understand how to control and potentially dismantle some of the organisms resultant from human and now Fuzziolumpkin (which was inspired by human but now, relatively recently thanks to radio, exists independently) imagination.  At least one of these will be some sort of big bad that fights back, and others will be sympathetic spirits that are still problematic.

-Combat:
Two easy options for combat in a text adventure
1. Choose your own adventure style, where each combat situation is really just another choice and only the details of the choice and associated consequences make it combat.
Pros:
-relatively easy to implement
Cons:
-combat doesn&#39;t feel much different from anything else
-in order for combat to be interesting, the author needs to ensure that the consequences of the offered choices could reasonably be deduced by the player ahead of time such that you don&#39;t run into those frustrating &#39;swing sword -&gt; obviously that means you catch your arm on a rock and the dragon eats you&#39; situations that leave the player feeling powerless and the game mechanics arbitrary.

2. RPG style turn-based combat with uniform set of actions and usual conditions for victory e.g. enemy or player runs out of HP.  In this case the choice set would be uniform and act as the combat interface.
Pros:
-player is more in control
-the system supports interesting combat and doesn&#39;t require as much setup and forethought by the author
Cons:
-relatively difficult to implement
-may leave combat less &#39;storied&#39; if sufficient wrapping narrative is not provided

-Rooms:
--Frosted Forest[
	---Atrium Glade{
		1. Nuvi
		2. Sprig of Holly
	}
	---Christmas Pines{
	}
	---Frigid Mirror Lake{
	}
	---Cozy Bear Den{
	}
	---Silent Stillness{
	}
	---Crystal Palace{
	}
	---Snow Fort{
	}
	---Sleigh Ride{
		1. Pulled by walri
	}
	---Wooly Mammoth Ride{
	}
	
]
--Badger Maze
--Arborial Spider Web City
--Salamander Volcano
--Unicorn Plains
--Siren Grotto
--Nymph Willows: shade and privacy!
--Dryad Groves
--Primordial Booze: alcohol concentration where inhibitions are least and creative forces amongst the greatest.  Many small gods are popping up here, and obviously removing the booze is not an acceptable solution to control the situation.
--Howling Caverns
--Vampire McMansions
--Grand Rabbit Hutch
--Wombat Warren
--God Generators (thought/emotion extremes themed)[
1. Weeping Waterfall
2. Furious Furnace
3. Blissful Blossoms
]


-Objects:
--Treeminals
--Onyx eyes
--Staff of Creation: said to be a limb of the First Tree...
--Sprig of Holly: focus for imagination due to its strong association with being a divine focus in lore.  Also, it has actually become a divine focus for the blossoming dryad goddess Holly for the same reason!  And yes, the name collision is confusing. 

-Characters:
--Nuvi the flying otter guide: player&#39;s guide through their adventure.  Swims through the air via gravity assist of some sort; wings are slightly for precision maneuvers and mostly for show.  He is very dapper and proper, and he worries about the human&#39;s safety.  His opinion re: the godlings is that they&#39;re rampant growth has to be checked for the good of all, but that new lifeforms should be allowed to thrive.
--Shimmerin the faerie princess: she is a trickster among tricksters and wishes to revive the faerie courts so that faeries can act freely in Fuzziolump as they once did.  To do this, she will need the power of the First Summer Queen&#39;s tiara.  The treasure hoard of the faeries is cursed to only allow those with hearts as pure as a mole&#39;s to touch it, and hers is darkened by bitterness.  She tempts the human to follow her in hopes that they can either touch the treasure themselves or manipulate an ice mole into doing it for them.  Since she wants to see the current Fuzziolump regime fall, she is secretly in favor of the godling revolution and will subtley hinder the human on their quest to stop it.  Despite her somewhat dark agenda, she is friendly by default and enjoys joking with comrades.  The human fascinates her, and she is constantly tryint to learn more about humanity.  She is good at heart and can be redeemed once her secret is out, so long as the human is amenable to revisiting the status of faeries in Fuzziolump with the council.  Else, she will fight the human when the truth comes out. She has a limited ability to grant wishes, in exchange for dreams; if the player allows her to eat some number of their dreams, Shimmerin can work wonders like curative magic which is otherwise very rare.  She presents this exchange as giving her creative inspiration, which it does, which she can use to power the godlings, but it also gives her footholds into the player&#39;s psyche.  The more she has, the more difficult she will be to resist when the truth comes out.
--Woolliam the tenacious wombat: gentle, kind, and determined, Woolliam insists on accompanying the human to help in quelling the growing godling threat, despite the wombat elder&#39;s refusal.  He wants to protect those in his humble sphere of influence and believes he cannot do so without venturing outside the warren.  He will follow the player as stealthily as a wombat can (not very) and provide random assistance.  Despite his brave attempts to help, he is actually pathologically shy and has great difficulty dealing with anyone.  Shimmerin delights in tormenting him. 
--Puck the spirit of ivy: clingy spirit obsessed with Holly; she does not comprehend his feelings, and is amused by his attentions.  She encourages/teases him without understanding the cruelty of these actions.  He wants to see her continue to ascend no matter what the cost, and will fight to the death if he feels she is being threatened.
--Holly the wild goddess (godling): godling of nature and wild things who has gained much perspective from being in many places at once, and has also lost a fair bit from the vantage of lesser beings (e.g. empathy with Puck).  She adores all living things and wants to be sweet and gentle with them; her unpredictable temper makes this difficult, however, and her connection to so many imaginations is making her grow faster than any godling.  Even if she realized the danger she poses to those living things around her by her growth she likely could not stop herself without help. 

-Storyboard:
1. human goes through the dryer to the snowy glade and meets Mr. Tumn-- er Nuvi or whoever, the flying otter guide.  Otter explains somewhat about Fuzziolump and what the human should be doing there. EXPOSITION!

2. nuvi explains the problem they&#39;re having with pesky gods being born, and says that a consensus was reached by the animal council (insert animal themed council pun here) that a human creative should be brought in to help figure out how to slow and undo some of the creativity flying around.

2.1 a faerie is encountered in the bejeweled pines room of the frosted forest, and the player can optionally chase after her to get her in the party as a side quest.

3. first step on that journey is heading to the council so they can give more information on particularly troubling developments and decide which the human should address first.  The council resides in the Wombat Warren which is located north of the Frosted Forest in which the Atrium Glade resides.  The human must travel North through the Frosted Forest until the trees thin and the snows disappear, and the ecosystem suddenly changes to a warm savannah called the Bush.  There they will start to see holes everyplace, and Nuvi will inform the human that these all lead to the Wombat Warren.  

/*
However, some also travel to private dens, so the human must find public tunnels; this requires a wombat&#39;s sense.  Lacking same, the human must try and fail until patterns indicating private tunnels are noted in the individual tunnel descriptions.  The tunnel descriptions should show up randomly, and each failure tosses the human back to the edge of the Bush; this way they actually need to either get lucky or recognize the signs and pass over private burrows until they come randomly to one that does not fit the private bill, which will be a public tunnel.
*/
What Wombats Want: However, most tunnels also pass by or even through private dens so the human must figure out what each wombat family they encounter wants in exchange for passage.  This will be hinted at in the descriptions of the dens, and some wombats may &quot;help&quot; with riddles. 

4. once inside the Wombat Warren, the human meets the animal council.  They inform human that Holly is the first god to approach, since she is growing like many, many weeds and is relatively amiable.  The main question is how the human should go about regressing or at least controlling the creativity that is driving her growth; the human has several choices for how to approach this [choice]{
a. violence (find vital module if possible, cut it out) [effect: nuvi aff -5, council aff +1]
b. hug it out (try to convince her that her wild growth is becoming deleterious to her fellow &#39;lumpkins) [effect: nvi aff +3, council aff: -1]
c. prune (find out what imagination and emotion specifically fuels Holly, and find a way to limit her supply to the tune of reducing her expanse to a steady state -- halting her growth rather than reversing it) [effect: Nuvi aff +5, council aff: +3]
d. dig up the root (find out what imagination and emotion specifically fuels Holly, and find a way to starve her of same until she wilts) [effect: Nuvi aff -10,  council aff: -5]

5. Having decided on a strategy, the human exits the Wombat Warren and heads towards the Blissful Blossoms forest to the West, where Holly makes her home.  On the way, the human is challenged by Puck, a pesky small god of the wind who listens to secrets and overheard the planning session with the council; he is in love with Holly, and will not hear of any suppression of her growth.  He fights the human!  
}

Demo Scope{
 x-intro meeting Nuvi and with basic Fuzziolump setting description
 x-optional shimmerin maze
 -character drawer (persistent link in the sidebar that opens a sliding drawer with character names in the party, so player can talk to them on-demand.  Inductive bias and current location will be taken into account in their responses)
 -inventory drawer (persistent link in the sidebar that opens a sliding drawer with item names in the inventory, allowing player to apply various actions [use, examine] to each item)
 -travel to Wombat Warrens and entry puzzle
 -discussion about gods and how to prune them with council
 -combat with Puck
}

// todox: why is the human needed?  while we&#39;re expositioning, we might as well make it clear how/why the lumpkins expect a human to be able to solve these problems better than them.  Maybe all lumpkins are Sorcerers (born with limited set of inherent magic talents) and humans in Fuzziolump are Wizards due to progenitor position leverage (can learn any magic)?  And there was once one lumpkin with a talent that could potentially slay these godlings (like unmaking imagination sort of thing, voidmancer) and he kept a grimoire that a Wizard could actually learn from.

// todox: The Choice: the human gets to choose an approach for taking on Holly that will shape the story&#39;s progression from this point and massively impact how the council and Nuvi think of the human.
1. Total war: kill every last vestige of Holly &#39;til nothing is left, using Adrammalocke&#39;s grimoire
2. Surgical Strike: terminate the feedback loop, and maybe hope it returns the Holly to her old lumpkin-y self instead of killing her horribly
3. Diplomancy: come up with a new way to reach Holly beyond simply talking to some leaf node of her</tw-passagedata><tw-passagedata pid="20" name="Atrium_Glade_Wings_Compliment_Nuvi" tags="nuvi character_dev affinities" position="468,358" size="100,100">&quot;Why thank you, human!  They help me execute precise maneuvers in the air, but other than that they&#39;re mostly for show -- I fly by lessening the effect of gravity on myself with _&lt;todo: some wordplay on mana/magic&gt;&quot;  He zooms around your head, swimming through the air without flapping his wings to demonstrate.

[[Exit Conversation-&gt;Atrium Glade]]</tw-passagedata><tw-passagedata pid="21" name="Atrium_Glade_Foliage" tags="" position="518,497" size="100,100">You examine the nearest frosted greenery, a holly bush whose bright red berries contrast beautifully with the pure white snow.  Brushing a hand over the bush idly, you jump higher than you thought possible when one of its branches extends creakily and a sprig reaches out to pat you right back.  As if taken aback and perhaps chagrined by your startled reaction, the branch withdraws shyly, and the [[sprig of holly]] flutters gently to the ground. </tw-passagedata><tw-passagedata pid="22" name="sprig of holly" tags="" position="518,647" size="100,100">todo: add the sprig of holly to the inventory; this will help the player with Holly later</tw-passagedata><tw-passagedata pid="23" name="Test Arena" tags="dev test" position="723,627" size="100,100">&lt;&lt;script&gt;&gt;
//var combatPassage = Story.get(&quot;CombatArena&quot;);
//combatPassage.prototype.testField = &quot;helloarena&quot;;
//Would need to modify the prototype of Passage itself
&lt;&lt;/script&gt;&gt;
&lt;&lt;set $npcs to {
	&quot;Ralph&quot;		: {name: &quot;Ralph&quot;, hp: 10, inventory:[]},
	&quot;Jane&quot;		: {name: &quot;Jane&quot;, hp: 10, inventory:[]}
}&gt;&gt;

&lt;&lt;set $player = {name: &quot;Playername&quot;, hp: 10, inventory:[&quot;key&quot;, &quot;sword&quot;]}&gt;&gt;

&lt;&lt;set $village = []&gt;&gt;
&lt;&lt;set $village.push(&quot;Ralph&quot;)&gt;&gt;	/% ralph is placed in the village %/

Ralph&#39;s HP: &lt;&lt;= $npcs[&quot;Ralph&quot;].hp&gt;&gt;

First Village&#39;s HP: &lt;&lt;= $npcs[$village[0]].hp&gt;&gt;
&lt;&lt;set $combat to {
	&quot;player&quot;		: {name: &quot;Ralph&quot;, hp: 10, inventory:[], toString(){
			return &quot;Name: &quot;+this.name+&quot;, HP: &quot;+this.hp+&quot;, inv: &quot;+this.inventory;
		}
	},
	&quot;enemy&quot;		: {name: &quot;Jane&quot;, hp: 10, inventory:[]}
}&gt;&gt;
[[&quot;Try your luck in the combat arena!&quot;-&gt;CombatArena]]</tw-passagedata><tw-passagedata pid="24" name="CombatArena" tags="" position="881,624" size="100,100">&lt;&lt;script&gt;&gt;
/*
//alert(&quot;Current Passage is &quot;+passage());
//alert(&quot;visited CombatArena: &quot;+hasVisited(passage()));
var combatPassage = Story.get(passage());//Story.get(&quot;CombatArena&quot;);
Passage.prototype.testField = &quot;&quot;
Passage.prototype.testMethod = function() {
    return this.testField;
}
combatPassage.testField = &quot;test&quot;
alert(combatPassage.testMethod());
*/
/*
var myCombat = new Combat();
myCombat.name = &quot;The battle of impossible love!&quot;;
alert(&quot;Watch as the wind and warriors rage as one in: &quot;+myCombat.getName());
*/
State.variables.combat[&quot;player&quot;].inventory[0] = &quot;Rusty Jagged Sword&quot;
alert(&quot;Player is &quot;+State.variables.combat[&quot;player&quot;]);
&lt;&lt;/script&gt;&gt;
</tw-passagedata><tw-passagedata pid="25" name="CombatDef" tags="dev testing" position="854,489" size="100,100">&lt;&lt;script&gt;&gt;
alert(&quot;inside CombatDef&quot;);
// todo: I&#39;m getting Combat not defined and the alert is showing, so I guess the scope of this js is the script blocks?
function Combat(){
	this.name = &quot;&quot;;
};
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;
alert(&quot;inside CombatDef second block&quot;);
// throws Combat undefined error; js inside script blocks must have script block scope
var myCombat = new Combat();
myCombat.name = &quot;testCombat&quot;;
alert(&quot;combat name is &quot;+myCombat.name);
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="26" name="CombatReady" tags="dev testing" position="1353,806" size="100,100">&lt;&lt;script&gt;&gt;
variables().ehp = 200;
variables().eatkname = &quot;MOTHERF*CKING FIRE&quot;;
&lt;&lt;/script&gt;&gt;
[[&quot;Fight the Mighty Dragon!&quot;-&gt;DragonFight][$ehp to 400, $eatkname = &quot;fire&quot;]]</tw-passagedata><tw-passagedata pid="27" name="DragonFight" tags="" position="1361,949" size="100,100">&lt;&lt;script&gt;&gt;
alert(&quot;ehp is &quot;+State.variables.ehp);
alert(&quot;eatk is &quot;+State.variables.eatkname);
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="28" name="Fuzziolump_Main_Quest_Desc" tags="desc conversation quest main_quest" position="2,673" size="100,100">&quot;Ah yes, our great need.  You see, Fuzziolump has long been a place of peace for the most part, but recently there has been an upwelling of violence and turmoil.  The cause is our gods.  

We didn&#39;t have any at first.  The fully mortal lumpkins are quite complex enough, and even with the vast sum of Earth&#39;s imaginings it took ages for us to develop.  Several centuries have passed since we grew smart enough to start recording our history, and it seems the more we wrote and thought and felt the experiences of life, the faster Fuzziolump grew.  Its own denizens&#39; imaginings fuel it in addition to Earth&#39;s pool of creative energy, and this exponentiation has led to more potent lifeforms.  Effectively, gods.

Now, this might be cause for celebration -- a whole new category of sapient life, more deeply sapient than any of us can fathom!  Unfortunately, power and depth of mind do not equate to wisdom.  The young gods of Fuzziolump are all very different, but their common trait is an understandable lack of experience combined with an unprecedented ability to influence the world around them.  Some have even learned to syphon off the creative energy Fuzziolump thrives on, and threaten to collapse this world in on itself.  It isn&#39;t clear what would happen the gods if this world perished, but I and my loved ones and millions more like us would surely be snuffed out like the humble little candle flames we are.  I cannot allow that to happen.

//todo: refresh page on click here?  I don&#39;t necessarily want a new passage, but I don&#39;t want the text wall to go on forever either

What to do though?  Every lumpkin knows that Earth and humanity are our progenitors, specifically your creativity.  So, it only seemed reasonable to bring a human creative here to help untanlge this little knot of divinity.  You create every day -- [[you must know-&gt;Wombat_Warren_Reveal]] how to turn that power off, or keep it under control?&quot;</tw-passagedata><tw-passagedata pid="29" name="Wombat_Warren_Reveal" tags="quest main_quest" position="2,823" size="100,100">&quot;Is that not really a thing you humans do?  Well, I&#39;m sure you&#39;ll figure something out!  Anyways, we need to present you to the Animal Council and discuss with them how to proceed.  We&#39;ll find them [[North-&gt;Bejeweled_Pines]] of the Frosted Forest (in which you stand currently), in the sandy savannah of the Wombat Warren.&quot;</tw-passagedata><tw-passagedata pid="30" name="Bejeweled_Pines" tags="room frosty_forest" position="2,973" size="100,100">&lt;&lt;if visited() == 1&gt;&gt;
Nuvi flaps off northward a short span, then pauses as he notes you are not beside him.  Looking back and flashing a reassuring and whiskery grin, he proffers a fuzzy little paw to you.  Squaring your shoulders with purpose, you gently take the soft paw and allow the otter to lead you through the hidden paths in the thick snow-blanketed verge.  

After some stumbling and a small labyrinth of green and whit, he leads you to
&lt;&lt;else&gt;&gt;
You stand amongst
&lt;&lt;/if&gt;&gt;
a dazzling array of colors: the trees here are no less dusted with snow than their fellows you just pushed through, but they have also been festooned with crystal and glass baubles of every conceivable hue.  [[Little soft-glowing lights-&gt;Faery_Desc]] flit from ornament to ornament, keeping the emphasis and shading dynamic.

&quot;A small tree effigy fell into this forest long ago, decorated in a similar manner. The trees here were so smitten by the style they demanded to be honored with comparable shinies and lights.  The [[dryads-&gt;Dryad_Desc]] felt abashed that trees elsewhere were so honored, and strove to worship their charges fittingly.  Unluckily for the glass-blowers and enterprising faeries, the trend did not catch on elsewhere in the forest.&quot;

Nuvi flaps down close your ear, his whiskers tickling, and he whispers,  &quot;The other trees consider these ones a bit gaudy.&quot;  He holds a little paw over his mouth to stifle his giggles.  When his hearty laughter knocks his monocle off, he sobers quickly.  Alighting by your foot to retrieve it, he clears his throat and asks, &quot;Shall we [[continue North to the plains?-&gt;Bush]]&quot;</tw-passagedata><tw-passagedata pid="31" name="Faery_Desc" tags="creature lumpkin description" position="170,1045" size="100,100">Peering closely at the nearest bobbing lights, you note that at the center of each little sphere is a diminutive woman (you guess about 6cm in height) with six dragonfly wings. 

&quot;Those are faeries,&quot; Nuvi informs you, &quot;whimsical little beauties with insatiable curiosity.  They trade their light for secrets, whispered by the woods; little goes on anywhere nearby that isn&#39;t witnessed by the trees.&quot;

Each faery&#39;s wings are different colors, like intricate stained glass.  As you watch, a faery winks at you and performs a graceful series of barrel rolls while the colors of her wings shift and the soft lilac light pulsing off her skin twinkles to produce a mesmerizing chromatic metamorphosis.  She giggles at your awed expression, and [[zooms off out of sight-&gt;Faery_Friend]].</tw-passagedata><tw-passagedata pid="32" name="Dryad_Desc" tags="description lumpkin creature" position="164,901" size="100,100">&quot;Dryads are the keepers of the woods.  They tend the trees, guide their growth, and defend them ferosciously.&quot;  Nuvi points a small claw toward a strange pattern along the bark of a nearby willow, and you realize a feminine face is looking back at you!  Wood creaks softly as she leans out from the tree to watch you passing.  Now that she has separated herself from the bark somewhat, you can see that a large assortment of the glitz you had taken for light cast by the tree&#39;s copious ornaments is actually jewelry.  A gleaming tiara adorns the mane of gossamer vines, leaves, and spider silk that form her waist-length hair.

&quot;They don&#39;t usually go in for all that finery, but the bejeweled dryads have as curious a sense of style as their trees.&quot;</tw-passagedata><tw-passagedata pid="33" name="Faery_Friend" tags="party_mod character shimmerin" position="565,1151" size="100,100">/*
This quest is entirely optional, and allows the player to add Shimmerin the faery to their party.  She will be useful in solving puzzles and in combat, but is not required.
*/
Nuvi hovers patiently nearby as you dart off after the faery.  She&#39;s waiting for you on the far side of the tree, and as soon as she confirms you are following her she winks cheerily and disappears into the surrounding foliage.  She seems to want you to [[chase her-&gt;Shimmerin_Chase_Ghostly_Greeting_Chamber]], but Nuvi is waiting [[back amongst the bejeweled pines-&gt;Bejeweled_Pines]].</tw-passagedata><tw-passagedata pid="34" name="Shimmerin_Chase_Ghostly_Greeting_Chamber" tags="shimmerin party_mod character quest room" position="593,1404" size="100,100">&lt;&lt;silently&gt;&gt;
hypothermia processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;set $characters[&quot;player&quot;].cold_count++&gt;&gt;
&lt;&lt;if $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count&gt;&gt;
	An icy fist grips your heart, and exhaustion makes your limbs feel like lead.  You cannot summon the will to continue chasing your faery friend, and instead lie down in the cold, pitiless snow for a [[loooooooooong nap-&gt;player_death]].
&lt;&lt;elseif $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count/2&gt;&gt;
	Your breaths turn to wheezes, and rime coats your flesh as the cold wriggles in.
&lt;&lt;else&gt;&gt;

&lt;&lt;if visited() == 1&gt;&gt;
Crashing through the frosted pines as gracefully as possible for a fully grown human following a faery no larger than your little finger, you chase after the elusive sphere of lilac light.  Luckily, she&#39;s waiting just at the edge of the current clearing every time you make it through an obstacle blocking line of sight to her.  However, she has veered off in many different directions and you&#39;ve lost track of where you are relative to the Bejeweled Pines and Nuvi.
&lt;&lt;else&gt;&gt;
&lt;&lt;silently&gt;&gt;
// We only want the mole to be processed if this is not the first time in the room, since the player starts here and we want to at least potentially show the mole mechanic with the rooms to the E and S
&lt;&lt;/silently&gt;&gt;
&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole discovered!  He burrows hastily away from the human in &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.burrow()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s burrowing brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground&quot;&gt;&gt;
	&lt;&lt;run $anicemole.advance()&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;
You stand in the center of what was once a grand antechamber, for certain values of grand: everything, from the fallen grandiose pillars to the rime-encrusted iron skeletons of elaborate furniture is miniature scale relative to you.  It feels a bit like walking into a dollhouse store that a ruination of weather and time have trampled to ghostly memories. 

The faery giggles and flits off through a [[close copse of pines to the East-&gt;Shimmerin_Chase_Frozen_Stair]], leaving a sprinkle of powder in her wake. There is an [[old and sturdy rope-&gt;Shimmerin_Chase_Diamond_Throneroom]] hanging over a small cliff to the South.  Away West, a collapsed archway leads to a subtley sunken glade that may once have been a [[gallery of sorts-&gt;Shimmerin_Chase_Treasure_Of_Stillness]].

&lt;&lt;if $rollPercentage &gt;= 75&gt;&gt;
	You can hear a faint whisper on the wind, &quot;Human!  Huuuuuuuman!&quot;.  It sounds vaguely dapper and certainly whiskery, so you deduce it is likely Nuvi looking for you.  You could choose to [[follow the voice if you&#39;re done playing with the faery.-&gt;Bejeweled_Pines]]
&lt;&lt;/if&gt;&gt;


//todox: our first game element!  Surprise, surprise, it&#39;s a maze.  I don&#39;t want it to be a bunch of twisty passages all alike though; the player doesn&#39;t have enough inventory junk for that yet.  Plus those kinda suck.  There should be clear landmarks in the maze, allowing the player to actually learn and traverse it without making their own landmarks out of dropped items, BUT these landmarks should ideally shift as time goes by such that they really only exist as patterns of landscape.  That way the player has to recognize the patterns as a simple puzzle in order to navigate the maze. Shimmerin may alter things and leave false clues as well. 

// The simplest way to do something like the above would probably be to have a prefab maze in mind, and then randomly/conditionally change little bits of the descripter text for each room, and each room could be implemented as a prefab passage in Twine.  So draw that maze first!

//todo: make the mole go CC when player is already in the room when it arrives.  Also make sure the mole&#39;s direction of burrowing is clear so that this doesn&#39;t turn into another Rilix Castle situation that can&#39;t be solved without already knowing the map.



&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="35" name="test_party_array" tags="test dev" position="1468,1047" size="100,100">The starting party is: &lt;&lt;print $party&gt;&gt;, and after adding TestFriend 
&lt;&lt;script&gt;&gt;
State.variables.party.push(&quot;TestFriend&quot;);
&lt;&lt;/script&gt;&gt;
it is &lt;&lt;print $party&gt;&gt;

&lt;&lt;script&gt;&gt;
variables().party[0].name = &quot;Testy McTestFace&quot;;
alert(&quot;Player is &quot;+variables().party[0].name+&quot; whose CHA is &quot;+variables().party[0].attributes[&quot;charisma&quot;]);
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="36" name="Shimmerin_Chase_Frozen_Stair" tags="shimmerin party_mod character quest room" position="728,1421" size="100,100">&lt;&lt;silently&gt;&gt;
hypothermia processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;set $characters[&quot;player&quot;].cold_count++&gt;&gt;
&lt;&lt;if $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count&gt;&gt;
	An icy fist grips your heart, and exhaustion makes your limbs feel like lead.  You cannot summon the will to continue chasing your faery friend, and instead lie down in the cold, pitiless snow for a [[loooooooooong nap-&gt;player_death]].
&lt;&lt;elseif $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count/2&gt;&gt;
	Your breaths turn to wheezes, and rime coats your flesh as the cold wriggles in.
&lt;&lt;else&gt;&gt;

&lt;&lt;silently&gt;&gt;
//anicemole processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole discovered!  He burrows with haste out of &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.burrow()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s burrowing brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	An ice mole (who is, incidentally, a nice mole) is sniffing at the few valiant flowers poking up through the snow.  When he senses your approach he bellows with a mighty voice that would make a hippopotamus proud, and then dives into the ground just to the side of the marble tile like a breaching porpoise.  Tile cracks and rises for a few yards on a distinctly Southwest heading.
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  His position before advance is &quot;+$anicemole.ice_mole_room&gt;&gt;
	&lt;&lt;run $anicemole.advance()&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  He snuffled off to &quot;+$anicemole.ice_mole_room&gt;&gt;
	
	&lt;&lt;silently&gt;&gt;
	Need to check if mole has wandered into the room the human is currently in, and process his retreat
	&lt;&lt;/silently&gt;&gt;
	
	&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole has discovered the human!  He retreats from &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.retreat()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s retreat brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	
	An ice mole slides in on his belly like (?) the most elegant figure skater you&#39;ve ever seen from the Northwest.  When he sees you, his fur stands on end and he jumps three feet in the air, and then flees back the way he came.
	&lt;&lt;/if&gt;&gt;
	
&lt;&lt;/if&gt;&gt;

Carefully hewn marble shows through the blanket of ice and snow, giving the area a feeling of patchy oppulence.  Much of the remaining stonework seems to be ornamental -- a great deal of work seems to have gone into framing the large and once-grandiose sweeping staircase that leads down into a small valley surrounded by icy cliffs.  Gold leaf on every stair adds a curious flair to the shine of sunlight off the slippery rime that flows like a runner carpet all the way down.

&lt;&lt;if not $party.includes($character_shimmerin)&gt;&gt;
You can see your fairy quarry&#39;s lilac glow disappearing down the stairs. 
&lt;&lt;/if&gt;&gt;

&lt;&lt;if typeof $field_mods_map.get(passage()) != &#39;undefined&#39;&gt;&gt;
	&lt;&lt;if $field_mods_map.get(passage()).includes($field_mod_anicemole_burrowed)&gt;&gt;
		  A spray of dirt from the mole hole mars the otherwise pristine marble tile.
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;


[[You can climb (carefully!) the frozen steps down Southwest into the little vale.-&gt;Shimmerin_Chase_Diamond_Throneroom]]  Up a little curving path [[Northwest you can just make out oddly cultivated-looking shards of colorful crystal.-&gt;Shimmerin_Chase_Crystal_Gardens]]  Through a close copse of snowy pines to the [[West you can see hints of fallen grandeur.-&gt;Shimmerin_Chase_Ghostly_Greeting_Chamber]]

&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="37" name="Shimmerin_Chase_Diamond_Throneroom" tags="shimmerin party_mod character quest room" position="581,1598" size="100,100">&lt;&lt;silently&gt;&gt;
hypothermia processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;set $characters[&quot;player&quot;].cold_count++&gt;&gt;
&lt;&lt;if $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count&gt;&gt;
	An icy fist grips your heart, and exhaustion makes your limbs feel like lead.  You cannot summon the will to continue chasing your faery friend, and instead lie down in the cold, pitiless snow for a [[loooooooooong nap-&gt;player_death]].
&lt;&lt;elseif $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count/2&gt;&gt;
	Your breaths turn to wheezes, and rime coats your flesh as the cold wriggles in.
&lt;&lt;else&gt;&gt;

&lt;&lt;silently&gt;&gt;
//anicemole processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole discovered!  He burrows with haste out of &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.burrow()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s burrowing brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	An ice mole licks the frozen waterfall gingerly, as if giving it a friendly kiss.  Or perhaps more than friendly.  When he hears you tromping through the crunchy snows, he tunnels away Northwest directly into the ice and has been replaced by a mole hole in the blink of an eye.
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  His position before advance is &quot;+$anicemole.ice_mole_room&gt;&gt;
	&lt;&lt;run $anicemole.advance()&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  He snuffled off to &quot;+$anicemole.ice_mole_room&gt;&gt;
	
	&lt;&lt;silently&gt;&gt;
	Need to check if mole has wandered into the room the human is currently in, and process his retreat
	&lt;&lt;/silently&gt;&gt;
	
	&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole has discovered the human!  He retreats from &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.retreat()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s retreat brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	
	An ice mole shimmies down from the Northeast over the frozen staircase, managing the steps with more dignity than any quadraped ever managed steps before (you&#39;re certain).  When he sees you, his fur stands on end and he jumps three feet in the air, and then flees back the way he came.
	&lt;&lt;/if&gt;&gt;
	
&lt;&lt;/if&gt;&gt;

You stand in a small valley surrounded by sheer cliffs of slick sapphire ice and unforgiving slate-gray stone.  The remains of graduated curved stone benches step down in a hemisphere around a clearing below and infrastructure that reminds you of the retractable roofing in fancier outdoor theatres peeks out from snow drifts here and there.  Down at the center of the declining rows of benches is a large marble dais, upon which proudly stands the most enormously overwrought chair you&#39;ve ever seen -- truly a throne.  It is majestic and imperious, with impossibly intricate and delicate gossamer weaves of crystals and gems decorating its broad frame; the morning light shining through their many hues blankets the dais in a constant rainbow corona.  The dais abutts a massive waterfall, all its roaring might condensed into a single moment frozen forever in time.  And ice.  A chill wind kisses your cheek and you shiver, feeling profoundly alone. 

&lt;&lt;if not $party.includes($character_shimmerin)&gt;&gt;
A distant lilac glow flickers with a cadence quite like giggling laughter as it dances about the waterfall&#39;s massive tusk and claw-like iceicles.  When you reach the waterfall she is already gone. 
&lt;&lt;/if&gt;&gt;

&lt;&lt;if typeof $field_mods_map.get(passage()) != &#39;undefined&#39;&gt;&gt;
	&lt;&lt;if $field_mods_map.get(passage()).includes($field_mod_anicemole_burrowed)&gt;&gt;
		At the base of the frozen waterfall is a hole, roughly the size of a large mole.  An ice mole burrowed away from you through it.
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

[[The stairs lead up Northeast and away from the lonely throne-&gt;Shimmerin_Chase_Frozen_Stair]]
[[Directly North, hanging over the ancient little throne, is the fraying end of a sturdy rope-&gt;Shimmerin_Chase_Ghostly_Greeting_Chamber]] 

&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="38" name="Shimmerin_Chase_Treasure_Of_Stillness" tags="shimmerin character quest party_mod room" position="422,1426" size="100,100">&lt;&lt;silently&gt;&gt;
hypothermia processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;set $characters[&quot;player&quot;].cold_count++&gt;&gt;
&lt;&lt;if $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count&gt;&gt;
	An icy fist grips your heart, and exhaustion makes your limbs feel like lead.  You cannot summon the will to continue chasing your faery friend, and instead lie down in the cold, pitiless snow for a [[loooooooooong nap-&gt;player_death]].
&lt;&lt;elseif $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count/2&gt;&gt;
	Your breaths turn to wheezes, and rime coats your flesh as the cold wriggles in.
&lt;&lt;else&gt;&gt;

&lt;&lt;silently&gt;&gt;
//anicemole processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole discovered!  He burrows with haste out of &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.burrow()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s burrowing brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	An ice mole patiently shovels snow with his great digging claws, to no particular purpose you can see.  His earnest little brow is furrowed, however, so you imagine he must have important duties here.  When he catches your scent on the wind, he abandons his shoveling and burrows away in a shower of glittering ice chips.  The tinkling of disturbed gold and gemstones showering over one another fades out to the Northeast.
	
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  His position before advance is &quot;+$anicemole.ice_mole_room&gt;&gt;
	&lt;&lt;run $anicemole.advance()&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  He snuffled off to &quot;+$anicemole.ice_mole_room&gt;&gt;
	
	&lt;&lt;silently&gt;&gt;
	Need to check if mole has wandered into the room the human is currently in, and process his retreat
	&lt;&lt;/silently&gt;&gt;
	
	&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole has discovered the human!  He retreats from &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.retreat()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s retreat brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	
	An ice mole snuffles in amongst the treasures from the Southeast, ignoring the sparklies and evidently intent on some secret quest.  When he sees you, his fur stands on end and he jumps three feet in the air, and then flees back the way he came.
	&lt;&lt;/if&gt;&gt;
	
&lt;&lt;/if&gt;&gt;

Heaps of gold coins and gemstones lay scattered about in the snow and ice.  The coins show significant patina and undisturbed drifts blanket much of the hoard, suggesting that it has been here for some time.  As you ogle the goodies, you imagine you can hear it calling out to you, begging to be scooped up and appreciated.  Notably, several humanoid bones are interspersed with the treasures.  The air here is alarmingly still, as if the very world holds its breath. 

&lt;&lt;if not $party.includes($character_shimmerin)&gt;&gt;
You see no sign of your fairy friend here; seems she didn&#39;t wish to linger. 
&lt;&lt;/if&gt;&gt;

&lt;&lt;if typeof $field_mods_map.get(passage()) != &#39;undefined&#39;&gt;&gt;
	&lt;&lt;if $field_mods_map.get(passage()).includes($field_mod_anicemole_burrowed)&gt;&gt;
		Scattered about the mole hole are several exciting shinies: a large emerald carved in the likeness of a winking fairy, which pulses gently with a soft verdant radiance; a needle-sized sword that gleams whiter than the fresh snow, its brightness searing an impression behind your eyes; a shimmering midnight blue dress, with skirts divided for riding, that fits in the palm of your hand.  
	&lt;&lt;if not $characters[&quot;player&quot;].inventory.includes(State.variables.summer_court_tiara)&gt;&gt;
		The main point of interest, however, is the &lt;&lt;click 
	&quot;tiny jewel-encrusted tiara which seems to be calling to you with a sensual humming.&quot;&gt;&gt;
		&lt;&lt;script&gt;&gt;State.variables.characters[&quot;player&quot;].inventory.push(State.variables.summer_court_tiara); state.display(state.active.title, null, &quot;back&quot;);&lt;&lt;/script&gt;&gt;
		&lt;&lt;/click&gt;&gt;
		
		&lt;&lt;/if&gt;&gt;
	&lt;&lt;else&gt;&gt;
		In addition to all the loose treasure, you can see faint glimmering from within the ice; you note that there may be yet more wonders held prisoner in its frosty grip.
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

// todo: add options for the player to steal surface treasure or enact other mischief and receive a mild rebuke for it (magical shock or similar for mischief, maybe death for stealing... maybe first a shock as warning then death if player doesn&#39;t reverse action) to establish precedent for why faeries couldn&#39;t actively startle the mole and manipulate him into burrowing the tiara out.

Up a gradual incline and over the remains of a once-sturdy gate to the [[Northeast, you can see several oddly pointy bushes glittering in the verdant sunlight. -&gt;Shimmerin_Chase_Crystal_Gardens]]  Down a slightly harsh rockfall (best to slide, but watch your rump!) [[Southeast lies a lonely little frosted valley.-&gt;Shimmerin_Chase_Diamond_Throneroom]]  Up the slope and over the sad ruins of a once fancy archway stand the bases of mighty pillars that once supported a grand antechamber [[East of here.-&gt;Shimmerin_Chase_Ghostly_Greeting_Chamber]]

&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="39" name="Shimmerin_Chase_Crystal_Gardens" tags="shimmerin character party_mod quest room" position="565,1281" size="100,100">&lt;&lt;silently&gt;&gt;
hypothermia processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;set $characters[&quot;player&quot;].cold_count++&gt;&gt;
&lt;&lt;if $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count&gt;&gt;
	An icy fist grips your heart, and exhaustion makes your limbs feel like lead.  You cannot summon the will to continue chasing your faery friend, and instead lie down in the cold, pitiless snow for a [[loooooooooong nap-&gt;player_death]].
&lt;&lt;elseif $characters[&quot;player&quot;].cold_count &gt;= $characters[&quot;player&quot;].cold_max_count/2&gt;&gt;
	Your breaths turn to wheezes, and rime coats your flesh as the cold wriggles in.
&lt;&lt;else&gt;&gt;

&lt;&lt;silently&gt;&gt;
//anicemole processing
&lt;&lt;/silently&gt;&gt;
&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole discovered!  He burrows with haste out of &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.burrow()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s burrowing brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	An ice mole snuffles about busily beneath a huge growth of emeralds in the shape of a towering oak tree.  His giant claws scrape patiently away at the &#39;roots&#39;, hard enough to chip away the stone.  When the mole sees you approaching, he panics and dives beneath the ice and snow at the base of the emerald tree.  His frenzied digging upsets the root system, which is apparently a thing, and the emerald oak comes crashing to the ground, throwing up a mist of powdery snow that glitters in the multi-hued sunlight.  The perfectly rounded tunnel appears to lead Southeast. 
	
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  His position before advance is &quot;+$anicemole.ice_mole_room&gt;&gt;
	&lt;&lt;run $anicemole.advance()&gt;&gt;
	&lt;&lt;print &quot;the mole wanders onward, digging digging deep down underground.  He snuffled off to &quot;+$anicemole.ice_mole_room&gt;&gt;
	
	&lt;&lt;silently&gt;&gt;
	Need to check if mole has wandered into the room the human is currently in, and process his retreat
	&lt;&lt;/silently&gt;&gt;
	
	&lt;&lt;if $anicemole.ice_mole_room is passage()&gt;&gt;
	&lt;&lt;print &quot;mole has discovered the human!  He retreats from &quot;+passage()+&quot;!&quot;&gt;&gt;
	&lt;&lt;run $anicemole.retreat()&gt;&gt;
	&lt;&lt;print &quot;Anice mole&#39;s retreat brings him to &quot;+$anicemole.ice_mole_room+&quot;!&quot;&gt;&gt;
	
	
	An ice mole hops up on a nearby yucca plant carved from solid ruby slightly to the Southwest, assuming the pose of a stalwart caretaker.  When he sees you, his fur stands on end and he jumps three feet in the air, and then flees back the way he came.
	&lt;&lt;/if&gt;&gt;
	
&lt;&lt;/if&gt;&gt;

You stand in a large clearing where someone has apparently cultivated a vast garden of crystals.  Instead of the soft greens of pine and holly, eldritch purples, blues, reds, and every color imaginable (and a few that are like no color you&#39;ve imagined previously) filter the subtle sunlight into spectacular rainbows over you.  The dusting of snow only mutes the effect slightly, pleasantly keeping it mysterious rather than gaudy.  Faeries flit amongst the crystalline horticulture, adding their own colors to the filtered sunlight.  Brushing by an explosion of amethyst that looks a bit lke the leaves of a pineapple, you shy away as a sharp pain stings your arm and a warm rivulet of blood seeps into your clothing -- the verge here is beautiful and deadly. 

Several of the crystals are carved to look like fanciful animals (or, here, regular animals) reading books and wearing stylish clothes.  There are humans too, as well as a few winged humanoids that might be faeries; you note that they are the same size.  The time and care involved in cultivating and pruning crystal topiary boggles your mind. 
As a cool wind ruffles the distant foliage, the crystal garden produces a light tinkling that settles into a deeper resonant hum as the garden vibrates. 

&lt;&lt;if not $party.includes($character_shimmerin)&gt;&gt;
The fairy you&#39;re chasing peeks out from behind a sapphire flower as tall as you.  When she sees you approaching, she winks flirtatiously and blows you a little kiss.  

	&lt;&lt;if $characters[&quot;player&quot;].inventory.includes($summer_court_tiara)&gt;&gt;
		Then, her eyes shift to your pack, which has begun to hum and vibrate softly.  Zooming over in a blur of enthusiasm, the little fairy opens your pack, dives in, and emerges holding reverently the tiny tiara you picked up in the treasure room.
		
		&quot;This... how did you get this?&quot; she asks, breathlessly, her face a mask of astonishment and all pretense of teasing silliness forgotten.  &quot;She&#39;s the Summer Queen&#39;s own tiara, and has been lost to us since the fall of the courts centuries ago.  Everything hears her call, faeries most of all, so we knew she was under the ice amongst the forsaken treasures but no one could get past the treasure&#39;s curse to reach her!&quot;
		// todo: the question should be more how rather than where, since the treasure room is right over there.  I would say the focus should be on the treasure&#39;s curse repelling raiders, and the mole&#39;s pure goodness and innocence making it immune.  As for why the fairy never noticed that, well maybe the mole isn&#39;t frightened of them and/or maybe they don&#39;t have the attention to detail necessary to set up the mole to dig things out for them.
		
		// todo: do we want a conversation here?  It could be done without too too much hassle by setting control vars to manage the passage text here and adding an exit conversation link in the conversation branch passages that comes back here.  Does it serve a purpose, however?  On the one hand, we could force the player&#39;s tongue here and give their truthful answer about the mole which would allow Shimmerin to respond that she never noticed the mole digging frenziedly and/or was unable/unwilling to frighten it.  On the other hand, we could let the player lie or ignore Shimmerin, which would mod her affinity.  We could even give the player a CHA score, which can be influenced by equipment etc, which influences the likelihood of the bluff succeeding.  I guess the main question is: is there a response the player could give that would significantly (i.e. not just slight affinity mod) change something re: Shimmerin in the story going forward?  Eh, I suppose so: maybe Shimmerin decides that the player must be as good-hearted and earnest as a mole and the aff takes a big jump up AND we add &#39;mole-level-good&#39; to her inductive bias re: the player, which could well have important consequences later (e.g. she assumes something that can&#39;t hurt the pure of heart can&#39;t hurt the player, and so doesn&#39;t warn them...)
		
		[[There was this mole...-&gt;Shimmerin_Chase_Crystal_Gardens_Tiara_Mole]]
		[[I had no problem digging up the tiara.  Bit of a tingly sensation while I worked, but that was it.-&gt;Shimmerin_Chase_Crystal_Gardens_Tiara_Self]]
	&lt;&lt;else&gt;&gt;
		Simultaneously, blinding beautiful light explodes from every one of the innumerable crystals in the garden, and when you can see again you see that the little fairy has vanished. 
	&lt;&lt;/if&gt;&gt;
	

&lt;&lt;/if&gt;&gt;

&lt;&lt;if typeof $field_mods_map.get(passage()) != &#39;undefined&#39;&gt;&gt;
	&lt;&lt;if $field_mods_map.get(passage()).includes($field_mod_anicemole_burrowed)&gt;&gt;
		  Emerald shards lay scattered about where the crystal oak fell after the ice mole burrowed away beneath it.
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

The ground slopes downward in a gently meandering curve heading [[Southeast to a large clearing that frames a set of grandiose stairs that descend out of sight.-&gt;Shimmerin_Chase_Frozen_Stair]]  Just over the lip of a once ornate gate to the Southwest you can see a shallow hill with bumps of ice (most likely hiding buried steps) leading down into a [[gallery frozen forever in its final moment of splendor-&gt;Shimmerin_Chase_Treasure_Of_Stillness]].

&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="40" name="Shimmerin_Chase_Crystal_Gardens_Tiara_Mole" tags="conversation shimmerin" position="800,1268" size="100,100">&lt;&lt;set $characters[&quot;player&quot;].affinities[&quot;shimmerin&quot;]++ &gt;&gt;
&lt;&lt;run $characters[&quot;shimmerin&quot;].inductive_bias.push($inductive_bias_clever) &gt;&gt;
&lt;&lt;run $characters[&quot;shimmerin&quot;].inductive_bias.push($inductive_bias_animal_handler) &gt;&gt;

You shrug and explain the situation as best you can, &quot;An ice mole was digging amongst the treasure, and I think I startled it -- it burrowed away in a hurry, scattering ice and buried treasures.  The tiara was one of the treasures revealed around the mole hole.&quot; 

Shimmerin&#39;s eyes brighten and a broad grin lights up her face.  &quot;You were able to get the mole to dig treasure out of the ice?  But he&#39;s so stubborn!  He&#39;s usually too focused on his snow shoveling to do anything else, even when offered treats.  I&#39;m too small for him to take much notice anyway, so I haven&#39;t been able to effectively enlist his services.&quot;  She places the tiara on her head, carefully arranging her auburn locks so that they optimally frame the gorgeous treasure.

[[Furs grow and feathers blow...-&gt;Shimmerin_Chase_Transition_Bejeweled_Pines]]</tw-passagedata><tw-passagedata pid="41" name="Shimmerin_Chase_Crystal_Gardens_Tiara_Self" tags="conversation shimmerin" position="798,1130" size="100,100">&lt;&lt;if $checkAbility($characters[&quot;player&quot;],&quot;charisma&quot;) &gt; 15&gt;&gt;
	The faery&#39;s eyes widen in awe.  &quot;The treasure room only allows the most pure-hearted creatures to shuffle or take from its contents.  You must be a wonderful person!&quot;  She zooms in uncomfortably close to your face and bats her lashes flirtatiously.  &quot;I wanna get to know you -- I&#39;m comin&#39; with!  Name&#39;s Shimmerin, by the by.&quot;  She plunks the tiara down on her head and, blushing, quickly tidies her auburn hair.  Flustered and wearing a sheepish grin, she offers a tiny hand.  You shake as best you can with a waggle of your little finger.
	
	&lt;&lt;set $characters[&quot;player&quot;].affinities[&quot;shimmerin&quot;] += 20&gt;&gt;
	&lt;&lt;run $characters[&quot;shimmerin&quot;].inductive_bias.push($inductive_bias_digger_good)&gt;&gt;
	
&lt;&lt;else&gt;&gt;
	The faery&#39;s brow crinkles skeptically.  &quot;No way.  You&#39;re lying to me!  What kind of person lies to such a cute girl?  Someone trying to manipulate her, that&#39;s what sort of &#39;person&#39;!&quot;  She sticks her tongue out at you, then turns her back and refuses to acknowledge you further.  As you turn to leave, she lands on your shoulder and tweaks your ear painfully. &quot;I&#39;m coming with you.  As an upstanding Lumpkin, I cannot allow a suspicious individual such as yourself to wander my lovely little world unsupervised.  I don&#39;t know or care how you got the Queen&#39;s tiara, but I&#39;ll be keeping her safe.&quot;  She carefully places the tiara on her auburn locks, mussing them in her indignant fervor, then sticks her tongue out at you again. 
	
	&lt;&lt;set $characters[&quot;player&quot;].affinities[&quot;shimmerin&quot;] -= 20&gt;&gt;
	&lt;&lt;run $characters[&quot;shimmerin&quot;].inductive_bias.push($inductive_bias_liar)&gt;&gt;
	&lt;&lt;run $characters[&quot;shimmerin&quot;].inductive_bias.push($inductive_bias_manipulative)&gt;&gt;
	
&lt;&lt;/if&gt;&gt;

[[Furs grow and feathers blow...-&gt;Shimmerin_Chase_Transition_Bejeweled_Pines]]
</tw-passagedata><tw-passagedata pid="42" name="Shimmerin_Chase_Transition_Bejeweled_Pines" tags="transition" position="1085,1193" size="100,100">With a decisive pat of her shapely flank and casual wave of one miniscule ivory arm, Shimmerin leads you [[back to the festive trees and Nuvi-&gt;Bejeweled_Pines]]</tw-passagedata><tw-passagedata pid="43" name="player_death" tags="death game_over" position="1240,1421" size="100,100">It&#39;s a sad thing that your adventures have ended here!</tw-passagedata><tw-passagedata pid="44" name="Bush" tags="room" position="0,1139" size="100,100">As you exit the treeline of the snow-frosted forest, a wave of heat slaps you in the face so tangibly that you actually stumble.  Though snow falls visibly, almost mockingly, not 100 yards to the South, the temperature in the savannah feels closer to boiling.

&quot;Ecosystems work pretty differently here,&quot; Nuvi explains, prompted by your stunned expression.  &quot;They depend more on our collective conception of what a place should be like rather than weather patterns and physics and all that fluff humans are always going on about.&quot;  Despite the heat, your thick-furred companion glides along as serenely as ever.  He hums [[a tune you&#39;re unfamiliar with-&gt;Bush_Tune]].

&quot;We&#39;re coming up on the wombats,&quot; Nuvi intones conspiratorially.  &quot;Now the thing to know about wombats is that they&#39;re diggers through and through.&quot;  He watches you, clearly expecting a nod of understanding or similar sign to indicate that this means something to you.  When none is forthcoming, he elaborates, &quot;Digging creatures have gotta be determined and patient, tough but fair and above all smart and calm, or they won&#39;t make it through their first cave-in.  Keep that in mind when talking with them.&quot;

Innumerable holes dot the landscape like spots on a giraffe, which, incidentally, you can see several of in the distance.

To the West, the Savannah opens up into a vast sea of grasses and roaming wildlife.  A distant craggy mountain range looms in the East.  Several curious whiskered faces are poking up out of the nearest [[hole directly North-&gt;Bush_Wombat_Burrow_1]]. 

</tw-passagedata><tw-passagedata pid="45" name="Bush_Tune" tags="conversation" position="171,1167" size="100,100">todo: silly marching tune with poem lyrics which the otter all-too-gladly expounds upon</tw-passagedata><tw-passagedata pid="46" name="Bush_Wombat_Burrow_1" tags="room" position="0,1289" size="100,100">&lt;&lt;script&gt;&gt;alert(State.variables.wombuddy_score);&lt;&lt;/script&gt;&gt;
/*
todo: the puzzle here is to find the item or perform the service of one of the wombat families to gain passage through their burrow to the warren proper.  The moon logic here is that wombats trust deeply but require that trust to be earned, so the tribute stuff should be more practical than flattering.  Now the tricky part here is that it doesn&#39;t make any damn sense for the wombats to be cryptic about what they need, but at the same time nobody likes a fetch quest.  Probably a fair compromise is to have the wombats simply present a problem they need help with and finding a solution in the world is up to the player.  However, that sounds like a job for after demo, when the world is more expansive.  Maybe for now simply have each present a situation that requires the player to spend resources?

Wombat Family 1: needs help treating their sick elders.  (can be helped either by med. herb from Frosty Forest, or from Shimmerin healing wish)

Wombat Family 2: needs help rescuing a trapped digger from a collapsed tunnel. (can be helped by player physically at the cost of health, or small amount of mana can be expended for a risky teleportation rescue that can fail).

Wombat Family 3: needs to cross a chasm to explore new tunneling territory. (faerie statue can be used for limited flight, or player can spend mana to do same)

Alternatively/additionally, I&#39;d like some kind of wombat digging dungeon angle, maybe a maze or similar challenge to make the human prove they have a wombat&#39;s good sense and sensibilities by way of being at home underground.  A simple and expediant possibility might be for Sheila to simply give the player a series of what-ifs to answer, centered around wombatian ethics and concerns.  The player&#39;s answers will contribute to Sheila&#39;s inductive bias re: player, and will also have a point value that needs to reach some threshold for the human to be named Wombuddy.  The tricky part with this option is failure: if the human doesn&#39;t meet the threshold, what happens?  New what-if scenarios and associated chances to answer are the most obvious recourse other than simple GAME OVER, which is stupid, but that would require generative narrative.  Maybe we could get away with a single set of scenarios, but have Sheila remember and comment if the player needs to basically exhaust all their options.  Since the player&#39;s choices will be canned responses from them, it wouldn&#39;t look to Sheila like the player had simply tried every choice combo, but at the same time she would know that the player had to make multiple attempts at coming up with satisfactory answers.  This could go into the persistent inductive bias of both Sheila and Nuvi, and effect events later in the game.

todo: transition text for if the player has left and come back after completing the trials -- &quot;Sheila the wombat&#39;s broad snout appears from nothing, quicker than a flash of lightning over the edge of the tunnel as you approach.&quot;

*/

&lt;&lt;if visited() == 1&gt;&gt;
&quot;A human!&quot; a small voice squeaks, and the whiskered faces disappear down the hole.  You approach slowly, Nuvi in the lead -- being a more familiar sight to them, he can serve as a sort of literally soft transition for the little wombats. 

&quot;Hello gentle wombats!&quot;  Nuvi calls out ahead.  &quot;I&#39;m an agent of the council, escorting a human consultant to help with our little problem.  We&#39;ll need to pass through into the Warren, please and thank you.&quot;

A broad snout covered in a wiry blanket of tawny fur rises above the lip of the hole, a steady brow arched skeptically over glistening black eyes.  A breath of lilacs whispers past as the wombat emerges, so subtle you&#39;re not certain you trust your sniffer. &quot;Human?  To see the council?  The situation must be getting desperate, indeed.&quot;  The wombat levels a stern but fair gaze at you. &quot;Their presence here will accelerate the godlings&#39; growth -- the council realizes that don&#39;t they?&quot;

Nuvi performs a placating barrel roll and responds, &quot;Peace, noble wombat sister.  The council is well aware of the many consequences associated with bringing a human to Fuzziolump, chief among them the imaginative accelerant effect.  It was decided that the risk of accelerating the godlings&#39; expansion was worth taking if it might mean stopping them altogether.  This human is a creative, an expert on generating and, presumably, suppressing creativity.&quot;

The wombat taps her tough leathery nose several times with a mighty digging claw as she considers the otter&#39;s words.  &quot;So they&#39;ve run out of ideas that aren&#39;t dangerous and foolhardy, then?  Fine enough.  However, the warren is a place of wombats and wombuddies, and the only way in leads through our home burrows.  This human will need to prove themselves a wombuddy just like anyone else before they can pass through.&quot;

The stout little wombat turns to you and puffs herself up.  &quot;Are you ready, human, to be [[tested-&gt;Bush_Wombuddy_Test_Quest]]?&quot;
&lt;&lt;else&gt;&gt;
	&lt;&lt;if $characters[&quot;player&quot;].titles.includes($title_wombuddy)&gt;&gt;
		Sheila the wombat&#39;s expression of stoic vigilance breaks into a smile as warm as being enveloped in wombat fur as she recognizes you as a wombuddy.
		
		&quot;[[Come on in-&gt;Bush_Warren]], wombuddy!&quot;
	&lt;&lt;else&gt;&gt;// if player is not a wombuddy
		&lt;&lt;if $wombuddy_trials == 0&gt;&gt;
			The stout little wombat turns to you and puffs herself up.  &quot;Are you ready, human, to be [[tested-&gt;Bush_Wombuddy_Test_Quest]]?&quot;
		&lt;&lt;elseif $wombuddy_trials &lt; 3&gt;&gt;
			&lt;&lt;silently&gt;&gt;
				reset the wombuddy_score since we&#39;re headed into the test quest afresh
			&lt;&lt;/silently&gt;&gt;
			&lt;&lt;set $wombuddy_score = 0&gt;&gt;
			Sheila taps her foot impatiently.  &quot;No, that won&#39;t do.  I&#39;ll give you [[another shot-&gt;Bush_Wombuddy_Test_Quest]].&quot;
		&lt;&lt;else&gt;&gt; // if player has exhausted their trials
			&lt;&lt;run $characters[&quot;player&quot;].titles.push(&quot;unwombatty&quot;)&gt;&gt;
			&lt;&lt;if !$characters[&quot;sheila&quot;].inductive_bias.includes($inductive_bias_crush)&gt;&gt;
				&lt;&lt;if $wombuddy_score &lt; 5&gt;&gt;
					//todo: hmmm... she&#39;s a little psycho here.  Maybe have the default failure dialogue be a little toned down and more disappointed than, like, crazy?  On the other hand, &#39;rabid wombat&#39; was a great Magic card.
					The warren&#39;s fuzzy little keeper throws up her hands in consternation.  &quot;Enough!  You&#39;re not wombat material, and I&#39;m not willing to let you keep trying forever.&quot;  She massages her brow with dusty digging claws for a moment and then eyes you warily.  &quot;All right, I&#39;ve made up my mind.  Since the council already pulled the trigger on risking bringing a human into our midst, I will allow you to enter.  However, I will be watching your every move!  Also, I mandate that you must remain with your escort Nuvi, who is sufficiently wombatty to pass, at all times while within the [[warren tunnels-&gt;Bush_Warren]].&quot;
				&lt;&lt;elseif $wombuddy_score &gt;= 5 &amp;&amp; $wombuddy_score &lt; 10&gt;&gt;
					The warren&#39;s fuzzy little keeper scratches irritably at a ragged ear, then grumbles and kicks a stone.  &quot;That&#39;ll do.  You&#39;re not what I&#39;d call wombatty, human, but I guess you&#39;re good enough for an emergency.  I&#39;m watching you, though.&quot;  She turns her stalwart gaze upon Nuvi and levels a steady claw at him.  &quot;I&#39;m holding you personally responsible as the human&#39;s escort.  As a wombuddy, you ought to be fit to police any mischief they might want to get up to.&quot;
				&lt;&lt;else&gt;&gt;
					Test -- should not be here
				&lt;&lt;/if&gt;&gt; // end if player&#39;s wombuddy score is one of the segments that should be unwombatty
			 
			&lt;&lt;silently&gt;&gt;
				If Sheila has a crush on the player, her rebukes are a lot softer
			&lt;&lt;//silently&gt;&gt;
			&lt;&lt;else&gt;&gt;
				&lt;&lt;script&gt;&gt;alert(State.variables.characters[&quot;sheila&quot;].inductive_bias);&lt;&lt;/script&gt;&gt;
				&lt;&lt;if $wombuddy_score &lt; 5&gt;&gt;
					Sheila fidgets and edges away from you, not quite meeting your gaze.  &quot;Um.  Right.  That&#39;s enough.  I&#39;m afraid you didn&#39;t pass the test, but I suppose you can c&#39;mon in anyway.&quot;  She shuffles her footpaws self-consciously, still refusing to look at you.  &quot;Mr. Nuvi, as a wombuddy escort to the human, their actions are your responsibility.  Please stick by them and provide whatever they need.&quot;
				&lt;&lt;elseif $wombuddy_score &gt;= 5 &amp;&amp; $wombuddy_score &lt; 10&gt;&gt;
					Sheila smoothes her fur repeatedly and unnecessarily as you grin charmingly at her.  Her eyes are shining, and you think you detect a hint of blush under the thinner spots of fur on her face.  &quot;Those answers were, um, interesting.  Not quite what we were hoping for, but definitely worth considering.&quot;  She squirms under your attention and looks determinedly at her footpaws.  &quot;Please c&#39;mon in, though.&quot;  Summoning what looks like considerable courage, she wrenches her gaze away from the ground and meets your own.  &quot;We&#39;d love to have you!&quot;  
					As you pass by her, she pulls Nuvi aside and whispers, &quot;Keep an eye on the human, please.  They&#39;re pretty great and all, but you&#39;re their wombuddy escort.&quot;
				&lt;&lt;else&gt;&gt;
					Test -- should not be here
				&lt;&lt;/if&gt;&gt;
			&lt;&lt;/if&gt;&gt;// end sheila crush processing
		&lt;&lt;/if&gt;&gt;// end player trial count processing
	&lt;&lt;/if&gt;&gt;// end player title wombuddy processing
&lt;&lt;/if&gt;&gt;// end visited() processing
</tw-passagedata><tw-passagedata pid="47" name="Bush_Warren" tags="room" position="0,1439" size="100,100">The bare earth of the tunnel walls is smooth and lovingly sculpted, somehow achieving a state of being both literally dirt and yet also clean.  You&#39;re forced to travel at a hunch due to the usual denizens&#39; small stature, but the curious fuzzy faces peering out at you from myriad offshoot tunnels more than make up for the discomfort.  That said, you could do without bopping your head repeatedly on the irregularly shaped luminous fungi that grow along the tunnel ceiling providing light to traveling tunnelers.  

Now you can see why Sheila was so adamant about your wombatitude -- people&#39;s dens are built off of the main tunnel passage with no obvious doors or other separators.  Wombats are evidently a very integrated people and not very shy about their personal space.  That seems prudent for a tunneling culture.

After a few hundred meters of home tunnels, storage tunnels, and windy tunnels whose purpose you cannot fathom, the main tunnel opens up into a vast hub chamber where you can finally stand up.  
&lt;&lt;if $characters[&quot;player&quot;].titles.contains($title_wombuddy)&gt;&gt;
	Nuvi flaps around carelessly, flitting between the much larger clumps of luminous fungi brightening the chamber.  There are numerous varieties here in all colors you can imagine and a few that make your brain hurt.   
&lt;&lt;else&gt;&gt;
	Nuvi hovers near your shoulder, studiously abiding by Sheila&#39;s mandate that he escort you at all times.  There are interesting colors coming from the arrangement of lamp fungi, but you can&#39;t see them clearly through his worried flapping about your head.  If you try to peer around him or otherwise break stride, he bats at your head with soft feathers to urge you on.
&lt;&lt;/if&gt;&gt;
Numerous tunnels branch off from the hub chamber, but your destination is clear: a [[large tunnel ornamented with a gaudy crest stands waiting directly to the North-&gt;Bush_Warren_Council]].  The crest depicts a congregation of all manner of beasts standing at attention with expressions of rapt interest as one of their number, a purposefully generic critter mostly cloaked in shadow, evidently speaks.  That tunnel must lead to the council chamber of the council of animals.</tw-passagedata><tw-passagedata pid="48" name="Bush_Wombuddy_Test_Quest" tags="conversation" position="163,1300" size="100,100">&lt;&lt;silently&gt;&gt;
this would be better as played scenarios, like in Dragon Quest 3; the wombat touches your brow gently and you find yourself in the situation...
&lt;&lt;/silently&gt;&gt;
&lt;&lt;silently&gt;&gt;
	The player has to achieve a score of 9 wombat points to earn the title of wombuddy.  This equates to at least one &#39;perfect&#39; (+5) answer and two &#39;okay&#39; (+2) answers. 
&lt;&lt;/silently&gt;&gt;
&lt;&lt;silently&gt;&gt;
	disaster handling scenario
&lt;&lt;/silently&gt;&gt;

&quot;I will pose three scenarios to you, and I simply require that you answer honestly about what you would do in each case.&quot;  She crosses her fuzzy arms and taps the giant claws of her right paw appraisingly upon her impressive left bicep.

&quot;The day has been perfect: timbers were erected effeciently as support struts, and every measurement and calculation was correct on the first go.  The soil was all soft and loamy, such that tunneling was more like being a joey again playing in the mud than work.  Your people are all safe and happy and contentedly tired from a day&#39;s honest labor.  As everyone is leaving the tunnel, it all comes crashing down -- literally.  
Termites, those evil buggers, have weakened a timber toward front of the tunnel and it collapses just before the last of your people make it out!  Two are trapped inside: a grey-furred elder just about ready for retirement and a youngster who regularly exhausts himself to prove his competence.  The greyback was close to the exit when the tunnel collapsed, only two or three body lengths deep.  The ambitious youngling is much further back, but also possibly behind the actual collapse instead of beneath it.  You&#39;re the forebeast, and responsible for their lives.  What is the first thing you do?&quot;

&lt;&lt;silently&gt;&gt;
	This&#39;d be the humble but potentially cowardly approach 
	
	+1 towards wombuddy
	Inductive bias: humble, lacking_confidence, knows_limitations
	
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;I&#39;m not qualified to handle that situation, so I would defer to someone else&#39;s expertise.&quot;-&gt;Bush_Wombuddy_Test_Quest_2]]&gt;&gt;	
	&lt;&lt;set $wombuddy_score += 1&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_humble,$inductive_bias_lacks_confidence,$inductive_bias_knows_limitations])&gt;&gt;
&lt;&lt;/link&gt;&gt;&quot;
&lt;&lt;silently&gt;&gt;
	Passionate and compassionate response, but potentially foolish
	
	+2 towards wombuddy
	Inductive bias: kind, reckless, heart_over_head
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;Dig straight in with my own claws and rescue the elder; that poor old&#39;n needs help pronto!&quot;-&gt;Bush_Wombuddy_Test_Quest_2]]&gt;&gt;
	&lt;&lt;set $wombuddy_score += 2&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_kind,$inductive_bias_reckless,$inductive_bias_heart_over_head])&gt;&gt;
&lt;&lt;/link&gt;&gt;
&lt;&lt;silently&gt;&gt;
	The reasonable and cool-headed approach, best for wombats
	
	+5 towards wombuddy
	Inductive bias: logical, confident, burrower
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;The old one&#39;s known lack of air and position under the collapse is a more pressing danger than the trapped youngster.  I would set three-quarters of the team to digging around the collapse to install new supports and the remainder to cautiously trying to dig out a path, starting towards the top of the collapse and angled downwards, directly to the trapped elder.&quot;-&gt;Bush_Wombuddy_Test_Quest_2]]&gt;&gt;
	&lt;&lt;set $wombuddy_score += 5&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_logical,$inductive_bias_confident,$inductive_bias_burrower])&gt;&gt;
&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="49" name="Bush_Wombuddy_Test_Quest_2" tags="conversation" position="231,1454" size="100,100">&lt;&lt;silently&gt;&gt;
scenario about honesty and humility
&lt;&lt;/silently&gt;&gt;
&quot;On to the next scenario, then.  You&#39;ve been tasked by your forebeast to survey a completed tunnel using a trendy new architecture for safety.  The forebeast in question is known to cut corners: case in point, he came to you, a novice surveyor, rather than one of the senior surveyors as per protocol.  Despite this reputation, he is also influential in the community and a good relationship with him could help skyrocket your career.  Similarly, a black mark from him could cripple your ambitions for years.  As for your skill level, you&#39;re good but you don&#39;t feel confident that you can perform such a complex survey adaquately without much more experience.  What do you do?&quot;

//todo: the assessment of all scenarios should take inductive bias into account, and conflicting biases should lead to suspicion.

&lt;&lt;silently&gt;&gt;
	Honest and humble case where player confesses situation to senior surveyor and risks ire of forebeasty because it&#39;s the safe and responsible thing to do
	
	Wombuddy +5
	Inductive Bias Mods: humble, honest, altruistic, compassionate
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;No real choice -- I&#39;d have to confess to the forebeast that I felt unready to take on such a major task and request that he choose someone more experienced.  If he insists, I&#39;d take the matter to one of my superior surveyors or the appropriate governing body; safety comes first!&quot;-&gt;Bush_Wombuddy_Test_Quest_3]]&gt;&gt;
	&lt;&lt;set $wombuddy_score += 5&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_humble,$inductive_bias_honest,$inductive_bias_altruistic, $inductive_bias_compassionate])&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;silently&gt;&gt;
	Ambitious self-starter but reckless response
	
	Wombuddy +2
	Inductive Bias: ambitious, reckless
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;I would embrace the challenge!  Working nights and weekends studying the tunnel and its architectural theory prior to surveying it should compensate for my lack of experience.&quot;-&gt;Bush_Wombuddy_Test_Quest_3]]&gt;&gt;
	&lt;&lt;set $wombuddy_score += 2&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_ambitious,$inductive_bias_reckless])&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;silently&gt;&gt;
	Honest but selfish/obstructionist
	
	Wombuddy +1
	Inductive Bias: selfish, honest
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;I&#39;m just a novice, I can&#39;t be responsible for that!  I wouldn&#39;t want my name anywhere near such a slipshod operation; I&#39;d refuse the forebeast&#39;s request and try to wash my hands of the whole situation, going over his head if necessary.&quot;-&gt;Bush_Wombuddy_Test_Quest_3]]&gt;&gt;
	&lt;&lt;set $wombuddy_score += 1&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_selfish,$inductive_bias_honest])&gt;&gt;
&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="50" name="Bush_Wombuddy_Test_Quest_3" tags="conversation" position="166,1600" size="100,100">&lt;&lt;silently&gt;&gt;
scenario about work ethic and community focus
&lt;&lt;/silently&gt;&gt;

&quot;All right, final scenario.  Your forebeast is thrilled with the progress you and your team have been making, and has given you the day off!  How do you spend it?&quot;

&lt;&lt;silently&gt;&gt;
	Chill but lazy answer
	Secret bonus: you&#39;ve picked Sheila&#39;s favorite guilty pleasure and made her blush as she begins to crush on you just a tad
	
	Wombuddy +1
	Inductive Bias: chill, lazy, crush
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;Resting my weary bones!  I&#39;d curl up with a good book and some soft music and snooze the day away.  Ooh!  With a lilac-scented bubble bath to soothe those nasty muscle cramps.&quot;-&gt;Bush_Wombat_Burrow_1]]&gt;&gt;
	&lt;&lt;set $wombuddy_trials++&gt;&gt;
	&lt;&lt;set $wombuddy_score += 1&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_chill,$inductive_bias_lazy,$inductive_bias_crush])&gt;&gt;
	&lt;&lt;if $wombuddy_score &gt;= 10&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].titles.push($title_wombuddy)&gt;&gt;
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;silently&gt;&gt;
	Comradery-y but not abundantly constructive answer.  Also a little pushy for wombat tastes.
	
	Wombuddy +2
	Inductive bias: friendly, pushy, hypersocial
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;I suppose I&#39;d grab my teammates and lead the charge in a day of fantastic team building exploits!  Cooperative games, candid discussions, and shared memories should really help us once we&#39;re back on the job.&quot;-&gt;Bush_Wombat_Burrow_1]]&gt;&gt;
	&lt;&lt;set $wombuddy_trials++&gt;&gt;
	&lt;&lt;set $wombuddy_score += 2&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_friendly,$inductive_bias_pushy,$inductive_bias_hypersocial])&gt;&gt;
	&lt;&lt;if $wombuddy_score &gt;= 10&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].titles.push($title_wombuddy)&gt;&gt;
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;silently&gt;&gt;
	Studious and ambitious
	
	Wombuddy +5
	Inductive bias: studious, ambitious
&lt;&lt;/silently&gt;&gt;
&lt;&lt;link [[&quot;I&#39;d take the opportunity to brush up on my tunneling theory, or maybe review safety checklists for the tunnel segment my team is working on.  I might even go ahead and start in on the next segment if my forebeast gives the OK and I can do so safely on my own.&quot;-&gt;Bush_Wombat_Burrow_1]]&gt;&gt;
	&lt;&lt;set $wombuddy_trials++&gt;&gt;
	&lt;&lt;set $wombuddy_score += 5&gt;&gt;
	&lt;&lt;run $addToInductiveBias($characters[&quot;sheila&quot;].inductive_bias,[$inductive_bias_studious,$inductive_bias_ambitious])&gt;&gt;
	&lt;&lt;if $wombuddy_score &gt;= 10&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].titles.push($title_wombuddy)&gt;&gt;
	&lt;&lt;/if&gt;&gt;
&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="51" name="Bush_Warren_Council" tags="room" position="7,1666" size="100,100">&lt;span id=council_chamber_desc&gt;
The tunnel beneath the gaudy crest quickly metamorphoses from lovingly sculpted earth to carefully hewn stone.  The tough gray rock has been chiseled to almost frictionless smoothness somehow, and only the colder temperature and reduced springiness of the subtrate alerted your feet to any change from the earthen tunnels.

Golden sunlight floods the council chamber from an aperture some three dozen meters above you.  A complex series of pulleys rises along the stone wall on the far side of a massive round table, with thick cord threaded through each.  You wonder briefly what function such a convoluted mechanical system serves.  The walls and floor are completely bare of ornamentation; this room was clearly intended for serious matters.

Thirteen robed bipedal animals shuffle out of a nondescript wooden door you hadn&#39;t even noticed beside the gleamingly polished oak table adorning the center of the dais.  Twelve take seats around the table, and one approaches you and Nuvi.  Nuvi flaps apprehensively as the young vixen approaches, her sleek scarlet fur impeccably groomed despite the tale of many sleepless nights told by her sunken and bloodshot eyes.  Her gold eyes study you intently, no less keen for her apparent fatigue.  Without a word she nods as if reaching some tacit conclusion, and the motions to someone behind you.  

Turning slightly, though taking care not to turn your back on the council member, you watch warily as two large badgers roll an enormous stone into the mouth of the tunnel, sealing it behind you.  No going back now.  These same fellows then jog over the pulley mechanism: as they take turns heaving on the cord, a stone slides into place over the sunny inlet aperture far above, and the chamber is &lt;&lt;link &quot;plunged into darkness.&quot;&gt;&gt; 
&lt;&lt;replace &quot;#council_chamber_desc&quot;&gt;&gt;
Glimmering lights in a thousand rainbow hues spring to life from the darkness, casting variably inviting and intimidating aesthetics upon the stark room.  They are faeries, but they seem notably more subdued than those you saw back in the Frosty Forest.  One drifts lazily toward you, alighting upon your shoulder.  Her glittering emerald gemstone eyes are dull and seem unfocused.  She smiles vaguely at you and then flits off dreamily in no particular direction.
&lt;&lt;if $party.includes($characters[&quot;shimmerin&quot;])&gt;&gt;
Shimmerin buzzes angrily from your pocket, refusing to look at the other faerie.
// todo: Shimmerin should be outraged by the &#39;tame&#39; faeries, and should really cause a ruckus here
&lt;&lt;/if&gt;&gt;
// todo: EXPOSITION!!! *sigh* need a more show don&#39;t tell approach, like Marrah having the faeries act out the scene of lumpkin inception from creative energy.
The fox approaches you and proffers her paw.  You extend a hand, unsure what she expects, and she rests her paw on it in an apparent show of solidarity.  &quot;Warm regards, human.  My name is Marrah, Voice of the council of animals.  I have never met one of your kind, one of the progenitors, but sadly there is no time to get to know one another.  Behold!&quot;

She flings her paw commandingly toward the center of the table without taking her shining gaze off you.  The faerie lights floating about the room zoom together into a formless mass above the table for a moment, and then resolve into a glowing map of Fuzziolump.  Three continents are outlined in soft azure light, west, central, and east.  &quot;Show us Holly&#39;s reach,&quot; Marrah barks, and a circle of almost poisonously bright green spreads out from the center of the central continent to cover roughly 50% of it. 

&quot;We are here,&quot; she points to a spot just to the west of the green zone&#39;s reach.  &quot;Just out of her grasp, for now.  Before we discuss the threat posed by the godlings, however, I should explain in more detail what exactly these creatures are.  All lumpkins and in fact the world of Fuzziolump itself are born of imagination and emotion, with creative energies being especially fertile.  At first this energy came almost exclusively from humans and some of the craftier monkeys of your earth. 

// todo: something about creativity having a life of its own and passing that life onto created works... or radiating it off into places like Fuzziolump.

&quot;Fuzziolump has existed for almost as long as human life on earth, our first life emerging from your ancestors&#39; early experiments with cavernous canvas.  Intelligent life here is fairly new, however -- it takes quite a lot of imagination to wire up a complex brain, and the dribs and drabs of imaginative energy siphoned off of earth&#39;s creative corona probably never would have done it.  About a century ago, however, something changed fundamentally: your Guglielmo Marconi developed the first long distance radio!  As you know, broadcast technology exploded throughout your 20th century. These transmission served as much more efficient conduits of the thoughts and feelings on earth, and the pace and sophistication of lumpkin development increased exponentially. 

&quot;Once life here developed sufficient intelligence to start dreaming on its own, we became fully self-sustaining and self-propagating.  Therein lay the problem.  Our development had been fairly measured, if mildly explosive, up until a year ago.  One year ago today, two lumpkins embarked on an experiment that will either &lt;&lt;link &quot;open a new horizon of existence for us, or kill us all.&quot;&gt;&gt;
&lt;&lt;replace &quot;#council_chamber_desc&quot;&gt;&gt;
&quot;Dr. Beakman, please tell us what you&#39;ve learned about the Reckless.&quot; 

A toucan with a massive rainbow beak stands up, and Marrah takes her seat. &quot;Drs. Hashmalum and Holly were among our brightest, back when they still had hold of their sanity.  They were interested in a phenomenon of creativity wherein two lumpkins engaged in a cooperative act of creation can actually form a positive feedback loop that would empower both.  In naturally occurring small doses, this phenomenon simply means that both parties create a little more of whatever they&#39;re working on together than they could have done apart because the loop will normally collapse quickly.  The collapse comes when focus wavers or fatigue sets in, both terminal conditions that are sure to arise swiftly for any lumpkin or similar organism.

&quot;Hashmalum and Holly&#39;s dangerous idea was to bring a third party into the mix, one that was not subject to the same limitations of organic life.  We&#39;ve been monitoring human progress on artificial intelligence and machine learning carefully over the years, since it reminds us of ourselves and our origins.  Holly, the greater artist of the two, designed a program that used recursive transition networks and massive text corpi to generate narrative automatically.  Unlike other such programs, it was particularly capable at adapting novel corpi to its output at runtime.  

&quot;Hashmalum rigged up some impressive hardware to run the program, and also an apparatus that would allow the two scientists to read its output continuously while working together on their own body of writing, which was then fed into the program.  The two were able to rest while the machine continued writing based on their input, thus preventing the positive feedback loop from terminating fully.  Over the course of three days and nights they constructed the greatest such feedback loop the world has ever seen, and achieved some of the best writing we&#39;ve seen as well.

&quot;It also changed them.  The loop never truly terminated, and when the two tried to separate they each pulled a personal miniaturized version of the feedback loop into themselves.  We don&#39;t understand how exactly, but the loops are still running even though the experiment is long done and their automatic writing partner has been shut down.  Neither walked away from the experiment quite the same person they had been, that much was evident just from seeing the new heights of perspective in their eyes.  We didn&#39;t realize that the loops were still running and actually adding to their being.  Overt creative acts spurred the process on, so Holly was the first to Ascend.  

&quot;She finished her novel in a weekend and spent the rest of the week tending to her garden, picking up and inventing new horticultural and arrangement techniques even as she weeded.  By the next weekend, her garden had become a veritable jungle.  The week after, she didn&#39;t show up for work and no one could find her for the longest time.  Finally someone started looking at the plants instead of around them, and realized there was a smiling face looking back!  Holly had become one with her plants, and their roots ran deep.  This network allowed her to fashion her garden and eventually much of the central continent&#39;s plant life into a massive distributed intelligence.  

&quot;Holly defined friendliness as a lumpkin, and thankfully whatever she has become seems to have inherited this trait.  However, she is no longer quite in touch with mortality and has difficulty seeing from our point of view.  Anyone bothering nature almost anywhere on the central continent has to take care to clear their intentions with Holly first or potentially face her wrath.  It&#39;s never clear what will upset her, and she regards all life equally; a simple mistep by an intelligent lumpkin that bends a flower stalk may inspire her to similarly break your spine if she&#39;s in a spiteful mood.  Her moods are the biggest problem -- she seems to have all the whimsy of Nature herself, as warm and welcoming as azure sky on a sunny summer&#39;s day one moment and the next she&#39;s as silent and smothering as the deepest snow drifts during a winter blizzard.  Her motivation seems to be propagation of herself and life in general, and protection of wildlife -- especially wildlife that she&#39;s created.  This creates an additional problem, since her creations and influence are quickly filling the continent!&quot;  The toucan shakes his giant bebeaked head sadly and returns to his seat.  

A tigress stands next, a long striped tail swishing out from under the hem of her robe.  &quot;My name is Kitarra and Hashmalum was my mate once.  He was always a proud lion, foolish despite his brilliance.  His transformation has twisted that pride into something truly hideous, a great many-headed beast rampaging over the western continent at present.  Luckily for all of us here in central, Holly keeps him at bay.&quot;  She waves towards the faerie display, and a crimson tide of angry red sweeps over about 70% of the western lands.  

&quot;We don&#39;t know as much about him as we do Holly, since he kills anyone within reach.  His only goal seems to be destructive conquest so far, with much of the remaining life in the west now reduced to a cult calling themselves the Fanatics who worship Hashmalum as some sort of purifying god of destruction.&quot;  Though her voice had been strong and steady throughout her short speech, Kitarra&#39;s whiskers droop as she sags back into her chair, evidently exhausted by expelling and thus facing this toxic truth.  

Marrah stands again and pads over to you on soft-furred footpaws.  &quot;Human,&quot; she says, a note of pleading running through her confident voice like a web of cracks gradually undermining the structural integrity of crystal, &quot;I am truly sorry to place our burdens on your shoulders.  The thing is, we need you.  Humans are uniquely powerful here -- we think it has something to do with the fact that it was your people&#39;s imagination that created this whole world in the first place, and therefore pieces of you are fundamentally woven into the fabric of Fuzziolump reality.

&quot;Imagination is integral to this land.  In Fuzziolump, physics can be manipulated with a dream or a wish.  It&#39;s often not quite as easy as it sounds though; there&#39;s a precise science to it called Incarnation. Further, one has to be attuned with the Fuzzy Firmament in a manner conducive to what one wishes to accomplish.  Each lumpkin is born with an imaginative talent, called our Entity, and our powers of Incarnation are limited to that Entity.&quot;  Lilac fire springs into her paws as she throws them wide in a showy demonstration.  &quot;My Entity is foxfire, shaping ghostly fire into illusions of my choice.  Beautiful, haunting, but not very useful for fighting or diplomacizing gods.  Therein lies our great need for you, human: humans in Fuzziolump can learn Incarnation for any Entity, or even invent new Entities.  It&#39;s been done before.

&quot;There was a very evil lumpkin once, named Adrammalocke.  His Entity allowed him to unmake lifeforms virally, erasing them from reality one cell at a time and spreading as much or little as he wanted.  We hunted him down, executed him, and hid all his writings about the workings of his Entity.  No single person knows where, and would be allowed past the guardians put in place.  On the bright side, powers like his are practically unheard of before or since.  Unfortunately, we could really use firepower like that to bring to bear against the godlings.  If Adrammalocke was still living today, we might be beseeching him, making concessions, appeasing...&quot;

Shaking herself bodily, she brightens and turns eyes the blazing molten gold of a burning crown upon you.  &quot;If you can find and claim the grimoire of Adrammalocke and learn his Entity, you can provide the same weapon with none of the moral compromise!&quot;  

Seeing the blinding light in her eyes, Nuvi flaps apprehensively beside you, loop-the-looping repeatedly while his whiskers twitch in aggitation.

&quot;Of course,&quot; the scarlet fox continues quickly, &quot;you don&#39;t need to use violence if you can find another method.  Shades and spirits, we would love nothing more than to have our friends back to their old selves somehow.  With access to the full power of Incarnation, you may be able to discover or build a peaceful solution.&quot;

Waving her hand from the west continent to the eastern border of central, Marrah continues gravely, &quot;Saving these lands and all who live there is your challenge, human, your struggle, your quest.  And you must triumph, or we will surely perish.  Since Holly is relatively diplomatic, we implore you to approach her first.  How you handle her threat is entirely up to you; we already mourn the loss of our friend, so if this new creature must be destroyed, then let it be so.  What is your plan?&quot; 

&lt;&lt;link [[&quot;I will find Adrammalocke&#39;s grimoire, and I will eradicate the foes of Fuzziolump!&quot;-&gt;Bush_Warren_Council_Postproc]]&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		nuvi opinion of player goes way down with such a violent approach
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;nuvi&quot;].updateAffinity($characters[&quot;player&quot;],-100&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		council opinion of player goes down, though they are relieved to have a definite course of action in play.  
		for simplicity the council of animals will be a hive mind for affinity, except for marrah.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;council&quot;].updateAffinity($characters[&quot;player&quot;],-10&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		Marrah is a little excited about it, though she doesn&#39;t want to admit it to herself.
	&lt;/silently&gt;&gt;
	$characters[&quot;marrah&quot;].updateAffinity($characters[&quot;player&quot;],10&gt;&gt;
	&lt;&lt;run $characters[&quot;marrah&quot;].addToInductiveBias($inductive_bias_crush) &gt;&gt;
	&lt;&lt;silently&gt;&gt;
		set the godling strat for total war
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;set $godling_strat to $godling_strat_viral_violence&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[&quot;The feedback loops of creation are the source of their godhood, and of their threat.  I will invent a way to terminate these loops using Incarnation.  With a little luck, we might get your friends back.  It&#39;ll be fascinating to see what happens!&quot;-&gt;Bush_Warren_Council_Postproc]]&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		nuvi opinion of player goes up slightly with a creative and potentially nonviolent solution.  He&#39;s not so confident that terminating the loops won&#39;t kill the godlings, however, so he remains apprehensive.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;nuvi&quot;].updateAffinity($characters[&quot;player&quot;],10&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		council opinion of player goes up to a warm amount since this solution seems somewhat specific (though still not definite) and actionable and also might save their friends  
		for simplicity the council of animals will be a hive mind for affinity, except for marrah.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;council&quot;].updateAffinity($characters[&quot;player&quot;],50&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		Marrah is a little disappointed that the human has opted for an indefinite strat
	&lt;/silently&gt;&gt;
	$characters[&quot;marrah&quot;].updateAffinity($characters[&quot;player&quot;],-10&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		set the godling strat for circuitous hacking
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;set $godling_strat to $godling_strat_surgical_systems&gt;&gt;
&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[&quot;These creatures were your friends once, and maybe still are -- I won&#39;t risk harming them until I&#39;ve exhausted every peaceful option.  I&#39;ll find a way to reach them with diplomacy and Incarnation.&quot;-&gt;Bush_Warren_Council_Postproc]]&gt;&gt;
	// todox: nuvi opinion way up
	// todox: council opinion down
	&lt;&lt;silently&gt;&gt;
		nuvi opinion of player goes way up since this is the only strat that ensures a peaceful resolution, even if the specifics are... non-specific.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;nuvi&quot;].updateAffinity($characters[&quot;player&quot;],100&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		council opinion of player goes down slightly because the plan is too vague  
		for simplicity the council of animals will be a hive mind for affinity, except for marrah.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;run $characters[&quot;council&quot;].updateAffinity($characters[&quot;player&quot;],-10&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		Marrah is extremely disappointed that the human has opted for a definitively indefinite strat.  Doesn&#39;t make her hate the player of course, but she feels that she can&#39;t count on them
	&lt;/silently&gt;&gt;
	$characters[&quot;marrah&quot;].updateAffinity($characters[&quot;player&quot;],-50&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		set the godling strat to fluffy bunnies and hugs for the hug inclined
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;set $godling_strat to $godling_strat_diplomancy&gt;&gt;
&lt;&lt;/link&gt;&gt;
&lt;&lt;/replace&gt;&gt;
&lt;&lt;/link&gt;&gt;&quot;   
&lt;&lt;/replace&gt;&gt;
&lt;&lt;/link&gt;&gt;
&lt;/span&gt;</tw-passagedata><tw-passagedata pid="52" name="Bush_Warren_Council_Postproc" tags="conversation" position="8,1797" size="100,100">// todo: allow player to choose a council member or Nuvi to get Incarnation &#39;scrolls&#39; from for the purpose of &#39;immediate defense&#39; (i.e. the Puck fight at the end of the demo).  Also have them say something about highly statically charged items coming through portals on their own, mostly socks but occasionally other items including a large dagger meant for human hands.

&lt;div id=&quot;council_postproc&quot;&gt;
&lt;&lt;if $godling_strat === $godling_strat_viral_violence&gt;&gt;
Marrah&#39;s eyes gleam with unabashed excitement. &quot;Now that sounds like a plan of action!&quot;  She places a paw on your chest, over your heart, and a hungry sparkle joins the excitement in her intense gaze.  

The rest of the council rises, all that needs be said having apparently been said.  An orangutan looming in the shadows behind Marrah clears her throat meaningfully, and Marrah backs away from you, her blush making her scarlet aesthetic practically blaze.  &quot;Go now, human, for all the hope of Fuzziolump goes with you!&quot;  
&lt;&lt;elseif $godling_strat === $godling_strat_surgical_systems&gt;&gt;
Dr. Beakman the toucan nods sagely even as Marrah narrows her eyes skeptically.  &quot;How can you be certain that will work?  What if they only stop growing but keep the power they hold currently?  That would be unacceptable!&quot;  Her scarlet fur bristles in agitation as her voice rises to almost the volume of impropriety.

Before you can formulate an answer, Dr. Beakman flaps over to stand beside Marrah.  He wraps a wing about her consolingly and says, &quot;The human speaks wisdom, Marrah.  Only the imaginative feedback loops grant the godlings their immense power, and support it.  Disrupting the loops should bring all that being crashing down, reverting our old friends to their former selves... or killing them.  Most importantly, a surgical approach should minimize collateral damage and casualties.  It&#39;s the best chance for all of us.&quot;

The scarlet fox nods her head slowly, and then ducks out from the toucan&#39;s wing to approach you.  Her golden eyes flashing, she growls, &quot;All right human, we&#39;ll do it your way.  Just remember that millions of lives depend on you -- there&#39;s no room to indulge your curiosity!&quot;  She back away from you, blinking rapidly, and then turns without another word.
&lt;&lt;elseif $godling_strat === $godling_strat_diplomancy&gt;&gt;
Marrah blinks slowly, her molten gold eyes fairly boiling.  &quot;Diplomacy?  Don&#39;t you think we&#39;ve tried that?!  These were our friends!&quot;  She flies at you, raking beautiful lacquered claws across your face and spraying the council table with blood. 

Nuvi flaps down between you and the angry scarlet fox, and his wings glow azure for an instant before a blinding white light knocks you back on your rump.  When your vision clears, you can see Marrah similarly prone, and seething.  As she struggles to rise, a deep voice booms out and nearly knocks her back on her haunches. &quot;That will do, councilbeast Marrah.&quot;  A giant mole waddles over to you from the far side of the table and extends a shovel-like digging claw.  You place your hand upon it, in the greeting fashion of the council.  A broad smile lights up the mole&#39;s velvety face, and his whiskers twitch knowingly.  &quot;Please forgive our little firebrand, human; she&#39;s young and understandably full of rage.&quot;

Marrah doesn&#39;t bother to rise.  The mole&#39;s soothing rumble has drained her fury, and her whiskers droop as she looks at her footpaws in shame.  The mole offers her his claw, and she takes it almost shyly.  &quot;My name is Mooty Wort.  I am a pacifist, and thus I am not often popular in times of strife and struggle like these.  It warms my little heart to meet someone similarly dedicated to peace and life.  That said, Marrah is correct that we have already tried exhaustively to talk down both Hashmalum and Holly, without success.&quot;

The mole shakes his broad snout sadly.  &quot;They simply will not listen.  Those of us with Entities suitable to coercion and emotional manipulation have also tried to &#39;force&#39; the godlings to be agreeable, but their minds are too strong.  You will have to be subtle and clever in how you employ Incarnation to reach them.  Go now, human, and always keep love foremost in your heart.  You are our hope!&quot;
&lt;&lt;/if&gt;&gt;
&lt;&lt;link &quot;There is a susurrus of ruffles and rustles as variously furred and feathered creatures start gathering themselves to go...&quot;&gt;&gt;
	&lt;&lt;replace #council_postproc&gt;&gt;
	Before anyone can leave, Nuvi pipes up, &quot;Wait wait! The Human has no way to defend themselves against danger.  Sure, they have mighty me, but we shouldn&#39;t leave The Human themselves unequipped.&quot;
	The council pauses and looks are cast about as responsibility bounces tacitly around.  Finally, a dusty old raccoon lady steps toward you, away from the others.  &quot;I am Ingrid, Archivist and Keeper of Artifacts.  Sometimes odd things come through our conduits without any of our conductors like young Nuvi here opening the way for them.  For some reason they always seem to be highly charged with static electricity... and they&#39;re mostly socks.  However, we have saved them all for study and a few look like formidable weapons.&quot;  Shoving one of her colleagues aside, she waves a paw reverently over the ornate table and several items appear there.
	&lt;&lt;link &quot;Wickedly Curved Axe&quot;&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].equipment.push($items[&quot;wicked_axe&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	&lt;&lt;link &quot;Inexplicably Cold Mace&quot;&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].equipment.push($items[&quot;cold_mace&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	&lt;&lt;link &quot;Saw-tooth Dagger Glittering with Starlight from Within&quot;&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].equipment.push($items[&quot;sawtooth_star_dagger&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	Ingrid nods her acceptance of your choice.  She begins stepping back into the fold, then pauses and returns to the table, sighing resignedly.  &quot;We also have a few Splinters of Entity that you could learn Incarnation from in a snap.&quot;  Her whiskers droop and her eyes go misty as she explains, &quot;Splinters grow over the place a Lumpkin died.  The phenomenon only occurs rarely, and only when said Lumpkin died while channeling Incarnation.  Even then, it takes about a century to grow large enough to be useful and its power only lasts a decade or so after that.  Lumpkins with a similar Entity can use them for a boost of power in a pinch, or Humans can learn them permanently.  I will allow you to devour all that remains of one of our well-liked but not really beloved ancestors, and no more.  Choose carefully!&quot;
	&lt;&lt;link [[&quot;Take the Splinter of Serpentarius&quot;-&gt;Bush_Warren_Council_Exit]]&gt;&gt;, a vile cobra whose venom cut short a thousand thousand warriors&#39; lives before they managed to end his bid for absolute conquest of Fuzziolump.
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;debilitate&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;pierce&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;toxin&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	&lt;&lt;link [[&quot;Take the Splinter of Violet&quot;-&gt;Bush_Warren_Council_Exit]]&gt;&gt;, a lovely young mink who only truly lived in her final hours when she discovered true solitude, bathed in shadow and cold beneath the cave-in that slowly smothered her.
	&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;shadowform&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;perfect_stillness&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;savage_sympathy&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	&lt;&lt;link [[&quot;Take the Splinter of Snugg-lor&quot;-&gt;Bush_Warren_Council_Exit]]&gt;&gt;, a guinea pig priest of pleasure and passion who, during a particularly rowdy drinking game, literally burst with joy.
	&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;warmest_hug&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;woolly_shield&quot;])&gt;&gt;
		&lt;&lt;run $characters[&quot;player&quot;].incarnations.push($incarnations[&quot;maenad_frenzy&quot;])&gt;&gt;
	&lt;&lt;/link&gt;&gt;
	&lt;&lt;/replace&gt;&gt;
	&lt;&lt;/link&gt;&gt;
&lt;/div&gt;</tw-passagedata><tw-passagedata pid="53" name="Encounter_Puck_Viral_Violence" tags="encounter" position="7,2125" size="100,100">As you leave the warren complex, Sheila the steady wombat turns her back on you and snorts derisively. &quot;Word of your &#39;plan&#39; has gotten out. \
&lt;&lt;if !$characters[&quot;player&quot;].titles.includes($title_wombuddy)&gt;&gt;\
  I knew your wombatitude was rotten. 
&lt;&lt;else&gt;&gt;
	You&#39;re no wombuddy after all, it seems.
	&lt;&lt;run $deleteTitle($title_wombuddy)&gt;&gt;\
&lt;&lt;/if&gt;&gt;\
Fair warning, we lumpkins would rather face danger and death from our own than a human -- if you get out of control, we&#39;ll band together with the godlings against you.  I don&#39;t want any part in what you&#39;re doing, so I&#39;ve got nothing to say about where you should go next.&quot; 

You turn to Nuvi, eyebrows raised questioningly.  He sighs and shrugs, and seems to deflate like a fuzzy balloon.  His bowtie is askew, but he doesn&#39;t bother to fix it anymore.  Irritation with this pathetic little creature claws its way from your heart to you tongue, and you ready a scathing rebuke for your &#39;guide&#39;.  

Before you can spew your venom forth, however, Marrah slinks out of the shadows and taps you on the shoulder.  She looks enthusiastic, bubbly even, and she&#39;s wearing only a smile.  Of course, most furry folk you&#39;ve met here don&#39;t bother with clothing.  Still, she is holding herself in a manner that emphasizes her sinuous musculature and puts the light through her fur at an angle that makes her appear to be fire made aggressively female.  Her smile reveals a gleaming array of meticulously cared-for and extremely sharp teeth.  Sheila gives the vixen a withering look and ducks back into the tunnel&#39;s depths.  

&quot;Adrammalocke&#39;s grimoire is buried deep beneath the former site of his island fortress, off the Sapphire Coast a day&#39;s journey East.  It is in ruins now, and the whole island is cursed!&quot;  Her gold eyes shine with undisguised arousal.  &quot;But I can show you the way, and lead you through the many traps and barriers we put in place.&quot;  She snuggles up way into your personal space, making it clear she will be joining you.
&lt;&lt;run $party.push($characters[&quot;marrah&quot;])&gt;&gt;\

With Marrah hanging off your arm and practically purring, you trek East through the Bush.  Along the way, she displays her hunting prowess by stalking and tackling-to-death several giraffes.  Is there any other way to travel?  Just as you sight the blasted black rock of a castle&#39;s foundation far out to sea, the entire world goes dark.  You ask Marrah what&#39;s happening, and she hisses in reply.  Before she can elaborate, a pair of poisonous bright green eyes appear out of the abyss in front of you.

&quot;You dare challenge my mistress, goddess of this and all worlds?!&quot; a shrill masculine voice demands, rolling its &#39;R&#39;s in exaggerated primness.  The eyes are joined by a head in which they appear much too large, its features coldly calm and warped by abject hatred.  &quot;As if you or anything could kill her.&quot;

The body of an emaciated little man materializes in the air with a thunderclap to join his head.  His whole body trembles with the promise of imminent violence.  His features are pinched and angular, and his ears come to knife-like points.  The skin not covered by his elaborate hodgepodge of earth historic court dress is bone white.  A purple fedora perched at a rakish angle caps off the less-than-intimidating ensemble.  As you watch, he rips the ridiculous hat off and casts it away; it dissolves into the darkness with startling swiftness.

// todo: Hashmalum minion too?  IDK, I don&#39;t think his folk would work with Holly&#39;s

&quot;My name is Puck, knight captain and exalted archmage of her highness Holly, Wild Goddess of All Creation!  Feeble creatures, [[die!-&gt;Combat_Time]]&quot;

// todo: set combat params
&lt;&lt;script&gt;&gt;
/* apparently this is legal JS
var x1 = {};        // object

x1.MyClass = function MyClass(stuff,effectFn){ 
	this.msg = stuff;
	this.effect = effectFn;
}

var myClass = new x1.MyClass(&quot;hello from myclass&quot;, function(){return &quot;testing functional functionality in JS&quot;});

var myClass2 = new x1.MyClass(&quot;hello from myotherclass&quot;, function(){return &quot;for a second time, we are testing functional functionality in JS&quot;});
*/

var monsterPuck = new State.variables.Character(&quot;Puck&quot;);
monsterPuck.stats[&quot;hp&quot;] = 1000;
monsterPuck.stats[&quot;mp&quot;] = Infinity;
monsterPuck.stats[&quot;str&quot;] = 75;

var monster_party = [monsterPuck];
State.variables.combatArena = new State.variables.Combat(State.variables.party,monster_party,passage())
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="54" name="Encounter_Puck_Surgical_Systems" tags="encounter" position="272,2140" size="100,100">As you leave the warren complex, Sheila the steady wombat eyes you warily. 
&lt;&lt;if !$characters[&quot;player&quot;].titles.includes($title_wombuddy)&gt;&gt;\
&quot;I&#39;ve been told the gist of your plan.  I&#39;m no fan of having someone of your dubious wombatitude playing with the lives of two lumpkins, their current crazy godbeast forms notwithstanding.  You be careful!    
&lt;&lt;else&gt;&gt;\
&quot;I&#39;m not so sure about this experimental plan of yours, but if anyone can do it and do it right, it&#39;s a wombuddy.
&lt;&lt;/if&gt;&gt;\
You&#39;ll want to visit our foremost expert on Incarnation theory, magistra Molly, for a crash course before trying to poke around at anybody&#39;s imaginative feedback loops.  She moves around a lot, but her tower is a day&#39;s travel West of the Warren.  You can&#39;t miss it -- literally.  Molly&#39;s own Entity is mind control, and she&#39;s a little histrionic so she tends to draw any passersby in whether they were on their way to see her or not.&quot; 

Together with a decidedly distant Nuvi (he keeps eyeing you suspiciously and then ostentatiously fussing with his bowtie when you catch him at it), you trek West through the Bush, petting giraffes most of the way.  Is there any other way to travel?  Just as you sight the tip of a sparkly electric-purple tower peeking over the horizon, the entire world goes dark.  You ask Nuvi what&#39;s happening, and he whimpers in reply.  Before he can elaborate, a pair of poisonous bright green eyes appear out of the abyss in front of you.

&quot;You would dare to threaten the life of my mistress, goddess of this and all worlds?!&quot; a shrill masculine voice demands, rolling its &#39;R&#39;s in exaggerated primness.  The eyes are joined by a head in which they appear much too large, its features contorted with rage.  &quot;As if a limited creature such as you could harm her.  Even the original experiment that allowed her to assume her true form was too complex for a human to grasp, and she has done wonders to her glorious font of imagination in the time since her awakening.&quot;

The body of an emaciated little man materializes in the air with a faintly wet pop to join his head.  He dances in place in the air, his fists raised in what he undoubtedly thinks is a fighting stance.  His features are pinched and angular, and his ears come to knife-like points.  The skin not covered by his elaborate hodgepodge of earth historic court dress is bone white.  A purple fedora perched at a rakish angle caps off the less-than-intimidating ensemble.  As you watch, his bizarre pre-fight exercises (?) knock said hat off to fall away and disappear into the darkness.

&quot;My name is Puck, knight captain and exalted archmage of her highness Holly, Wild Goddess of All Creation!  You who would diminish her, [[en guarde!-&gt;Combat_Time]]&quot;

// todo: set combat params</tw-passagedata><tw-passagedata pid="55" name="Encounter_Puck_Diplomancy" tags="encounter" position="136,2130" size="100,100">As you leave the warren complex, Sheila the steady wombat salutes you. 
&lt;&lt;if !$characters[&quot;player&quot;].titles.includes($title_wombuddy)&gt;&gt;\
&quot;I was wrong about you, human.  You&#39;re more wombatty than me!
&lt;&lt;else&gt;&gt;\
&quot;
&lt;&lt;/if&gt;&gt;\
You&#39;ll want to head towards one of Holly&#39;s outermost nodes to get to know her a little without venturing too far into her influence,&quot; the little wombat advises stoicly.  &quot;That&#39;ll give you valuable insight into how she thinks, and hopefully help you formulate a way to help her see reason. She starts about a day&#39;s journey due North of here.  You&#39;ll know you&#39;ve reached her when the trees start to sing.&quot;

Together with a now perpetually delighted Nuvi (his earlier neuroses apparently shed at the warren), you trek North through the Bush, petting giraffes most of the way.  Is there any other way to travel?  Just as you sight a copse of errant willows that seem to be swaying in time with a faint whisper of rhythm on the wind, the entire world goes dark.  You ask Nuvi what&#39;s happening, and he whimpers in reply.  Before he can elaborate, a pair of poisonous bright green eyes appear out of the abyss in front of you.

&quot;You would dare to threaten the power of my mistress, goddess of this and all worlds?!&quot; a shrill masculine voice demands, rolling its &#39;R&#39;s in exaggerated primness.  The eyes are joined by a head in which they appear much too large, and then the body of an emaciated little man materializes in the air to join them.  He bobs up and down in a reclined position, carefully carefree, and studies you appraisingly.  His features are pinched and angular, and his ears come to knife-like points.  The skin not covered by his elaborate hodgepodge of earth historic court dress is bone white.  A purple fedora perched at a rakish angle caps off the less-than-intimidating ensemble.

&quot;My name is Puck, knight captain and exalted archmage of her highness Holly, Wild Goddess of All Creation!  You who would bother her, [[en guarde!-&gt;Combat_Time]]&quot;

// todo: set combat params</tw-passagedata><tw-passagedata pid="56" name="Combat_Time" tags="combat" position="136,2280" size="100,100">// todo: CSS for a pop-over combat screen?</tw-passagedata><tw-passagedata pid="57" name="Ready" tags="dev" position="1080,380" size="100,100">&lt;&lt;link [[&quot;Fight the Mighty Dragon!&quot;-&gt;Combat]]&gt;&gt;
	&lt;&lt;set $party[1] to $characters[&quot;marrah&quot;]&gt;&gt;
	&lt;&lt;set $party[2] to $characters[&quot;shimmerin&quot;]&gt;&gt;
	&lt;&lt;set $party[3] to $characters[&quot;nuvi&quot;]&gt;&gt;
	&lt;&lt;set $party[4] to $characters[&quot;mooty&quot;]&gt;&gt;
	
	&lt;&lt;set _puck to new $Character(&quot;puck&quot;,&quot;Puck&quot;)&gt;&gt;
	&lt;&lt;set $characters[&quot;puck&quot;] to _puck&gt;&gt;
	&lt;&lt;set _rapierWit to new $Incarnation(&quot;Rapier Wit&quot;)&gt;&gt;
	&lt;&lt;set _puck.abilities[&quot;rapier_wit&quot;] = _rapierWit&gt;&gt;
	&lt;&lt;set _rapierWit.targetType = _rapierWit.TargetTypesEnum.singleEnemy&gt;&gt;
	
	
	&lt;&lt;set _enemyParty to [$characters[&quot;puck&quot;]]&gt;&gt;
	&lt;&lt;set $combatArena = new $Combat($party,_enemyParty,passage())&gt;&gt;
	&lt;&lt;set $combatArena.turnOwner = &quot;player&quot;&gt;&gt;
	&lt;&lt;set $combatArena.combatLogContent = &quot;What will &quot;+ $characters[$combatArena.turnOwner].name+&quot; do?&quot;&gt;&gt;
&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="58" name="Combat" tags="dev" position="1208,381" size="100,100">&lt;&lt;include &quot;CombatLog&quot;&gt;&gt;
&lt;&lt;include &quot;PlayerCombatDisplay&quot;&gt;&gt;
&lt;&lt;include &quot;PlayerPartyStats&quot;&gt;&gt;</tw-passagedata><tw-passagedata pid="59" name="EnemyCombatDisplay" tags="dev" position="1325,274" size="100,100">&lt;div id=&quot;enemyCombatWindow&quot;&gt;
&lt;&lt;silently&gt;&gt;
&lt;&lt;set _enemy to $combatArena.enemyParty[0]&gt;&gt;
&lt;&lt;print _enemy.name+&quot; HP: &quot;+_enemy.stats.hp+&quot;/&quot;+_enemy.stats.maxHP&gt;&gt;
&lt;&lt;/silently&gt;&gt;
&lt;/div&gt;</tw-passagedata><tw-passagedata pid="60" name="CombatLog" tags="dev" position="1326,386" size="100,100">&lt;div id=&quot;combatLog&quot;&gt;
$combatArena.combatLogContent
&lt;/div&gt;</tw-passagedata><tw-passagedata pid="61" name="PlayerCombatDisplay" tags="dev" position="1289,622" size="100,100">&lt;div id=&quot;playerCombatWindow&quot;&gt;
&lt;&lt;if $combatArena.turnGroup is &quot;player&quot;&gt;&gt;
	&lt;&lt;if $combatArena.playerTurnState === $combatArena.PlayerTurnState.selectAbility&gt;&gt;
		&lt;&lt;silently&gt;&gt;
			Establish temp reference to current turn owner Character
		&lt;&lt;/silently&gt;&gt;
		&lt;&lt;set _currentTurnOwner = $combatArena.playerParty.find(function (obj) { return obj.name === $characters[$combatArena.turnOwner].name; })&gt;&gt;
		&lt;&lt;silently&gt;&gt;
			Ability listing and init usage proc block
		&lt;&lt;/silently&gt;&gt;
		&lt;&lt;for _abilityName,_ability range _currentTurnOwner.abilities&gt;&gt;
			&lt;&lt;capture _abilityName, _ability&gt;&gt;
			&lt;&lt;link [[_abilityName-&gt;Combat]]&gt;&gt;
				&lt;&lt;if _ability.targetType === _ability.TargetTypesEnum.singleEnemy&gt;&gt;
					&lt;&lt;set _testAbl += _abilityName&gt;&gt;
					&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectEnemyTarget&gt;&gt;
					&lt;&lt;set $combatArena.currentSelectedAbility = _ability&gt;&gt;
					&lt;&lt;set $combatArena.combatLogContent = &quot;Choose the fiend who will uffer the wrath of &quot;+$combatArena.currentSelectedAbility.name+&quot;!&quot;&gt;&gt;  
			&lt;&lt;elseif _ability.targetType === _ability.TargetTypesEnum.singleAlly&gt;&gt;
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectAllyTarget&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = &quot;Choose your buddy to buff!&quot;&gt;&gt;
			&lt;&lt;elseif _ability.targetType === _ability.TargetTypesEnum.allAllies&gt;&gt;
				&lt;&lt;silently&gt;&gt;\
					No need for single point targeting phase in either all enemies or all allies cases; effect() function should have the targeting built in.  Here we just need to set the turn state to displayResults and fill the log display with the ability&#39;s flavor text. 
				&lt;&lt;/silently&gt;&gt;\
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = _ability.generateFlavorText($combatArena.playerParty)&gt;&gt;
				&lt;&lt;run _ability.effect($combatArena.playerParty)&gt;&gt;
			&lt;&lt;elseif _ability.targetType === _ability.TargetTypesEnum.allEnemies&gt;&gt;
				&lt;&lt;silently&gt;&gt;\
					No need for single point targeting phase in either all enemies or all allies cases; effect() function should have the targeting built in.  Here we just need to set the turn state to displayResults and fill the log display with the ability&#39;s flavor text. 
				&lt;&lt;/silently&gt;&gt;\
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = _ability.generateFlavorText($combatArena.enemyParty)&gt;&gt;
				&lt;&lt;run _ability.effect($combatArena.enemyParty)&gt;&gt;
			&lt;&lt;/if&gt;&gt;
		  &lt;&lt;/link&gt;&gt;
		&lt;&lt;/capture&gt;&gt;
	&lt;&lt;/for&gt;&gt;
	&lt;&lt;for _incarnationName,_incarnation range _currentTurnOwner.incarnations&gt;&gt;
			&lt;&lt;capture _incarnationName, _incarnation&gt;&gt;
			&lt;&lt;link [[_incarnationName-&gt;Combat]]&gt;&gt; 
				&lt;&lt;if _incarnation.targetType === _incarnation.TargetTypesEnum.singleEnemy&gt;&gt;
					&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectEnemyTarget&gt;&gt;
					&lt;&lt;set $combatArena.currentSelectedAbility = _incarnation&gt;&gt;
					&lt;&lt;set $combatArena.combatLogContent = &quot;Choose the fiend who will uffer the wrath of &quot;+$combatArena.currentSelectedAbility.name+&quot;!&quot;&gt;&gt;  
			&lt;&lt;elseif _incarnation.targetType === _incarnation.TargetTypesEnum.singleAlly&gt;&gt;
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectAllyTarget&gt;&gt;
				&lt;&lt;set $combatArena.currentSelectedAbility = _incarnation&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = &quot;Choose your buddy to buff!&quot;&gt;&gt;
			&lt;&lt;elseif _incarnation.targetType === _incarnation.TargetTypesEnum.allAllies&gt;&gt;
				&lt;&lt;silently&gt;&gt;\
					No need for single point targeting phase in either all enemies or all allies cases; effect() function should have the targeting built in.  Here we just need to set the turn state to displayResults and fill the log display with the ability&#39;s flavor text. 
				&lt;&lt;/silently&gt;&gt;\
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = _incarnation.generateFlavorText($combatArena.playerParty)&gt;&gt;
				&lt;&lt;run _incarnation.effect($combatArena.playerParty)&gt;&gt;
			&lt;&lt;elseif _incarnation.targetType === _incarnation.TargetTypesEnum.allEnemies&gt;&gt;
				&lt;&lt;silently&gt;&gt;\
					No need for single point targeting phase in either all enemies or all allies cases; effect() function should have the targeting built in.  Here we just need to set the turn state to displayResults and fill the log display with the ability&#39;s flavor text. 
				&lt;&lt;/silently&gt;&gt;\
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = _incarnation.generateFlavorText($combatArena.enemyParty)&gt;&gt;
				&lt;&lt;run _incarnation.effect($combatArena.enemyParty)&gt;&gt;
			&lt;&lt;/if&gt;&gt;
		  &lt;&lt;/link&gt;&gt;
		&lt;&lt;/capture&gt;&gt;
	&lt;&lt;/for&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		Block where the user has already selected an abl and now needs to select its target.
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;elseif $combatArena.playerTurnState === $combatArena.PlayerTurnState.selectEnemyTarget&gt;&gt;
		&lt;&lt;for _potentialTargetIndex to 0; _potentialTargetIndex lt $combatArena.enemyParty.length; _potentialTargetIndex++&gt;&gt;
					&lt;&lt;set _target to $combatArena.enemyParty[_potentialTargetIndex]&gt;&gt;
					&lt;&lt;capture _target&gt;&gt;
					&lt;&lt;link [[_target.name-&gt;Combat]]&gt;&gt;
						&lt;&lt;set $combatArena.currentTargetCharacter = _target&gt;&gt; 
						&lt;&lt;run $combatArena.currentSelectedAbility.effect($characters[$combatArena.turnOwner],_target)&gt;&gt;
						&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
						&lt;&lt;set $combatArena.combatLogContent = $combatArena.currentSelectedAbility.generateFlavorText()&gt;&gt;
					&lt;&lt;/link&gt;&gt;
					&lt;&lt;/capture&gt;&gt;
				&lt;&lt;/for&gt;&gt;
	&lt;&lt;silently&gt;&gt;
		block that handles selecting an ally for heals/buffins
	&lt;&lt;/silently&gt;&gt;
	&lt;&lt;elseif $combatArena.playerTurnState === $combatArena.PlayerTurnState.selectAllyTarget&gt;&gt;
		&lt;&lt;for _potentialTargetIndex to 0; _potentialTargetIndex lt $combatArena.playerParty.length; _potentialTargetIndex++&gt;&gt;
					&lt;&lt;set _target to $combatArena.playerParty[_potentialTargetIndex]&gt;&gt;
					&lt;&lt;capture _target&gt;&gt;
					&lt;&lt;link _target.name&gt;&gt;
						&lt;&lt;set $combatArena.currentTargetCharacter = _target&gt;&gt; 
						&lt;&lt;run $combatArena.currentSelectedAbility.effect($characters[$combatArena.turnOwner],_target);&gt;&gt;	
						&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.displayResults&gt;&gt;
						&lt;&lt;set $combatArena.combatLogContent = $combatArena.currentSelectedAbility.generateFlavorText()&gt;&gt;
					&lt;&lt;/link&gt;&gt;
					&lt;&lt;/capture&gt;&gt;
				&lt;&lt;/for&gt;&gt;
	&lt;&lt;elseif $combatArena.playerTurnState === $combatArena.PlayerTurnState.displayResults&gt;&gt;
		&lt;&lt;link [[&quot;Press onward!&quot;-&gt;Combat]]&gt;&gt;
			&lt;&lt;silently&gt;&gt;
			If we&#39;ve hit the last char in the player party, we are ready to move on to enemy turn group.  Otherwise, we need to move on to the next player char.
			&lt;&lt;/silently&gt;&gt;
			&lt;&lt;if $characters[$combatArena.turnOwner].name is $combatArena.playerParty[$combatArena.playerParty.length-1].name&gt;&gt;
				&lt;&lt;set $combatArena.turnGroup = &quot;enemy&quot;&gt;&gt;
				&lt;&lt;silently&gt;&gt;
				TODO: in order to process an enemy party with more than one monster, we&#39;d need something closer to the player party proc in enemy side.  For now this shortcut will work.
				&lt;&lt;/silently&gt;&gt;
				&lt;&lt;run $combatArena.enemyParty[0].runAI()&gt;&gt;
			&lt;&lt;else&gt;&gt;
				&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectAbility&gt;&gt;
				&lt;&lt;set $combatArena.turnOwner = $combatArena.playerParty[$findCurrentPlayerCharacterIndex()+1].id&gt;&gt;
				&lt;&lt;set $combatArena.combatLogContent = &quot;What will &quot;+$characters[$combatArena.turnOwner].name+&quot; do?&quot;&gt;&gt;
			&lt;&lt;/if&gt;&gt;
		&lt;&lt;/link&gt;&gt;
	&lt;&lt;else&gt;&gt;
		&lt;&lt;print &quot;state &quot;+$combatArena.playerTurnState+&quot; is unknown&quot;&gt;&gt;
	&lt;&lt;/if&gt;&gt;
&lt;&lt;elseif $combatArena.turnGroup is &quot;enemy&quot;&gt;&gt;
  &lt;&lt;link [[&quot;Rally!&quot;-&gt;Combat]]&gt;&gt;
  	&lt;&lt;if $combatArena.processRoundBottom()&gt;&gt;
  		&lt;&lt;set $combatArena.turnGroup = &quot;player&quot;&gt;&gt;
		&lt;&lt;set $combatArena.turnOwner = &quot;player&quot;&gt;&gt;
		&lt;&lt;set $combatArena.playerTurnState = $combatArena.PlayerTurnState.selectAbility&gt;&gt;
		&lt;&lt;set $combatArena.combatLogContent = &quot;What will &quot;+$characters[$combatArena.turnOwner].name+&quot; do?&quot;&gt;&gt;
		&lt;&lt;run $combatArena.processRoundTop()&gt;&gt;
	&lt;&lt;else&gt;&gt;
		&lt;&lt;set $combatArena.turnGroup = &quot;system&quot;&gt;&gt;
		&lt;&lt;silently&gt;&gt;
		Update the combat log text with end of combat results
		&lt;&lt;/silently&gt;&gt;
		&lt;&lt;if $combatArena.combatResult === $combatArena.CombatResultEnum.playerVictory&gt;&gt;
			&lt;&lt;set $combatArena.combatLogContent = &quot;The party has triumphed over evil once more!&quot;&gt;&gt;
		&lt;&lt;else&gt;&gt;
			&lt;&lt;set $combatArena.combatLogContent = &quot;It is a sad thing that your adventures have ended here -- in the next months, with nothing to meaningfully oppose them, the godlings will grow and grow out of control, and soon swallow up (intentionally or not) the gentle land of Fuzziolump.  Your deaths mark the end of all hopes and dreams!&quot;&gt;&gt;
		&lt;&lt;/if&gt;&gt;
	&lt;&lt;/if&gt;&gt;
  &lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt;
	&lt;&lt;print &quot;turngroup is wrong&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;/div&gt;</tw-passagedata><tw-passagedata pid="62" name="CombatWin" tags="dev" position="1460,324" size="100,100">You Win -- dragon thoroughly punched and sworded!</tw-passagedata><tw-passagedata pid="63" name="CombatLose" tags="dev" position="1460,451" size="100,100">You lose -- why were you fighting a dragon, anyway?</tw-passagedata><tw-passagedata pid="64" name="twine notes" tags="dev" position="1636,14" size="100,100">The following:
&lt;replace &quot;#combatLog&quot;&gt;
	&quot;What will $characters[$combatArena.turnOwner].name do?&quot;
&lt;/replace&gt;
does not work in CombatPlayer passage since combatLog DIV id only exists in CombatLog passage.  Evidently CSS selectors aren&#39;t available between passages?

// Readt portion of turn based combat tutorial
&lt;&lt;link &quot;Fight the Mighty Dragon!&quot;&gt;&gt;
&lt;&lt;set $ehp to 200&gt;&gt;
&lt;&lt;set $mhp to 200&gt;&gt;
&lt;&lt;set $ename to &quot;Dragon&quot;&gt;&gt;
&lt;&lt;set $combatTurnState to $combatTurnState_player&gt;&gt;
&lt;&lt;set $hp to 100&gt;&gt;
&lt;&lt;set $eatk to 15&gt;&gt;
&lt;&lt;set $eatkname to &quot;Breath of Fire&quot;&gt;&gt;
&lt;&lt;/link&gt;&gt;

// generating links within a lopo
&lt;&lt;for _i to 0; _i lt 10; _i++&gt;&gt;
	&lt;&lt;link &quot;test _i&quot;&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _partyMemberIndex,_partyMember range $party&gt;&gt;
	&lt;&lt;print &quot;party consists of _partyMember.name&quot;&gt;&gt;
&lt;&lt;/for&gt;&gt;

// Using capture to localize a temporary loop variable for use within a linkappend
&lt;&lt;set _what to [
	&quot;a crab rangoon&quot;,
	&quot;a gaggle of geese&quot;,
	&quot;an aardvark&quot;,
	&quot;the world&#39;s smallest violin&quot;
]&gt;&gt;
&lt;&lt;for _i to 0; _i lt _what.length; _i++&gt;&gt;
	&lt;&lt;capture _i&gt;&gt;
		I spy with my little &lt;&lt;linkappend &quot;eye&quot; t8n&gt;&gt;, _what[_i]&lt;&lt;/linkappend&gt;&gt;.
	&lt;&lt;/capture&gt;&gt;
&lt;&lt;/for&gt;&gt;

// Capturing several variables at once
&lt;&lt;capture $aStoryVar, $anotherStoryVar, _aTempVar&gt;&gt;  &lt;&lt;/capture&gt;&gt;</tw-passagedata><tw-passagedata pid="65" name="PlayerPartyStats" tags="combat" position="1324,495" size="100,100">&lt;table style=&quot;width:100%&quot;&gt;
  &lt;tr&gt;
  	&lt;&lt;for  _playerCharIndex to 0; _playerCharIndex lt $combatArena.playerParty.length; _playerCharIndex++&gt;&gt;
		&lt;&lt;set _playerChar to $combatArena.playerParty[_playerCharIndex]&gt;&gt;
		&lt;th&gt;&lt;u&gt;_playerChar.name&lt;/u&gt;&lt;/th&gt;
    &lt;&lt;/for&gt;&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
  	&lt;&lt;for  _playerCharIndex to 0; _playerCharIndex lt $combatArena.playerParty.length; _playerCharIndex++&gt;&gt;
		&lt;&lt;set _playerChar to $combatArena.playerParty[_playerCharIndex]&gt;&gt;
    	&lt;&lt;set _playerCharStatReadout to &quot;HP : &quot;+_playerChar.stats.hp+&quot;/&quot;+_playerChar.stats.maxHP&gt;&gt;
		&lt;th&gt;_playerCharStatReadout&lt;/th&gt;
    &lt;&lt;/for&gt;&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
  	&lt;&lt;for  _playerCharIndex to 0; _playerCharIndex lt $combatArena.playerParty.length; _playerCharIndex++&gt;&gt;
		&lt;&lt;set _playerChar to $combatArena.playerParty[_playerCharIndex]&gt;&gt;
    	&lt;&lt;set _playerCharStatReadout to &quot;MP : &quot;+_playerChar.stats.mp+&quot;/&quot;+_playerChar.stats.maxMP&gt;&gt;
		&lt;th&gt;_playerCharStatReadout&lt;/th&gt;
    &lt;&lt;/for&gt;&gt;
  &lt;/tr&gt;
&lt;/table&gt;</tw-passagedata><tw-passagedata pid="66" name="Bush_Warren_Council_Exit" tags="conversation" position="12,1924" size="100,100">The council of animals files out through the small door beyond the table, &lt;&lt;if $godling_strat === $godling_strat_diplomancy&gt;&gt;Mooty offering a cheerful wave before ducking down to follow the others.&lt;&lt;elseif $godling_strat === $godling_strat_surgical_systems&gt;&gt;Dr. Beakman inclining his enormous multi-hued beak toward you in a gesture of respect.&lt;&lt;elseif $godling_strat === $godling_strat_viral_violence&gt;&gt;Marrah turning briefly for one last longing gaze.&lt;&lt;/if&gt;&gt;  When they&#39;re gone, the faeries serving as illumination abruptly vanish and the room is plunged into inky darkness.  A harsh grinding sound fills the void and a moment later a shaft of golden light reveals the badgers opening the skylight far above.  Once you can clearly see Nuvi&#39;s &lt;&lt;if $godling_strat === $godling_strat_viral_violence&gt;&gt;worried whiskery face, positioned somewhat further away from you than usual,&lt;&lt;elseif $godling_strat === $godling_strat_surgical_systems&gt;&gt;apprehensive whiskery face, fuzzy brow furrowed with concern and the effort of analyzing the complex proposal you just made,&lt;&lt;elseif $godling_strat === $godling_strat_diplomancy&gt;&gt;grinning sun-bathed whiskery face, hovering close enough to tickle your cheeks (which you suspect may be his fond intent),&lt;&lt;/if&gt;&gt; the badgers proceed to roll back the boulder blocking the &lt;&lt;if $godling_strat === $godling_strat_viral_violence&gt;&gt;[[main entry tunnel-&gt;Encounter_Puck_Viral_Violence]]&lt;&lt;elseif $godling_strat === $godling_strat_surgical_systems&gt;&gt;[[main entry tunnel-&gt;Encounter_Puck_Surgical_Systems]]&lt;&lt;elseif $godling_strat === $godling_strat_diplomancy&gt;&gt;[[main entry tunnel-&gt;Encounter_Puck_Diplomancy]]&lt;&lt;/if&gt;&gt;.</tw-passagedata></tw-storydata>